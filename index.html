<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Smart Billing App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    
        /* Animazioni */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Custom colors */
        .card-income { border-left: 4px solid #10b981; }
        .card-expense { border-left: 4px solid #ef4444; }
        .card-balance { border-left: 4px solid #3b82f6; }
        .card-budget { border-left: 4px solid #8b5cf6; }
        
        .btn-income { background-color: #10b981; }
        .btn-income:hover { background-color: #059669; }
        
        .btn-expense { background-color: #ef4444; }
        .btn-expense:hover { background-color: #dc2626; }
        
        .btn-budget { background-color: #8b5cf6; }
        .btn-budget:hover { background-color: #7c3aed; }
        
        .btn-neutral { background-color: #6b7280; }
        .btn-neutral:hover { background-color: #4b5563; }
        
        /* Screen transitions */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        
        /* Progress bars */
        .progress-bar { transition: width 0.5s ease-in-out; }
        
        /* Shopping optimization */
        .optimization-card {
            border: 2px solid;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .optimization-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        /* Toast animation */
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        
        /* Stile per categoria suggerita */
        .suggested {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1) !important;
            animation: pulse 1s;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* Tooltip per suggerimento */
        .suggestion-badge {
            background-color: #3b82f6;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        /* Loader per ricerca negozi */
        .store-loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- APP CONTAINER -->
    <div id="app" class="max-w-4xl mx-auto p-4">
        
        <!-- ==================== SCREEN 1: DASHBOARD ==================== -->
<div id="screen-dashboard" class="screen active">
    <!-- Header -->
    <header class="mb-8">
        <div class="flex justify-between items-center mb-2">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-wallet text-green-500 mr-2"></i>Smart Billing
                </h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Bottone Profilo -->
                <button onclick="showScreen('profile')" 
                        class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300">
                    <i class="fas fa-user text-gray-600"></i>
                </button>
            </div>
        </div>
        <p class="text-gray-500 mt-2" data-translate="app-subtitle">Gestisci le tue finanze in modo intelligente</p>
    </header>
            
            <!-- Alert -->
            <div id="budgetAlert" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 hidden">
            <div class="flex">
                <i class="fas fa-exclamation-triangle text-yellow-500 mt-1 mr-3"></i>
                <div>
                    <p class="font-semibold" data-translate="budget-exceeds-income">Budget superiore alle entrate</p>
                    <p class="text-sm text-yellow-700" data-translate="review-budget">Rivedi il budget o aggiungi entrate</p>
                </div>
            </div>
        </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <!-- Income Card -->
<div class="card-income bg-white rounded-xl shadow p-5">
    <div class="flex justify-between items-start mb-3">
        <div>
            <p class="text-gray-500 text-sm uppercase tracking-wider" data-translate="incomes">Entrate</p>
            <p class="text-2xl font-bold text-gray-800 mt-1" id="dashboard-income">‚Ç¨0,00</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-money-bill-wave text-green-500 text-xl"></i>
        </div>
    </div>
    <button onclick="showScreen('add-income')" 
            class="w-full py-2 btn-income text-white rounded-lg font-semibold mt-2 flex items-center justify-center gap-2">
        <i class="fas fa-plus"></i> <span data-translate="add-income">Aggiungi Entrata</span>
    </button>
</div>

<!-- Expenses Card -->
<div class="card-expense bg-white rounded-xl shadow p-5">
    <div class="flex justify-between items-start mb-3">
        <div>
            <p class="text-gray-500 text-sm uppercase tracking-wider" data-translate="expenses">Uscite</p>
            <p class="text-2xl font-bold text-gray-800 mt-1" id="dashboard-expenses">‚Ç¨0,00</p>
        </div>
        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
            <i class="fas fa-shopping-cart text-red-500 text-xl"></i>
        </div>
    </div>
    <button onclick="askExpenseType()" 
            class="w-full py-2 btn-expense text-white rounded-lg font-semibold mt-2 flex items-center justify-center gap-2">
        <i class="fas fa-plus"></i> <span data-translate="add-expense">Aggiungi Uscita</span>
    </button>
</div>
                
                <!-- Balance Card -->
                <div class="card-balance bg-white rounded-xl shadow p-5">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="text-gray-500 text-sm uppercase tracking-wider" data-translate="balance">Saldo</p>  <!-- ‚úÖ AGGIUNTO data-translate -->
                        <p class="text-2xl font-bold text-gray-800 mt-1" id="dashboard-balance">‚Ç¨0,00</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-line text-blue-500 text-xl"></i>
                    </div>
                </div>
                <div class="text-sm text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i> 
                    <span data-translate="income-minus-expenses">Entrate - Uscite</span>
                </div>
            </div>
                
                <!-- Budget Card -->
                <div class="card-budget bg-white rounded-xl shadow p-5">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-gray-500 text-sm uppercase tracking-wider">Budget</p>
                            <p class="text-2xl font-bold text-gray-800 mt-1" id="dashboard-budget">‚Ç¨0,00</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-piggy-bank text-purple-500 text-xl"></i>
                        </div>
                    </div>
                    <button onclick="showScreen('budget')" 
                            class="w-full py-2 btn-budget text-white rounded-lg font-semibold mt-2 flex items-center justify-center gap-2">
                            <i class="fas fa-cog"></i> <span data-translate="manage-budget">Gestisci Budget</span>
</button>
                </div>
            </div>
            
            <!-- Recent Transactions -->
            <div class="bg-white rounded-xl shadow p-5 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-history mr-2"></i>
                        <span data-translate="recent-transactions">Ultime Transazioni</span>
                    </h2>
                    <button onclick="showScreen('transactions')" 
        class="text-sm text-blue-500 hover:text-blue-700">
    <span data-translate="view-all">Vedi tutte</span> ‚Üí
</button>
                </div>
                
                <div id="recent-transactions" class="space-y-3">
                    <!-- Filled by JavaScript -->
                </div>
                
                <div class="mt-4 pt-4 border-t">
                <button onclick="askTransactionType()" 
                class="w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 rounded-lg hover:border-green-400 hover:text-green-500 transition">
            <i class="fas fa-plus mr-2"></i>
            <span data-translate="add-new-transaction">Aggiungi Nuova Transazione</span>
        </button>
                </div>
            </div>
            
            <!-- Quick Actions -->
<div class="grid grid-cols-2 gap-4">
    <button onclick="showScreen('shopping')" 
            class="bg-white rounded-xl shadow p-4 flex items-center gap-3 hover:shadow-md transition">
        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-shopping-basket text-green-500"></i>
        </div>
        <div class="text-left">
            <p class="font-semibold" data-translate="shopping">Lista Spesa</p>
            <p class="text-sm text-gray-500" id="shopping-count">0 <span data-translate="items">articoli</span></p>
        </div>
    </button>
    
    <button onclick="showScreen('reports')" 
            class="bg-white rounded-xl shadow p-4 flex items-center gap-3 hover:shadow-md transition">
        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
            <i class="fas fa-chart-pie text-purple-500"></i>
        </div>
        <div class="text-left">
            <p class="font-semibold" data-translate="reports">Report e Grafici</p>
            <p class="text-sm text-gray-500" data-translate="view-stats">Visualizza statistiche</p>
        </div>
    </button>
</div>
        </div>
        
        <!-- ==================== SCREEN 2: AGGIUNGI ENTRATA ==================== -->
        <div id="screen-add-income" class="screen">
            <div class="mb-6">
                <button onclick="showScreen('dashboard')" 
                class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left"></i> <span data-translate="back-to-dashboard">Torna alla Dashboard</span>
        </button>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2">
            <i class="fas fa-money-bill-wave text-green-500 mr-2"></i><span data-translate="new-income">Nuova Entrata</span>
        </h2>
        <p class="text-gray-500 mb-6" data-translate="register-income">Registra una nuova entrata</p>

                
                <div class="space-y-4">
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="description">Descrizione *</label>
                    <input type="text" id="income-desc" 
       class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
       placeholder="Stipendio, Bonus, Vendita..."
       data-translate-placeholder="income-placeholder"
       oninput="suggestCategoryOnInput('income')">
                    <!-- üî• AGGIUNGI QUESTO -->
                    <p id="income-category-suggestion-hint" class="text-xs text-blue-600 mt-1 hidden">
                    <i class="fas fa-lightbulb"></i> <span data-translate="suggestion">Suggerimento</span>: <span id="income-suggested-category-text"></span>
                </p>
                    </div>
                    
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="amount-with-currency">Importo (‚Ç¨) *</label>
                        <input type="number" step="0.01" id="income-amount" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                               placeholder="0,00">
                    </div>
                    
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="category">Categoria</label>
                    <select id="income-category" 
                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option value="Stipendio" data-translate="salary">Stipendio</option>
                    <option value="Bonus" data-translate="bonus">Bonus</option>
                    <option value="Investimenti" data-translate="investments">Investimenti</option>
                    <option value="Rendite" data-translate="rental-income">Rendite</option>
                    <option value="Altro" data-translate="other">Altro</option>
                </select>
                    </div>
                    
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="date">Data</label>

                        <input type="date" id="income-date" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                               value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                    <button onclick="addIncome()" 
                    class="flex-1 py-3 btn-income text-white rounded-lg font-semibold">
                <i class="fas fa-save mr-2"></i><span data-translate="save-income">Salva Entrata</span>
            </button>
            <button onclick="showScreen('dashboard')" 
            class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
        <span data-translate="cancel">Annulla</span>
    </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ==================== SCREEN 3: SCELTA TIPO USCITA ==================== -->
        <div id="screen-expense-choice" class="screen">
            <div class="mb-6">
                <button onclick="showScreen('dashboard')" 
        class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
    <i class="fas fa-arrow-left"></i> <span data-translate="back-to-dashboard">Torna alla Dashboard</span>
</button>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-shopping-cart text-red-500 mr-2"></i><span data-translate="add-expense">Aggiungi Uscita</span>
                </h2>
                <p class="text-gray-500 mb-8" data-translate="what-to-add">Cosa vuoi aggiungere?</p>
                
                <div class="space-y-4">
                    <button onclick="showScreen('shopping')" 
        class="w-full p-5 border-2 border-dashed border-green-300 rounded-xl text-left hover:border-green-500 hover:bg-green-50 transition group">
    <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200">
            <i class="fas fa-shopping-basket text-green-500 text-xl"></i>
        </div>
        <div>
            <p class="font-bold text-gray-800" data-translate="shopping-list">Lista della Spesa</p>
            <p class="text-sm text-gray-500" data-translate="add-shopping-items">Aggiungi articoli da acquistare</p>
        </div>
        <div class="ml-auto">
            <i class="fas fa-chevron-right text-gray-400"></i>
        </div>
    </div>
</button>

<button onclick="showScreen('add-expense')" 
        class="w-full p-5 border-2 border-dashed border-red-300 rounded-xl text-left hover:border-red-500 hover:bg-red-50 transition group">
    <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center group-hover:bg-red-200">
            <i class="fas fa-receipt text-red-500 text-xl"></i>
        </div>
        <div>
            <p class="font-bold text-gray-800" data-translate="generic-expense">Uscita Generica</p>
            <p class="text-sm text-gray-500" data-translate="bills-restaurant">Bollette, ristorante, carburante...</p>
        </div>
        <div class="ml-auto">
            <i class="fas fa-chevron-right text-gray-400"></i>
        </div>
    </div>
</button>
                </div>
            </div>
        </div>
        
        <!-- ==================== SCREEN 4: AGGIUNGI USCITA GENERICA ==================== -->
        <div id="screen-add-expense" class="screen">
            <div class="mb-6">
                <button onclick="showScreen('expense-choice')" 
        class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
    <i class="fas fa-arrow-left"></i> <span data-translate="back-to-choice">Torna alla scelta</span>
</button>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-receipt text-red-500 mr-2"></i><span data-translate="new-expense">Nuova Uscita</span>
                </h2>
                <p class="text-gray-500 mb-6" data-translate="register-expense">Registra una nuova spesa</p>
                
                <div class="space-y-4">
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="description">Descrizione *</label>

                        <input type="text" id="expense-desc" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                               placeholder="Cena, Benzina, Bolletta..."
                                oninput="suggestCategoryOnInput('expense')">
                                <p id="expense-category-suggestion-hint" class="text-xs text-blue-600 mt-1 hidden">
                                <i class="fas fa-lightbulb"></i> <span data-translate="suggestion">Suggerimento</span>: <span id="expense-suggested-category-text"></span>
                            </p>
                    </div>
                    
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="amount-with-currency">Importo (‚Ç¨) *</label>
                        <input type="number" step="0.01" id="expense-amount" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                               placeholder="0,00">
                    </div>
                    
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="category">Categoria</label>
                        <select id="expense-category" 
        class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
    <option value="Alimentari" data-translate="food">Alimentari</option>
    <option value="Bollette" data-translate="utilities">Bollette</option>
    <option value="Mutuo" data-translate="mortgage">Mutuo</option>  <!-- üî¥ NUOVO -->
    <option value="Trasporti" data-translate="transport">Trasporti</option>
    <option value="Svago" data-translate="entertainment">Svago</option>
    <option value="Salute" data-translate="health">Salute</option>
    <option value="Shopping" data-translate="shopping">Shopping</option>
    <option value="Affitto" data-translate="rent">Affitto</option>
    <option value="Altro" data-translate="other">Altro</option>
</select>
                    </div>
                    
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="date">Data</label>

                        <input type="date" id="expense-date" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
                               value="${new Date().toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="flex gap-3 pt-4">
                    <button onclick="addExpense()" 
                            class="flex-1 py-3 btn-expense text-white rounded-lg font-semibold">
                        <i class="fas fa-save mr-2"></i><span data-translate="save-expense">Salva Uscita</span>
                    </button>
                    <button onclick="showScreen('expense-choice')" 
        class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
    <i class="fas fa-arrow-left"></i> <span data-translate="back-to-choice">Torna alla scelta</span>
</button>
                </div>
                </div>
            </div>
        </div>
        
                <!-- ==================== SCREEN 5: LISTA SPESA ==================== -->
                <div id="screen-shopping" class="screen">
                <div class="mb-6">
                    <button onclick="showScreen('dashboard')" 
        class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
    <i class="fas fa-arrow-left"></i> <span data-translate="back-to-dashboard">Torna alla Dashboard</span>
</button>
                </div>
                
                <div class="bg-white rounded-xl shadow p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-shopping-basket text-green-500 mr-2"></i><span data-translate="shopping-list">Lista della Spesa</span>
                    </h2>
                    
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="shopping-item" 
       class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
       data-translate-placeholder="shopping-placeholder"
       placeholder="Cosa devi comprare?" 
       onkeypress="if(event.key === 'Enter') addShoppingItem()">
                        <button onclick="addShoppingItem()" 
                                class="px-5 btn-income text-white rounded-lg font-semibold">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
    
                    <!-- BOTTONE REGISTRA ACQUISTI (SENZA FOTOCAMERA) -->
<div class="mb-4">
    <button onclick="showRegisterPurchases()" 
            class="w-full py-3 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600 flex items-center justify-center gap-2">
        <i class="fas fa-check-circle mr-2"></i> <span data-translate="register-checked">Registra acquisti spuntati</span>
    </button>
</div>
                    
                    <div id="shopping-list-items" class="space-y-3">
                        <!-- Filled by JavaScript -->
                    </div>
                    
                    <!-- Optimization Options -->
                    <div id="optimization-section" class="mt-8 pt-6 border-t">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-chart-line text-purple-500 mr-2"></i>Ottimizza Acquisti
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <button onclick="optimizeLowestPrice()" 
                                    class="optimization-card border-green-300 bg-green-50 p-4 text-center">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-euro-sign text-green-600"></i>
                                </div>
                                <p class="font-bold text-gray-800 mb-1" data-translate="lowest-price">Prezzo pi√π basso</p>
                                <p class="text-sm text-gray-600" data-translate="min-total">Spesa minima totale</p>
                                <p class="text-xs text-green-600 mt-2" id="lowest-price-total">‚Ç¨0,00 / 0 negozi</p>
                            </button>
                            
                            <button onclick="optimizeFewestStores()" 
                                    class="optimization-card border-blue-300 bg-blue-50 p-4 text-center">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-store text-blue-600"></i>
                                </div>
                                <p class="font-bold text-gray-800 mb-1" data-translate="fewest-stores">Meno negozi</p>
                                <p class="text-sm text-gray-600" data-translate="fewer-stores">Visita meno punti vendita</p>
                                <p class="text-xs text-blue-600 mt-2" id="fewest-stores-count">‚Ç¨0,00 / 0 negozi</p>
                            </button>
                            
                            <button onclick="optimizeBalanced()" 
                                    class="optimization-card border-purple-300 bg-purple-50 p-4 text-center">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                    <i class="fas fa-balance-scale text-purple-600"></i>
                                </div>
                                <p class="font-bold text-gray-800 mb-1" data-translate="optimized">Ottimizzato</p>
                                <p class="text-sm text-gray-600" data-translate="price-stores-balanced">Prezzo e negozi bilanciati</p>
                                <p class="text-xs text-purple-600 mt-2" id="balanced-optimization">‚Ç¨0,00 / 0 negozi</p>
                            </button>
                        </div>
                        
                        <!-- Optimization Results -->
                        <div id="optimization-results" class="hidden">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-semibold text-gray-800" id="optimization-title" data-translate="optimization-result">Risultato Ottimizzazione</h4>
                                    <button onclick="closeOptimizationResults()" class="text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="text-center p-3 bg-white rounded-lg">
                                        <p class="text-sm text-gray-500" data-translate="total-price">Prezzo Totale</p>
                                        <p class="text-xl font-bold text-green-600" id="opt-total-price">‚Ç¨0,00</p>
                                    </div>
                                    <div class="text-center p-3 bg-white rounded-lg">
                                        <p class="text-sm text-gray-500" data-translate="stores">Negozi</p>
                                        <p class="text-xl font-bold text-blue-600" id="opt-store-count">0</p>
                                    </div>
                                </div>
                                <div id="optimization-details" class="space-y-3">
                                    <!-- Filled dynamically -->
                                </div>
                                <button onclick="applyOptimization()" 
                                        class="w-full mt-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600"
                                        data-translate="apply-solution">
                                    <i class="fas fa-check mr-2"></i>Applica questa soluzione
                                </button>
                            </div>
                        </div>
                    </div>
                </div> <!-- CHIUDE IL DIV PRINCIPALE (bg-white) -->
                
                <!-- Nearby Stores -->
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-store text-blue-500 mr-2"></i>
                        <span id="nearby-stores-title">Negozi Vicini</span>
                    </h2>
    
                    <!-- Selettore posizione -->
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm font-medium text-gray-700 mb-3" id="search-location-text">Cerca negozi vicino a:</p>
                        <div class="flex flex-wrap gap-2">
                            <button id="location-home-btn" onclick="setLocation('home')" 
                                    class="flex-1 py-2 px-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 flex items-center justify-center gap-2">
                                <i class="fas fa-home"></i> <span id="home-text">Casa</span>
                            </button>
                            <button id="location-work-btn" onclick="setLocation('work')" 
                                    class="flex-1 py-2 px-3 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 flex items-center justify-center gap-2">
                                <i class="fas fa-briefcase"></i> <span id="work-text">Lavoro</span>
                            </button>
                            <button id="location-current-btn" onclick="setLocation('current')" 
                                    class="flex-1 py-2 px-3 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 flex items-center justify-center gap-2">
                                <i class="fas fa-location-dot"></i> <span id="current-location-text-btn">Posizione attuale</span>
                            </button>
                        </div>
                        <div id="selected-location-display" class="mt-2 text-sm text-gray-600">
                            <i class="fas fa-map-pin mr-1"></i> <span id="searching-near-text">Cerco negozi vicino a:</span> 
                            <span id="current-location-text" class="font-semibold">Casa</span>
                        </div>
                    </div>
    
                    <div id="nearby-stores" class="space-y-3">
                        <p class="text-gray-500 text-center py-4" id="set-address-message-text">
                            Imposta il tuo indirizzo nel profilo per trovare negozi
                        </p>
                    </div>
    
                    <button id="search-stores-btn" onclick="findNearbyStores()" 
                            class="w-full mt-4 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 flex items-center justify-center gap-2">
                        <i class="fas fa-search mr-2"></i><span id="find-nearby-stores-text">Cerca Negozi Vicini</span>
                    </button>
                </div> <!-- CHIUDE IL BLOCCO NEGOZI -->
    
                <!-- SCRIPT PER FORZARE LE TRADUZIONI -->
                <script>
                (function() {
                    function translateNearbyStores() {
                        try {
                            const profile = JSON.parse(localStorage.getItem('smart_billing_profile_v2') || '{}');
                            const lang = profile.language || 'it';
                            
                            const translations = {
                                'it': {
                                    'nearby-stores': 'Negozi Vicini',
                                    'search-location': 'Cerca negozi vicino a:',
                                    'home': 'Casa',
                                    'work': 'Lavoro',
                                    'current-location': 'Posizione attuale',
                                    'searching-near': 'Cerco negozi vicino a:',
                                    'set-address-message': 'Imposta il tuo indirizzo nel profilo per trovare negozi',
                                    'find-nearby-stores': 'Cerca Negozi Vicini'
                                },
                                'en': {
                                    'nearby-stores': 'Nearby Stores',
                                    'search-location': 'Search stores near:',
                                    'home': 'Home',
                                    'work': 'Work',
                                    'current-location': 'Current location',
                                    'searching-near': 'Searching stores near:',
                                    'set-address-message': 'Set your address in the profile to find stores',
                                    'find-nearby-stores': 'Find Nearby Stores'
                                },
                                'es': {
                                    'nearby-stores': 'Tiendas Cercanas',
                                    'search-location': 'Buscar tiendas cerca de:',
                                    'home': 'Casa',
                                    'work': 'Trabajo',
                                    'current-location': 'Ubicaci√≥n actual',
                                    'searching-near': 'Buscando tiendas cerca de:',
                                    'set-address-message': 'Configura tu direcci√≥n en el perfil para encontrar tiendas',
                                    'find-nearby-stores': 'Buscar Tiendas Cercanas'
                                },
                                'fr': {
                                    'nearby-stores': 'Magasins Proches',
                                    'search-location': 'Chercher des magasins pr√®s de:',
                                    'home': 'Domicile',
                                    'work': 'Travail',
                                    'current-location': 'Position actuelle',
                                    'searching-near': 'Recherche de magasins pr√®s de:',
                                    'set-address-message': 'Configurez votre adresse dans le profil pour trouver des magasins',
                                    'find-nearby-stores': 'Trouver des Magasins Proches'
                                },
                                'de': {
                                    'nearby-stores': 'Gesch√§fte in der N√§he',
                                    'search-location': 'Gesch√§fte suchen in der N√§he von:',
                                    'home': 'Zuhause',
                                    'work': 'Arbeit',
                                    'current-location': 'Aktueller Standort',
                                    'searching-near': 'Suche Gesch√§fte in der N√§he von:',
                                    'set-address-message': 'Legen Sie Ihre Adresse im Profil fest, um Gesch√§fte zu finden',
                                    'find-nearby-stores': 'Gesch√§fte in der N√§he finden'
                                },
                                'ro': {
                                    'nearby-stores': 'Magazine Apropiate',
                                    'search-location': 'CautƒÉ magazine l√¢ngƒÉ:',
                                    'home': 'AcasƒÉ',
                                    'work': 'Serviciu',
                                    'current-location': 'Loca»õia curentƒÉ',
                                    'searching-near': 'Caut magazine l√¢ngƒÉ:',
                                    'set-address-message': 'SeteazƒÉ adresa √Æn profil pentru a gƒÉsi magazine',
                                    'find-nearby-stores': 'GƒÉse»ôte Magazine Apropiate'
                                }
                            };
                            
                            const t = translations[lang] || translations['it'];
                            
                            document.getElementById('nearby-stores-title').textContent = t['nearby-stores'];
                            document.getElementById('search-location-text').textContent = t['search-location'];
                            document.getElementById('home-text').textContent = t['home'];
                            document.getElementById('work-text').textContent = t['work'];
                            document.getElementById('current-location-text-btn').textContent = t['current-location'];
                            document.getElementById('searching-near-text').textContent = t['searching-near'];
                            document.getElementById('set-address-message-text').textContent = t['set-address-message'];
                            document.getElementById('find-nearby-stores-text').textContent = t['find-nearby-stores'];
                            
                            console.log('üåê Schermata negozi tradotta in:', lang);
                        } catch (e) {
                            console.log('Errore traduzione negozi:', e);
                        }
                    }
    
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', translateNearbyStores);
                    } else {
                        translateNearbyStores();
                    }
                })();
                </script>
    
            </div> <!-- CHIUDE screen-shopping -->
    
            <!-- ==================== SCREEN 10: REGISTRA ACQUISTI ==================== -->
<div id="screen-register-purchases" class="screen">
<div class="mb-6">
    <button onclick="showScreen('shopping')" 
            class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left"></i> <span data-translate="back-to-shopping-list">Torna alla Lista</span>
        </button>
</div>

<div class="bg-white rounded-xl shadow p-6">
    <h2 class="text-xl font-bold text-gray-800 mb-2">
        <i class="fas fa-receipt text-green-500 mr-2"></i><span data-translate="register-purchases">Registra Acquisti</span>
    </h2>
    <p class="text-gray-500 mb-6" data-translate="modify-prices">Modifica prezzi e conferma gli acquisti</p>
    
    <!-- BOTTONE SCANSIONE SCONTRINO -->
    <div class="mb-6">
        <button onclick="scanReceipt()" 
                class="w-full py-4 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 flex items-center justify-center gap-3 text-lg">
            <i class="fas fa-camera fa-lg"></i> 
            <span data-translate="scan-receipt">Scansiona scontrino con fotocamera</span>
        </button>
        <p class="text-xs text-gray-500 text-center mt-2" data-translate="camera-hint">
            Usa la fotocamera per leggere automaticamente prezzi e prodotti
        </p>
    </div>
    
    <div id="purchases-to-register" class="space-y-4 mb-6">
        <!-- Verr√† popolato con gli articoli spuntati -->
    </div>
    
    <div class="flex gap-3 pt-4">
        <button onclick="registerAllPurchases()" 
        class="flex-1 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">
    <i class="fas fa-check mr-2"></i> <span data-translate="confirm-purchases">Conferma Acquisti</span>
</button>
<button onclick="showScreen('shopping')" 
        class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
    <span data-translate="cancel">Annulla</span>
</button>
    </div>
</div>
</div>
            
            <!-- ==================== SCREEN 6: GESTIONE BUDGET ==================== -->
        <div id="screen-budget" class="screen">
            <div class="mb-6">
                <button onclick="showScreen('dashboard')" 
        class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
    <i class="fas fa-arrow-left"></i> <span data-translate="back-to-dashboard">Torna alla Dashboard</span>
</button>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-piggy-bank text-purple-500 mr-2"></i><span data-translate="budget-management">Gestione Budget</span>
                </h2>
                <p class="text-gray-500 mb-6" data-translate="set-monthly-budgets">Imposta i budget mensili per categoria</p>
                
                <div id="budget-items" class="space-y-4 mb-6">
                    <!-- Filled by JavaScript -->
                </div>
                
                <div class="pt-4 border-t">
                    <button onclick="showScreen('dashboard')" 
        class="w-full py-3 btn-neutral text-white rounded-lg font-semibold">
    <i class="fas fa-check mr-2"></i> <span data-translate="confirm-budget">Conferma Budget</span>
</button>
                </div>
            </div>
        </div>
        
        <!-- ==================== SCREEN 7: PROFILO ==================== -->
        <div id="screen-profile" class="screen">
            <div class="mb-6">
                <button onclick="showScreen('dashboard')" 
        class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
    <i class="fas fa-arrow-left"></i> <span data-translate="back-to-dashboard">Torna alla Dashboard</span>
</button>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-user text-blue-500 mr-2"></i><span data-translate="your-profile">Il Tuo Profilo</span>
                </h2>
                <p class="text-gray-500 mb-6" data-translate="configure-data">Configura i tuoi dati per un'esperienza personalizzata</p>
                
                <div class="space-y-8">
                    <!-- Sezione Dati Personali -->
                    <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-id-card mr-2"></i><span data-translate="personal-data">Dati Personali</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="first-name">Nome</label>
                            <input type="text" id="profile-firstname" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Mario">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="last-name">Cognome</label>
                            <input type="text" id="profile-lastname" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Rossi">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="email">Email</label>
                        <input type="email" id="profile-email" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="mario.rossi@email.com">
                    </div>
                </div>
                    
                    <!-- Sezione Indirizzo Casa -->
                    <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-home mr-2"></i><span data-translate="home-address">Indirizzo di Casa</span>
                        <span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded" data-translate="used-for-stores">Usato per trovare negozi</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="street">Via</label>
                            <input type="text" id="home-street" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Via Roma">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="number">Numero</label>
                            <input type="text" id="home-number" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="123">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="city">Citt√†</label>
                            <input type="text" id="home-city" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Milano">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="province">Provincia</label>
                            <input type="text" id="home-province" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 uppercase max-w-[80px]"
                                   placeholder="MI" maxlength="2">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="country">Paese</label>
                        <select id="home-country" 
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="IT">üáÆüáπ Italia</option>
                            <option value="RO">üá∑üá¥ Rom√¢nia</option>
                            <option value="US">üá∫üá∏ United States</option>
                            <option value="GB">üá¨üáß United Kingdom</option>
                            <option value="ES">üá™üá∏ Espa√±a</option>
                            <option value="FR">üá´üá∑ France</option>
                            <option value="DE">üá©üá™ Deutschland</option>
                            <option value="CH">üá®üá≠ Schweiz</option>
                        </select>
                    </div>
                </div>
                    
                    <!-- Sezione Indirizzo Lavoro -->
                    <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-briefcase mr-2"></i><span data-translate="work-address">Indirizzo di Lavoro</span>
                        <span class="ml-2 text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded" data-translate="optional">Facoltativo</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="street">Via</label>
                            <input type="text" id="work-street" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Via Milano">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="number">Numero</label>
                            <input type="text" id="work-number" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="456">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="city">Citt√†</label>
                            <input type="text" id="work-city" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="Milano">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="province">Provincia</label>
                            <input type="text" id="work-province" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 uppercase max-w-[80px]"
                                   placeholder="MI" maxlength="2">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="country">Paese</label>
                        <select id="work-country" 
                                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="" data-translate="select">-- Seleziona --</option>
                            <option value="IT">üáÆüáπ Italia</option>
                            <option value="RO">üá∑üá¥ Rom√¢nia</option>
                            <option value="US">üá∫üá∏ United States</option>
                            <option value="GB">üá¨üáß United Kingdom</option>
                            <option value="ES">üá™üá∏ Espa√±a</option>
                            <option value="FR">üá´üá∑ France</option>
                            <option value="DE">üá©üá™ Deutschland</option>
                            <option value="CH">üá®üá≠ Schweiz</option>
                        </select>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" data-translate="company">Nome Azienda</label>
                        <input type="text" id="work-company" 
                               class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                               placeholder="Nome della tua azienda">
                    </div>
                </div>
                    
                    <!-- NUOVA SEZIONE: Lingua e Valuta -->
                    <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">
                        <i class="fas fa-globe mr-2"></i><span data-translate="international-preferences">Preferenze Internazionali</span>
                    </h3>
                
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="preferred-language">Lingua Preferita</label>
                            <select id="profile-language" 
                                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="it">üáÆüáπ Italiano</option>
                                <option value="en">üá¨üáß English</option>
                                <option value="es">üá™üá∏ Espa√±ol</option>
                                <option value="fr">üá´üá∑ Fran√ßais</option>
                                <option value="de">üá©üá™ Deutsch</option>
                                <option value="ro">üá∑üá¥ Rom√¢nƒÉ</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="default-currency">Valuta Predefinita</label>
                            <select id="profile-currency" 
                                    class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="EUR">‚Ç¨ Euro (EUR) - Unione Europea</option>
                                <option value="USD">$ US Dollar (USD) - Stati Uniti</option>
                                <option value="GBP">¬£ British Pound (GBP) - Regno Unito</option>
                                <option value="RON">lei Romanian Leu (RON) - Romania</option>
                                <option value="CHF">CHF Swiss Franc (CHF) - Svizzera</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Preview valuta -->
                    <div id="currency-preview" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
                        <p class="text-sm text-gray-600 mb-1" data-translate="formatting-preview">Anteprima formattazione:</p>
                        <p class="font-mono text-lg">
                            <span id="preview-amount">1.234,56</span>
                            <span class="text-gray-500 ml-2" id="preview-info"></span>
                        </p>
                    </div>
                </div>
                    <!-- Pulsanti Azione -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-6 border-t">
                    <button onclick="saveProfile()" 
                            class="flex-1 py-3 btn-income text-white rounded-lg font-semibold flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> <span data-translate="save-profile">Salva Profilo</span>
                    </button>
                    <button onclick="showScreen('dashboard')" 
                            class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 flex items-center justify-center gap-2">
                        <i class="fas fa-times"></i> <span data-translate="cancel">Annulla</span>
                    </button>
                </div>
<!-- BOTTONE CANCELLA STORICO -->
<div class="mt-4">
<button onclick="resetAllData()" 
        class="w-full py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 flex items-center justify-center gap-2">
    <i class="fas fa-trash mr-2"></i> <span data-translate="reset-history">Cancella storico records</span>
</button>
</div>

        </div> <!-- Questa chiude il div class="space-y-8" -->
    </div> <!-- Questa chiude il div class="bg-white rounded-xl shadow p-6" -->
</div> <!-- Questa chiude screen-profile -->
        
        <!-- ==================== SCREEN 8: TUTTE LE TRANSAZIONI ==================== -->
        <div id="screen-transactions" class="screen">
            <div class="mb-6">
                <button onclick="showScreen('dashboard')" 
        class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
    <i class="fas fa-arrow-left"></i> <span data-translate="back-to-dashboard">Torna alla Dashboard</span>
</button>
            </div>
            
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-exchange-alt mr-2"></i><span data-translate="all-transactions">Tutte le Transazioni</span>
                </h2>
                
                <div id="all-transactions" class="space-y-3">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
        </div>
<!-- ==================== SCREEN 9: REPORT E GRAFICI ==================== -->
<div id="screen-reports" class="screen">
<div class="mb-6">
    <button onclick="showScreen('dashboard')" 
            class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
        <i class="fas fa-arrow-left"></i> <span data-translate="back-to-dashboard">Torna alla Dashboard</span>
    </button>
</div>

<div class="bg-white rounded-xl shadow p-6">
    <h2 class="text-xl font-bold text-gray-800 mb-6">
        <i class="fas fa-chart-pie text-purple-500 mr-2"></i><span data-translate="reports">Report e Grafici</span>
    </h2>
    
    <!-- Riepilogo mensile -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="p-4 bg-green-50 rounded-lg">
            <p class="text-sm text-gray-600" data-translate="total-income">Entrate totali</p>
            <p class="text-2xl font-bold text-green-600" id="report-total-income">‚Ç¨0,00</p>
        </div>
        <div class="p-4 bg-red-50 rounded-lg">
            <p class="text-sm text-gray-600" data-translate="total-expenses">Uscite totali</p>
            <p class="text-2xl font-bold text-red-600" id="report-total-expenses">‚Ç¨0,00</p>
        </div>
    </div>
    
    <!-- Grafico spese per categoria -->
    <div class="mb-6">
        <h3 class="font-semibold text-gray-800 mb-3" data-translate="expenses-by-category">Spese per Categoria</h3>
        <div id="category-chart" class="space-y-3">
            <!-- Popolato da JavaScript -->
        </div>
    </div>
    
    <!-- Spese per negozio -->
    <div class="mb-6">
        <h3 class="font-semibold text-gray-800 mb-3" data-translate="expenses-by-store">Spese per Negozio</h3>
        <div id="store-chart" class="space-y-3">
            <!-- Popolato da JavaScript -->
        </div>
    </div>
    
    <!-- Andamento mensile -->
    <div>
        <h3 class="font-semibold text-gray-800 mb-3" data-translate="monthly-trend">Andamento Mensile</h3>
        <div id="monthly-trend" class="space-y-3">
            <!-- Popolato da JavaScript -->
        </div>
    </div>
</div>
</div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
    // ========== DEBUG ERRORI ==========
    window.addEventListener('error', function(e) {
            console.error('üî• ERRORE CATTURATO:', e.error);
            console.log('üìç Nel file:', e.filename);
            console.log('üìå Alla riga:', e.lineno);
            console.log('‚úèÔ∏è Al carattere:', e.colno);
            console.log('üìù Messaggio:', e.message);
        });
        // ==================== STACKBLITZ STORAGE SOLUTION ====================
// Sistema di storage garantito per Stackblitz
const appStorage = {
    data: {},
    
    setItem: function(key, value) {
        // Prima prova localStorage
        try {
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem(key, JSON.stringify(value));
                return;
            }
        } catch (e) {}
        
        // Poi prova sessionStorage
        try {
            if (typeof sessionStorage !== 'undefined') {
                sessionStorage.setItem(key, JSON.stringify(value));
                return;
            }
        } catch (e) {}
        
        // Fallback: variabile globale
        this.data[key] = value;
        console.log('Storage fallback usato per:', key);
    },
    
    getItem: function(key) {
        // Prima prova localStorage
        try {
            if (typeof localStorage !== 'undefined') {
                const item = localStorage.getItem(key);
                if (item) return JSON.parse(item);
            }
        } catch (e) {}
        
        // Poi prova sessionStorage
        try {
            if (typeof sessionStorage !== 'undefined') {
                const item = sessionStorage.getItem(key);
                if (item) return JSON.parse(item);
            }
        } catch (e) {}
        
        // Fallback: variabile globale
        return this.data[key] || null;
    },
    
    removeItem: function(key) {
        try { localStorage.removeItem(key); } catch (e) {}
        try { sessionStorage.removeItem(key); } catch (e) {}
        delete this.data[key];
    },
    
    clear: function() {
        try { localStorage.clear(); } catch (e) {}
        try { sessionStorage.clear(); } catch (e) {}
        this.data = {};
    }
};

// DEBUG: Controlla se lo storage funziona
console.log('Storage system ready:', appStorage);
window.GLOBAL_APP_DATA = {
    userProfile: null,
    lastSave: null
};

// ==================== OPENSTREETMAP INTEGRATION ====================
// Configurazione
const OSM_CONFIG = {
    USER_AGENT: 'SmartBillingApp/1.0 (tuo-email@example.com)',
    SEARCH_RADIUS: 2000, // raggio in metri
    SHOP_TYPES: [
        'supermarket', 'convenience', 'grocery', 'greengrocer',
        'butcher', 'bakery', 'chemist', 'pharmacy', 'department_store'
    ]
};

// Geocoding: converte indirizzo in coordinate
async function geocodeAddress(address) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`;
    
    try {
        const response = await fetch(url, {
            headers: {
                'User-Agent': 'SmartBillingApp/1.0',
                'Accept': 'application/json',
                'Origin': window.location.origin
            },
            mode: 'cors'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        if (data.length > 0) {
            return {
                lat: parseFloat(data[0].lat),
                lon: parseFloat(data[0].lon),
                displayName: data[0].display_name
            };
        }
        return null;
    } catch (error) {
        console.error('Errore geocoding:', error);
        return null;
    }
}

// Calcola distanza tra due punti
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Raggio Terra in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Formatta distanza
function formatDistance(distance) {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    return distance < 1 ? 
        `${Math.round(distance * 1000)} ${t['m'] || 'm'}` : 
        `${distance.toFixed(1)} ${t['km'] || 'km'}`;
}

// Cerca negozi con Overpass API
// Cerca negozi con Overpass API
async function findNearbyShops(lat, lon, radius = OSM_CONFIG.SEARCH_RADIUS) {
    // Riduci ulteriormente il raggio e i tipi
    const safeRadius = Math.min(radius, 1000); // Max 1km
    
    const essentialShopTypes = ['supermarket', 'convenience']; // Solo i pi√π comuni
    
    const shopFilters = essentialShopTypes.map(type => 
        `node["shop"="${type}"](around:${safeRadius},${lat},${lon});`
    ).join('');
    
    const query = `[out:json][timeout:10];(${shopFilters}way["shop"](around:${safeRadius},${lat},${lon}););out body 5;`;
    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
    
    try {
        const response = await fetch(url, {
            headers: { 'User-Agent': OSM_CONFIG.USER_AGENT }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        return data.elements || [];
    } catch (error) {
        console.error('Errore Overpass:', error);
        return []; // Ritorna array vuoto invece di far fallire
    }
}

// Traduci tipo negozio
function getShopTypeTranslation(type) {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    const translations = {
        'supermarket': t['supermarket'] || 'Supermercato',
        'convenience': t['convenience'] || 'Alimentari',
        'grocery': t['grocery'] || 'Drogheria',
        'greengrocer': t['greengrocer'] || 'Fruttivendolo',
        'butcher': t['butcher'] || 'Macelleria',
        'bakery': t['bakery'] || 'Panetteria',
        'chemist': t['chemist'] || 'Drogeria',
        'pharmacy': t['pharmacy'] || 'Farmacia',
        'department_store': t['department_store'] || 'Grande magazzino'
    };
    
    return translations[type] || type;
}

// ==================== RENDI GLOBALI LE FUNZIONI OSM ====================
// Attacca le funzioni all'oggetto window per renderle accessibili globalmente
window.OSM_CONFIG = OSM_CONFIG;
window.geocodeAddress = geocodeAddress;
window.calculateDistance = calculateDistance;
window.formatDistance = formatDistance;
window.findNearbyShops = findNearbyShops;
window.getShopTypeTranslation = getShopTypeTranslation;

console.log('‚úÖ Funzioni OSM attaccate a window');
console.log('findNearbyShops disponibile:', typeof window.findNearbyShops);

// ====================================================================
  // ==================== DATA ====================
let userProfile = {
    // Personal data
    firstName: '',
    lastName: '',
    email: '',
    
    // Home address
    homeStreet: '',
    homeNumber: '',
    homeCity: '',
    homeProvince: '',
    homeCountry: 'IT',  // <-- NUOVO CAMPO (codice ISO a 2 lettere)
    homeFullAddress: '',
    
    // Work address
    workStreet: '',
    workNumber: '',
    workCity: '',
    workProvince: '',
    workCountry: '',    // <-- NUOVO CAMPO
    workCompany: '',
    workFullAddress: '',
    
    // NUOVI CAMPI: Internazionalizzazione
    language: 'en',
    currency: 'EUR',
    currencySymbol: '‚Ç¨'
};
window.userProfile = userProfile;


// Dizionari per lingue e valute
const languages = {
    'it': { name: 'Italiano', flag: 'üáÆüáπ' },
    'en': { name: 'English', flag: 'üá¨üáß' },
    'es': { name: 'Espa√±ol', flag: 'üá™üá∏' },
    'fr': { name: 'Fran√ßais', flag: 'üá´üá∑' },
    'de': { name: 'Deutsch', flag: 'üá©üá™' },
    'ro': { name: 'Rom√¢nƒÉ', flag: 'üá∑üá¥' }
};

const currencies = {
    'EUR': { name: 'Euro', symbol: '‚Ç¨', country: 'UE' },
    'USD': { name: 'US Dollar', symbol: '$', country: 'USA' },
    'GBP': { name: 'British Pound', symbol: '¬£', country: 'UK' },
    'RON': { name: 'Romanian Leu', symbol: 'lei', country: 'Romania' },
    'CHF': { name: 'Swiss Franc', symbol: 'CHF', country: 'Switzerland' }
};
const countries = {
    'IT': { name: 'Italia', flag: 'üáÆüáπ', code: 'IT' },
    'RO': { name: 'Rom√¢nia', flag: 'üá∑üá¥', code: 'RO' },
    'US': { name: 'United States', flag: 'üá∫üá∏', code: 'US' },
    'GB': { name: 'United Kingdom', flag: 'üá¨üáß', code: 'GB' },
    'ES': { name: 'Espa√±a', flag: 'üá™üá∏', code: 'ES' },
    'FR': { name: 'France', flag: 'üá´üá∑', code: 'FR' },
    'DE': { name: 'Deutschland', flag: 'üá©üá™', code: 'DE' },
    'CH': { name: 'Schweiz', flag: 'üá®üá≠', code: 'CH' }
};
let transactions = [];  // Nessuna transazione iniziale
let shoppingList = [];  // Lista vuota all'avvio
// Rendi accessibili globalmente per debug


let budget = {
    Alimentari: 0,
    Mutuo: 0,        // <-- AGGIUNGI QUI
    Affitto: 0,
    Bollette: 0,
    Trasporti: 0,
    Svago: 0,
    Salute: 0
};
// Rendi accessibili globalmente per debug
window.transactions = transactions;
window.shoppingList = shoppingList;
window.budget = budget;
window.userProfile = userProfile;

// ==================== VARIABILI GEOLOCALIZZAZIONE ====================
let currentLocationType = 'home'; // 'home', 'work', 'current'
let currentCoords = null; // Per la posizione attuale (lat, lon)

// ==================== DATABASE NEGOZI ====================
// Inizializza le variabili globali
window.storesDatabase = JSON.parse(localStorage.getItem('storesDatabase') || '[]');
window.userStores = JSON.parse(localStorage.getItem('userStores') || '[]');

console.log('üè™ Database negozi caricato:', {
    stores: window.storesDatabase.length,
    users: window.userStores.length
});

// Funzione per ottenere tutti i negozi
window.getAllStores = function() {
    const allStores = [...window.storesDatabase, ...window.userStores];
    const uniqueStores = [];
    const storeNames = new Set();
    
    allStores.forEach(store => {
        if (!storeNames.has(store.name.toLowerCase())) {
            storeNames.add(store.name.toLowerCase());
            uniqueStores.push(store);
        }
    });
    
    return uniqueStores.sort((a, b) => a.name.localeCompare(b.name));
};

// Funzione per salvare un nuovo negozio
window.saveUserStore = function(storeName, address = '', lat = null, lon = null) {
    const newStore = {
        id: Date.now(),
        name: storeName,
        address: address,
        lat: lat,
        lon: lon,
        source: 'user',
        dateAdded: new Date().toISOString()
    };
    
    window.userStores.push(newStore);
    localStorage.setItem('userStores', JSON.stringify(window.userStores));
    
    showToast(`üè™ Negozio "${storeName}" salvato!`);
    return newStore;
};

// Funzione per aggiornare negozi da OSM
window.updateStoresFromOSM = function(shops) {
    if (!shops || shops.length === 0) return;
    
    window.storesDatabase = shops.map(shop => ({
        id: shop.id,
        name: shop.tags?.name || shop.tags?.brand || 'Negozio',
        address: shop.tags?.['addr:street'] ? 
            `${shop.tags['addr:street']} ${shop.tags['addr:housenumber'] || ''}`.trim() : '',
        lat: shop.lat || shop.center?.lat,
        lon: shop.lon || shop.center?.lon,
        source: 'osm',
        type: shop.tags?.shop
    })).filter(store => store.name !== 'Negozio');
    
    localStorage.setItem('storesDatabase', JSON.stringify(window.storesDatabase));
    console.log(`üè™ Salvati ${window.storesDatabase.length} negozi da OSM`);
};

// ==================== FUNZIONI AGGIUNTIVE PER GESTIONE NEGOZI ====================

// Funzione per mostrare il modal di aggiunta nuovo negozio
function showNewStoreModal(itemId, prefillName = '', prefillPrice = null) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">‚ûï Aggiungi nuovo negozio</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Nome negozio *</label>
                    <input type="text" id="new-store-name" 
                           class="w-full p-3 border rounded-lg" 
                           value="${prefillName}"
                           placeholder="Es. Conad, Lidl...">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Indirizzo (opzionale)</label>
                    <input type="text" id="new-store-address" 
                           class="w-full p-3 border rounded-lg" 
                           placeholder="Via Roma 1, Milano">
                </div>
                
                ${prefillPrice ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Prezzo (${userProfile?.currencySymbol || '‚Ç¨'})</label>
                    <input type="number" step="0.01" id="new-store-price" 
                           class="w-full p-3 border rounded-lg" 
                           value="${prefillPrice}">
                </div>
                ` : ''}
                
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        Il negozio verr√† salvato e sar√† disponibile per tutti i prodotti
                    </p>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="saveNewStoreFromCorrection(${itemId})" 
                            class="flex-1 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        <i class="fas fa-save mr-2"></i>Salva negozio
                    </button>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}
function showNewStoreModalWithProduct(itemName, quantity = 1, unit = 'pz', prefillPrice = null) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">‚ûï Aggiungi nuovo negozio per ${itemName}</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Nome negozio *</label>
                    <input type="text" id="new-store-name" 
                           class="w-full p-3 border rounded-lg" 
                           placeholder="Es. Lidl, Conad...">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Indirizzo (opzionale)</label>
                    <input type="text" id="new-store-address" 
                           class="w-full p-3 border rounded-lg" 
                           placeholder="Via Roma 1, Milano">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Prezzo per ${itemName} (${userProfile?.currencySymbol || '‚Ç¨'})</label>
                    <input type="number" step="0.01" id="new-store-price" 
                           class="w-full p-3 border rounded-lg" 
                           value="${prefillPrice || ''}"
                           placeholder="0.00">
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        Dopo il salvataggio, il prodotto verr√† aggiunto automaticamente
                    </p>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="saveNewStoreAndAddProduct('${itemName}', ${quantity}, '${unit}')" 
                            class="flex-1 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        <i class="fas fa-save mr-2"></i>Salva e aggiungi
                    </button>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}
window.saveNewStoreAndAddProduct = async function(itemName, quantity, unit = 'pz') {
    const storeName = document.getElementById('new-store-name').value.trim();
    const storeAddress = document.getElementById('new-store-address').value.trim();
    const priceInput = document.getElementById('new-store-price');
    const price = priceInput ? parseFloat(priceInput.value) : null;
    
    if (!storeName) {
        showToast('‚ö†Ô∏è Inserisci il nome del negozio');
        return;
    }
    
    if (!price || price <= 0) {
        showToast('‚ö†Ô∏è Inserisci un prezzo valido');
        return;
    }
    
    // Geocoding indirizzo (opzionale)
    let lat = null, lon = null;
    if (storeAddress) {
        const coords = await geocodeAddress(storeAddress);
        if (coords) {
            lat = coords.lat;
            lon = coords.lon;
        }
    }
    
    // 1. Salva il negozio
    saveUserStore(storeName, storeAddress, lat, lon);
    
    // 2. Salva il prezzo per questo prodotto in questo negozio
    saveUserPrice(itemName, storeName, price, {
        source: 'manual',
        confidence: 1.0
    });
    
    // 3. Aggiungi direttamente il prodotto alla lista
    shoppingList.push({
        id: Date.now(),
        name: itemName,
        quantity: quantity,
        unit: unit,
        displayName: formatProductNameWithUnit(itemName, quantity, unit),
        checked: false,
        bestPrice: price,
        bestStore: storeName,
        selectedStore: storeName,
        prices: [{
            price: price,
            store: storeName,
            source: 'user',
            confidence: 1.0
        }],
        recognized: true,
        source: 'user',
        confidence: 1.0
    });
    
    // 4. Chiudi modale e aggiorna
    document.querySelector('.fixed').remove();
    saveAllData();
    renderShoppingList();
    
    showToast(`‚úÖ ${formatProductNameWithUnit(itemName, quantity, unit)} aggiunto da ${storeName} - ${formatCurrency(price * quantity)}`);
};

// Funzione per salvare il negozio con eventuale prezzo
window.saveNewStoreWithPrice = async function(itemId) {
    const storeName = document.getElementById('new-store-name').value.trim();
    const storeAddress = document.getElementById('new-store-address').value.trim();
    const priceInput = document.getElementById('new-store-price');
    const newPrice = priceInput ? parseFloat(priceInput.value) : null;
    
    if (!storeName) {
        showToast('‚ö†Ô∏è Inserisci il nome del negozio');
        return;
    }
    
    // Cerca coordinate se √® stato inserito un indirizzo
    let lat = null, lon = null;
    if (storeAddress) {
        const coords = await geocodeAddress(storeAddress);
        if (coords) {
            lat = coords.lat;
            lon = coords.lon;
        }
    }
    
    // ‚úÖ 1. Salva il negozio
    saveUserStore(storeName, storeAddress, lat, lon);
    
    // ‚úÖ 2. Se c'√® anche un prezzo, salva e aggiorna l'item
    if (newPrice && itemId) {
        const item = shoppingList.find(i => i.id === itemId);
        if (item) {
            saveUserPrice(item.name, storeName, newPrice, {
                source: 'correction',
                confidence: 1.0
            });
            
            item.bestPrice = newPrice;
            item.bestStore = storeName;
            item.selectedStore = storeName;
        }
    }
    
    // ‚úÖ 3. CHIUDI IL MODALE PRIMA DI RICARICARE LA LISTA
    const modal = document.querySelector('.fixed');
    if (modal) modal.remove();
    
    // ‚úÖ 4. Ricarica la lista
    renderShoppingList();
    
    showToast(`‚úÖ Negozio "${storeName}" salvato!`);
};

// Rendi globali
window.showNewStoreModal = showNewStoreModal;

// ==================== QUI INSERISCI LA NUOVA FUNZIONE ====================
window.saveNewStoreFromCorrection = async function(itemId) {
    const storeName = document.getElementById('new-store-name').value.trim();
    const storeAddress = document.getElementById('new-store-address').value.trim();
    const priceInput = document.getElementById('new-store-price');
    const newPrice = priceInput ? parseFloat(priceInput.value) : null;
    
    if (!storeName) {
        showToast('‚ö†Ô∏è Inserisci il nome del negozio');
        return;
    }
    
    // Geocoding indirizzo
    let lat = null, lon = null;
    if (storeAddress) {
        const coords = await geocodeAddress(storeAddress);
        if (coords) {
            lat = coords.lat;
            lon = coords.lon;
        }
    }
    
    // Salva il negozio
    saveUserStore(storeName, storeAddress, lat, lon);
    
    // Se c'√® anche un prezzo e un item, salva tutto
    if (newPrice && itemId) {
        const item = shoppingList.find(i => i.id === itemId);
        if (item) {
            saveUserPrice(item.name, storeName, newPrice, {
                source: 'correction',
                confidence: 1.0
            });
            
            item.bestPrice = newPrice;
            item.bestStore = storeName;
            item.selectedStore = storeName;
            
            if (!item.prices) item.prices = [];
            item.prices.push({
                price: newPrice,
                store: storeName,
                source: 'user',
                confidence: 1.0
            });
        }
    }
    
    // Chiudi modale e aggiorna
    const modal = document.querySelector('.fixed');
    if (modal) modal.remove();
    
    renderShoppingList();
    showToast(`‚úÖ Negozio "${storeName}" salvato!`);
};

// Rendi globali
window.showNewStoreModal = showNewStoreModal;
// ==================== FUNZIONI AGGIUNTIVE PER GESTIONE NEGOZI ====================

// Funzione per mostrare il modal di aggiunta nuovo negozio
function showNewStoreModal(itemId, prefillName = '', prefillPrice = null) {
    const item = shoppingList.find(i => i.id === itemId);
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">‚ûï Aggiungi nuovo negozio</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Nome negozio *</label>
                    <input type="text" id="new-store-name" 
                           class="w-full p-3 border rounded-lg" 
                           value="${prefillName}"
                           placeholder="Es. Conad, Esselunga...">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Indirizzo (opzionale)</label>
                    <input type="text" id="new-store-address" 
                           class="w-full p-3 border rounded-lg" 
                           placeholder="Via Roma 1, Milano">
                </div>
                
                ${prefillPrice ? `
                <div>
                    <label class="block text-sm font-medium mb-2">Prezzo (${userProfile?.currencySymbol || '‚Ç¨'})</label>
                    <input type="number" step="0.01" id="new-store-price" 
                           class="w-full p-3 border rounded-lg" 
                           value="${prefillPrice}">
                </div>
                ` : ''}
                
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        Il negozio verr√† salvato e sar√† disponibile per tutti i prodotti
                    </p>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="saveNewStoreWithPrice(${itemId})" 
                            class="flex-1 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                        <i class="fas fa-save mr-2"></i>Salva negozio
                    </button>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Funzione per salvare il negozio con eventuale prezzo
window.saveNewStoreWithPrice = async function(itemId) {
    const storeName = document.getElementById('new-store-name').value.trim();
    const storeAddress = document.getElementById('new-store-address').value.trim();
    const priceInput = document.getElementById('new-store-price');
    const newPrice = priceInput ? parseFloat(priceInput.value) : null;
    
    if (!storeName) {
        showToast('‚ö†Ô∏è Inserisci il nome del negozio');
        return;
    }
    
    // Cerca coordinate se √® stato inserito un indirizzo
    let lat = null, lon = null;
    if (storeAddress) {
        const coords = await geocodeAddress(storeAddress);
        if (coords) {
            lat = coords.lat;
            lon = coords.lon;
        }
    }
    
    // Salva il negozio (usa la funzione gi√† esistente)
    saveUserStore(storeName, storeAddress, lat, lon);
    
    // Se c'√® anche un prezzo da salvare
    if (newPrice && itemId) {
        const item = shoppingList.find(i => i.id === itemId);
        if (item) {
            saveUserPrice(item.name, storeName, newPrice, {
                source: 'correction',
                confidence: 1.0
            });
            
            item.bestPrice = newPrice;
            item.bestStore = storeName;
            item.selectedStore = storeName;
        }
    }
    
    // Ricarica la lista
    renderShoppingList();
    document.querySelector('.fixed').remove();
    showToast(`‚úÖ Negozio "${storeName}" salvato!`);
};

// Rendi globali le funzioni
window.showNewStoreModal = showNewStoreModal;
// ==================== GESTIONE POSIZIONE ====================
function setLocation(type) {
    currentLocationType = type;
    
    // Aggiorna UI dei bottoni
    document.querySelectorAll('[id^="location-"]').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white', 'bg-purple-500', 'bg-green-500');
        btn.classList.add('bg-blue-100', 'text-blue-700', 'bg-purple-100', 'text-purple-700', 'bg-green-100', 'text-green-700');
    });
    
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    let locationText = '';
    
    if (type === 'home') {
        document.getElementById('location-home-btn').classList.remove('bg-blue-100', 'text-blue-700');
        document.getElementById('location-home-btn').classList.add('bg-blue-500', 'text-white');
        locationText = t['home'] || 'Casa';
        
    } else if (type === 'work') {
        document.getElementById('location-work-btn').classList.remove('bg-purple-100', 'text-purple-700');
        document.getElementById('location-work-btn').classList.add('bg-purple-500', 'text-white');
        locationText = t['work'] || 'Lavoro';
        
        // Verifica se l'indirizzo di lavoro √® impostato
        if (!userProfile.workFullAddress && !userProfile.workStreet) {
            showToast('‚ö†Ô∏è ' + (t['work-address-not-set'] || 'Imposta prima l\'indirizzo di lavoro nel profilo'));
            setLocation('home');
            return;
        }
        
    } else if (type === 'current') {
        document.getElementById('location-current-btn').classList.remove('bg-green-100', 'text-green-700');
        document.getElementById('location-current-btn').classList.add('bg-green-500', 'text-white');
        locationText = t['current-location'] || 'Posizione attuale';
        
        // Ottieni la posizione corrente
        getCurrentPosition();
    }
    
    document.getElementById('current-location-text').textContent = locationText;
}
// ==================== OTTIENI POSIZIONE GPS ====================
function getCurrentPosition() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    if (!navigator.geolocation) {
        showToast('‚ö†Ô∏è ' + (t['location-not-supported'] || 'Geolocalizzazione non supportata'));
        setLocation('home');
        return;
    }
    
    showToast('üìç ' + (t['getting-location'] || 'Ottenimento posizione...'));
    
    navigator.geolocation.getCurrentPosition(
        (position) => {
            currentCoords = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
            };
            console.log('üìç Posizione attuale:', currentCoords);
            showToast('‚úÖ ' + (t['location-obtained'] || 'Posizione ottenuta'));
        },
        (error) => {
            console.error('Errore geolocalizzazione:', error);
            let errorMsg = t['location-error'] || 'Errore nel ottenere la posizione';
            if (error.code === 1) errorMsg = t['location-permission-denied'] || 'Permesso negato';
            if (error.code === 2) errorMsg = t['location-not-available'] || 'Posizione non disponibile';
            if (error.code === 3) errorMsg = t['location-timeout'] || 'Timeout';
            showToast(`‚ö†Ô∏è ${errorMsg}`);
            setLocation('home');
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        }
    );
}
// ==================== RICERCA NEGOZI CON COORDINATE ====================
async function renderNearbyStoresWithCoords(lat, lon) {
    const container = document.getElementById('nearby-stores');
    const searchBtn = document.getElementById('search-stores-btn');
    
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    const originalBtnText = searchBtn.innerHTML;
    searchBtn.innerHTML = `<div class="store-loader"></div> ${t['searching'] || 'Ricerca in corso...'}`;
    searchBtn.disabled = true;
    
    container.innerHTML = `<p class="text-center text-gray-500 py-4">üîç ${t['searching-nearby'] || 'Cerco negozi nelle vicinanze...'}</p>`;
    
    try {
        // Cerca negozi con le coordinate fornite
        const shops = await findNearbyShops(lat, lon);
        
        container.innerHTML = '';
        
        // Header con tipo di posizione
        let locationText = '';
        if (currentLocationType === 'home') locationText = t['home'] || 'Casa';
        else if (currentLocationType === 'work') locationText = t['work'] || 'Lavoro';
        else if (currentLocationType === 'current') locationText = t['current-location'] || 'Posizione attuale';
        
        container.innerHTML += `
            <div class="p-3 bg-blue-50 rounded-lg mb-4">
                <p class="text-sm text-gray-600">${t['searching-near'] || 'Negozi vicino a:'}</p>
                <p class="font-semibold text-blue-800">${locationText}</p>
            </div>
        `;
        
        if (shops.length === 0) {
            container.innerHTML += `
                <div class="text-center py-8">
                    <i class="fas fa-store-slash text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">${t['no-stores-found'] || 'Nessun negozio trovato nel raggio di'} ${OSM_CONFIG.SEARCH_RADIUS/1000}${t['km'] || 'km'}</p>
                </div>
            `;
        } else {
            // Calcola e ordina per distanza
            const shopsWithDistance = shops.map(shop => {
                const distance = calculateDistance(
                    lat, lon,
                    parseFloat(shop.lat || shop.center?.lat || 0),
                    parseFloat(shop.lon || shop.center?.lon || 0)
                );
                return { ...shop, distance };
            }).sort((a, b) => a.distance - b.distance);
            
            shopsWithDistance.forEach(shop => {
                const name = shop.tags?.name || shop.tags?.brand || (t['store'] || 'Negozio');
                const type = shop.tags?.shop || 'generico';
                const distanceValue = shop.distance;
                const distance = distanceValue < 1 ? 
                    `${Math.round(distanceValue * 1000)}${t['m'] || 'm'}` : 
                    `${distanceValue.toFixed(1)}${t['km'] || 'km'}`;
                const address = shop.tags?.['addr:street'] ? 
                    `${shop.tags['addr:street']} ${shop.tags['addr:housenumber'] || ''}`.trim() : 
                    (t['address-not-available'] || 'Indirizzo non disponibile');
                
                container.innerHTML += `
                    <div class="p-4 border rounded-lg mb-3 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-800">${name}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                        ${getShopTypeTranslation(type)}
                                    </span>
                                    <span class="text-sm text-gray-600">
                                        <i class="fas fa-road mr-1"></i>${distance}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">
                                    <i class="fas fa-map-pin mr-1"></i>${address}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML += `
                <div class="mt-4 text-xs text-gray-400 text-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${t['osm-credit'] || 'Dati ¬© contributori OpenStreetMap'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Errore:', error);
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                <p>${t['search-error'] || 'Errore nella ricerca dei negozi'}</p>
                <button onclick="showScreen('profile')" 
                        class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    ${t['go-to-profile'] || 'Vai al Profilo'}
                </button>
            </div>
        `;
    } finally {
        searchBtn.innerHTML = originalBtnText;
        searchBtn.disabled = false;
    }
}
    // ==================== SUGGERIMENTO CATEGORIE INTELLIGENTE ====================
    const categoryKeywords = {
        'Stipendio': ['stipendio', 'salario', 'salar', 'paga', 'mensile', 'bonus'],  // <-- AGGIUNTA QUI
        'Bollette': ['luce', 'elettrica', 'gas', 'acqua', 'riscaldamento', 'telefono', 'internet', 'fibra', 'adsl', 'enel', 'enel energia', 'energia', 'bolletta', 'fornitura', 'utenza'],
        'Alimentari': ['spesa', 'alimentari', 'supermercato', 'alimentare', 'cibo', 'cucina', 'mercato', 'grossista'],
        'Trasporti': ['benzina', 'diesel', 'carburante', 'gasolio', 'autostrada', 'parcheggio', 'taxi', 'trasporto', 'bus', 'treno', 'metro', 'mezzi', 'biglietto', 'abbonamento'],
        'Svago': ['ristorante', 'pizza', 'cena', 'pranzo', 'cinema', 'teatro', 'concerto', 'disco', 'bar', 'pub', 'vacanza', 'viaggio', 'hotel', 'divertimento'],
        'Salute': ['farmacia', 'farmaco', 'medico', 'dottore', 'ospedale', 'analisi', 'visita', 'specialista', 'dentista', 'oculista', 'medicina'],
        'Shopping': ['vestiti', 'abbigliamento', 'scarpe', 'tecnologia', 'elettronica', 'arredamento', 'mobile', 'casa', 'giocattolo', 'regalo'],
        'Affitto': ['affitto', 'mutuo', 'rata', 'condominio', 'casa', 'appartamento', 'locazione', 'credito', 'prestito', 'finanziamento'],
        'Mutuo': ['mutuo', 'credit', 'credito', 'prestito', 'ipoteca', 'rata mutuo', 'banca', 'rata', 'finanziamento']

    };

    // Dizionario per imparare dalle correzioni utente
    let learnedCategories = JSON.parse(sessionStorage.getItem('learnedCategories') || '{}');
    function translateCategoryName(category, lang, t) {
    // Mappa delle categorie italiane alle chiavi del dizionario
    const categoryMap = {
        'Stipendio': 'salary',
        'Bonus': 'bonus',
        'Investimenti': 'investments',
        'Rendite': 'rental-income',
        'Altro': 'other',
        'Alimentari': 'food',
        'Bollette': 'utilities',
        'Mutuo': 'mortgage',
        'Trasporti': 'transport',
        'Svago': 'entertainment',
        'Salute': 'health',
        'Shopping': 'shopping',
        'Affitto': 'rent',
        'Cibo': 'food',
        'Abitazione': 'housing',
        'Intrattenimento': 'entertainment'
    };
    
    const key = categoryMap[category];
    if (key && t[key]) {
        return t[key];
    }
    
    // Se non trovata, restituisci la categoria originale
    return category;
}
    // Suggerisci categoria basata sul nome della spesa
    function suggestCategory(description) {
        const descLower = description.toLowerCase().trim();
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        
        // 1. Controlla prima nelle categorie imparate
        for (const [keyword, category] of Object.entries(learnedCategories)) {
            if (descLower.includes(keyword.toLowerCase())) {
                // Traduci la categoria nella lingua corrente
            return translateCategoryName(category, lang, t);

            }
        }
        
        // 2. Controlla nelle keyword predefinite
        for (const [category, keywords] of Object.entries(categoryKeywords)) {
            for (const keyword of keywords) {
                if (descLower.includes(keyword.toLowerCase())) {
                    // Traduci la categoria nella lingua corrente
                return translateCategoryName(category, lang, t);
                }
            }
        }
        
        // 3. Default
        return t['other'] || 'Altro';
    }

    // Impara dalla correzione utente
    function learnCategory(description, category) {
    const descLower = description.toLowerCase().trim();
    const words = descLower.split(' ').filter(word => word.length > 2);
    
    words.forEach(word => {
        if (word.length > 3) {
            learnedCategories[word] = category;
        }
    });
    
    // Salva in ENTRAMBI i sistemi
    appStorage.setItem('learnedCategories', learnedCategories);
    try {
        sessionStorage.setItem('learnedCategories', JSON.stringify(learnedCategories));
    } catch (e) {
        console.log('sessionStorage fallito per learnedCategories:', e);
    }
}

    // Mostra suggerimento in tempo reale
    function suggestCategoryOnInput(type) {
    // Elementi specifici per entrate o uscite
    let descInput, categorySelect, hintElement, suggestedText;
    
    if (type === 'income') {
        descInput = document.getElementById('income-desc');
        categorySelect = document.getElementById('income-category');
        hintElement = document.getElementById('income-category-suggestion-hint');
        suggestedText = document.getElementById('income-suggested-category-text');
    } else {
        descInput = document.getElementById('expense-desc');
        categorySelect = document.getElementById('expense-category');
        hintElement = document.getElementById('expense-category-suggestion-hint');
        suggestedText = document.getElementById('expense-suggested-category-text');
    }
    
    // DEBUG - Controlla che gli elementi esistano
    console.log('üîç suggestCategoryOnInput:', type);
    console.log('   descInput:', descInput);
    console.log('   categorySelect:', categorySelect);
    console.log('   hintElement:', hintElement);
    console.log('   suggestedText:', suggestedText);
    
    // Se manca l'input, esci
    if (!descInput) {
        console.log('‚ùå Input non trovato!');
        return;
    }
    
    const inputValue = descInput.value.trim();
    
    if (inputValue.length > 2) {
        const suggestedCategory = suggestCategory(inputValue);
        console.log('   suggestedCategory:', suggestedCategory);
        
        if (categorySelect) {
            // Cambia il valore del select
            categorySelect.value = suggestedCategory;
            categorySelect.classList.add('suggested');
            
            // Mostra l'hint
            if (hintElement) {
                hintElement.classList.remove('hidden');
                if (suggestedText) {
                    suggestedText.textContent = suggestedCategory;
                }
            }
            
            // Rimuovi l'evidenziazione dopo 1.5 secondi
            setTimeout(() => {
                categorySelect.classList.remove('suggested');
            }, 1500);
        }
    } else {
        // Nascondi l'hint se il testo √® troppo corto
        if (hintElement) {
            hintElement.classList.add('hidden');
        }
    }
}
    // Database dei prezzi per negozio - AGGIORNATO CON PI√ô PRODOTTI
    // Commenta tutto questo blocco se non lo usi pi√π
/*
    const storePrices = {
        'Esselunga': {
            'pane': 1.99,
            'latte': 1.49,
            'uova': 2.99,
            'pasta': 0.89,
            'riso': 1.29,
            'pomodori': 2.49,
            'formaggio': 4.99,
            'yogurt': 2.19,
            'caff√®': 3.49,
            'biscotti': 1.79,
            'burro': 2.49,
            'olio': 5.99,
            'zucchero': 1.29,
            'sale': 0.89,
            'acqua': 0.39,
            'vino': 6.99,
            'birra': 1.99,
            'carne': 12.99,
            'pollo': 8.99,
            'pesce': 14.99,
            'frutta': 3.49,
            'verdura': 2.99,
            'penne': 1.19,
            'spaghetti': 1.09,
            'lasagne': 3.49,
            'mozzarella': 2.99,
            'parmigiano': 12.99,
            'prosciutto': 15.99,
            'salame': 13.99,
            'tonno': 3.99,
            'salmone': 18.99,
            'banane': 1.99,
            'mele': 2.49,
            'arance': 2.29,
            'limoni': 1.79,
            'patate': 1.49,
            'cipolle': 1.29,
            'aglio': 2.99,
            'carote': 1.19,
            'insalata': 1.99,
            'pane integrale': 2.29,
            'pane bianco': 1.99,
            'latte intero': 1.59,
            'latte scremato': 1.59,
            'uova di gallina': 3.49,
            'pasta integrale': 1.49,
            'crackers': 2.49,
            'cereali': 3.99,
            'marmellata': 2.79,
            'miele': 4.99,
            'succo': 1.89,
            'succhi': 1.89,
            'aranciata': 1.49,
            'coca cola': 1.79,
            'coca-cola': 1.79,
            'pepsi': 1.69,
            'fanta': 1.49,
            'sprite': 1.49,
            'cioccolato': 2.99,
            'gelato': 4.99,
            'pizza surgelata': 3.49,
            'hamburger': 8.99,
            'salsiccia': 7.99,
            'wurstel': 3.99,
            'maionese': 2.49,
            'ketchup': 1.99,
            'senape': 1.79,
            'aceto': 2.29,
            'pepe': 3.49,
            'paprika': 2.99,
            'cannella': 4.99,
            'noce moscata': 5.49,
            'curry': 3.79,
            'zenzero': 4.29,
            'prezzemolo': 0.99,
            'basilico': 1.29,
            'rosmarino': 1.49,
            'salvia': 1.59,
            'timo': 1.49
        },
        'Carrefour Express': {
            'pane': 2.19,
            'latte': 1.59,
            'uova': 3.19,
            'pasta': 0.99,
            'riso': 1.39,
            'pomodori': 2.69,
            'formaggio': 5.29,
            'yogurt': 2.39,
            'caff√®': 3.79,
            'biscotti': 1.99,
            'burro': 2.69,
            'olio': 6.29,
            'zucchero': 1.39,
            'sale': 0.99,
            'acqua': 0.49,
            'vino': 7.49,
            'birra': 2.19,
            'carne': 13.99,
            'pollo': 9.49,
            'pesce': 15.99,
            'frutta': 3.79,
            'verdura': 3.29,
            'penne': 1.29,
            'spaghetti': 1.19,
            'lasagne': 3.79,
            'mozzarella': 3.29,
            'parmigiano': 13.99,
            'prosciutto': 16.99,
            'salame': 14.99,
            'tonno': 4.29,
            'salmone': 19.99,
            'banane': 2.19,
            'mele': 2.69,
            'arance': 2.49,
            'limoni': 1.99,
            'patate': 1.69,
            'cipolle': 1.49,
            'aglio': 3.29,
            'carote': 1.39,
            'insalata': 2.19,
            'pane integrale': 2.49,
            'pane bianco': 2.19,
            'latte intero': 1.69,
            'latte scremato': 1.69,
            'uova di gallina': 3.79,
            'pasta integrale': 1.69,
            'crackers': 2.69,
            'cereali': 4.29,
            'marmellata': 2.99,
            'miele': 5.49,
            'succo': 1.99,
            'succhi': 1.99,
            'aranciata': 1.59,
            'coca cola': 1.89,
            'coca-cola': 1.89,
            'pepsi': 1.79,
            'fanta': 1.59,
            'sprite': 1.59,
            'cioccolato': 3.29,
            'gelato': 5.49,
            'pizza surgelata': 3.79,
            'hamburger': 9.49,
            'salsiccia': 8.49,
            'wurstel': 4.29,
            'maionese': 2.69,
            'ketchup': 2.19,
            'senape': 1.99,
            'aceto': 2.49,
            'pepe': 3.79,
            'paprika': 3.29,
            'cannella': 5.49,
            'noce moscata': 5.99,
            'curry': 4.09,
            'zenzero': 4.69,
            'prezzemolo': 1.19,
            'basilico': 1.49,
            'rosmarino': 1.69,
            'salvia': 1.79,
            'timo': 1.69
        },
        'Conad': {
            'pane': 1.89,
            'latte': 1.39,
            'uova': 2.89,
            'pasta': 0.85,
            'riso': 1.25,
            'pomodori': 2.39,
            'formaggio': 4.79,
            'yogurt': 2.09,
            'caff√®': 3.29,
            'biscotti': 1.69,
            'burro': 2.29,
            'olio': 5.49,
            'zucchero': 1.19,
            'sale': 0.79,
            'acqua': 0.35,
            'vino': 6.49,
            'birra': 1.79,
            'carne': 11.99,
            'pollo': 7.99,
            'pesce': 13.99,
            'frutta': 3.19,
            'verdura': 2.79,
            'penne': 1.09,
            'spaghetti': 0.99,
            'lasagne': 3.19,
            'mozzarella': 2.79,
            'parmigiano': 11.99,
            'prosciutto': 14.99,
            'salame': 12.99,
            'tonno': 3.69,
            'salmone': 17.99,
            'banane': 1.79,
            'mele': 2.29,
            'arance': 2.09,
            'limoni': 1.59,
            'patate': 1.29,
            'cipolle': 1.09,
            'aglio': 2.79,
            'carote': 1.09,
            'insalata': 1.79,
            'pane integrale': 2.09,
            'pane bianco': 1.89,
            'latte intero': 1.49,
            'latte scremato': 1.49,
            'uova di gallina': 3.29,
            'pasta integrale': 1.39,
            'crackers': 2.29,
            'cereali': 3.79,
            'marmellata': 2.59,
            'miele': 4.79,
            'succo': 1.79,
            'succhi': 1.79,
            'aranciata': 1.39,
            'coca cola': 1.69,
            'coca-cola': 1.69,
            'pepsi': 1.59,
            'fanta': 1.39,
            'sprite': 1.39,
            'cioccolato': 2.79,
            'gelato': 4.79,
            'pizza surgelata': 3.29,
            'hamburger': 8.49,
            'salsiccia': 7.49,
            'wurstel': 3.79,
            'maionese': 2.29,
            'ketchup': 1.89,
            'senape': 1.69,
            'aceto': 2.09,
            'pepe': 3.29,
            'paprika': 2.79,
            'cannella': 4.79,
            'noce moscata': 5.29,
            'curry': 3.59,
            'zenzero': 4.09,
            'prezzemolo': 0.89,
            'basilico': 1.19,
            'rosmarino': 1.39,
            'salvia': 1.49,
            'timo': 1.39
        },
        'Tigre': {
            'pane': 1.79,
            'latte': 1.29,
            'uova': 2.79,
            'pasta': 0.79,
            'riso': 1.19,
            'pomodori': 2.29,
            'formaggio': 4.59,
            'yogurt': 1.99,
            'caff√®': 3.19,
            'biscotti': 1.59,
            'burro': 2.19,
            'olio': 5.29,
            'zucchero': 1.09,
            'sale': 0.69,
            'acqua': 0.29,
            'vino': 5.99,
            'birra': 1.59,
            'carne': 10.99,
            'pollo': 6.99,
            'pesce': 12.99,
            'frutta': 2.99,
            'verdura': 2.59,
            'penne': 0.99,
            'spaghetti': 0.89,
            'lasagne': 2.99,
            'mozzarella': 2.59,
            'parmigiano': 10.99,
            'prosciutto': 13.99,
            'salame': 11.99,
            'tonno': 3.49,
            'salmone': 16.99,
            'banane': 1.59,
            'mele': 2.09,
            'arance': 1.89,
            'limoni': 1.39,
            'patate': 1.19,
            'cipolle': 0.99,
            'aglio': 2.59,
            'carote': 0.99,
            'insalata': 1.59,
            'pane integrale': 1.89,
            'pane bianco': 1.79,
            'latte intero': 1.39,
            'latte scremato': 1.39,
            'uova di gallina': 3.09,
            'pasta integrale': 1.29,
            'crackers': 2.19,
            'cereali': 3.59,
            'marmellata': 2.39,
            'miele': 4.59,
            'succo': 1.69,
            'succhi': 1.69,
            'aranciata': 1.29,
            'coca cola': 1.59,
            'coca-cola': 1.59,
            'pepsi': 1.49,
            'fanta': 1.29,
            'sprite': 1.29,
            'cioccolato': 2.59,
            'gelato': 4.59,
            'pizza surgelata': 3.09,
            'hamburger': 7.99,
            'salsiccia': 6.99,
            'wurstel': 3.59,
            'maionese': 2.09,
            'ketchup': 1.79,
            'senape': 1.59,
            'aceto': 1.99,
            'pepe': 3.09,
            'paprika': 2.59,
            'cannella': 4.59,
            'noce moscata': 5.09,
            'curry': 3.39,
            'zenzero': 3.89,
            'prezzemolo': 0.79,
            'basilico': 1.09,
            'rosmarino': 1.29,
            'salvia': 1.39,
            'timo': 1.29
        }
    };

    // Store information - AGGIORNATO CON PI√ô PRODOTTI
    let stores = [
        { 
            name: 'Esselunga', 
            distance: '1.2 km', 
            items: ['pane', 'latte', 'uova', 'pasta', 'riso', 'pomodori', 'formaggio', 'yogurt', 'caff√®', 'biscotti', 'crackers', 'cereali', 'succo', 'aranciata', 'cioccolato'],
            rating: 4.2,
            type: 'supermercato'
        },
        { 
            name: 'Carrefour Express', 
            distance: '0.8 km', 
            items: ['pane', 'latte', 'uova', 'pasta', 'riso', 'pomodori', 'formaggio', 'yogurt', 'caff√®', 'biscotti', 'crackers', 'cereali', 'succo', 'aranciata', 'cioccolato'],
            rating: 3.9,
            type: 'supermercato'
        },
        { 
            name: 'Conad', 
            distance: '1.5 km', 
            items: ['pane', 'latte', 'uova', 'pasta', 'riso', 'pomodori', 'formaggio', 'yogurt', 'caff√®', 'biscotti', 'crackers', 'cereali', 'succo', 'aranciata', 'cioccolato'],
            rating: 4.0,
            type: 'supermercato'
        },
        { 
            name: 'Tigre', 
            distance: '2.1 km', 
            items: ['pane', 'latte', 'uova', 'pasta', 'riso', 'pomodori', 'formaggio', 'yogurt', 'caff√®', 'biscotti', 'crackers', 'cereali', 'succo', 'aranciata', 'cioccolato'],
            rating: 4.5,
            type: 'supermercato'
        },
        { 
            name: 'Panificio Rossi', 
            distance: '0.5 km', 
            items: ['pane', 'pane integrale', 'pane bianco', 'biscotti', 'crackers', 'cioccolato'],
            rating: 4.3,
            type: 'panificio'
        },
        { 
            name: 'Frutta & Verdura Mario', 
            distance: '0.7 km', 
            items: ['frutta', 'verdura', 'pomodori', 'patate', 'cipolle', 'aglio', 'carote', 'insalata', 'banane', 'mele', 'arance', 'limoni'],
            rating: 4.1,
            type: 'fruttivendolo'
        },
        { 
            name: 'Macelleria Bianchi', 
            distance: '1.1 km', 
            items: ['carne', 'pollo', 'hamburger', 'salsiccia', 'wurstel', 'prosciutto', 'salame'],
            rating: 4.4,
            type: 'macelleria'
        },
        { 
            name: 'Pescheria Azzurra', 
            distance: '1.8 km', 
            items: ['pesce', 'tonno', 'salmone'],
            rating: 4.2,
            type: 'pescheria'
        }
    ];

    // Funzione per aggiornare dinamicamente i prodotti nei negozi
    function updateStoreProducts() {
        // Raccoglie tutti i prodotti unici dalla lista della spesa
        const allProducts = [...new Set(shoppingList.map(item => item.name.toLowerCase()))];
        
        // Per ogni negozio, aggiunge i prodotti che non ha gi√†
        stores.forEach(store => {
            // Se √® un supermercato, aggiunge pi√π prodotti
            if (store.type === 'supermercato') {
                allProducts.forEach(product => {
                    if (!store.items.includes(product)) {
                        // Aggiungi se il prodotto ha senso per un supermercato
                        const commonProducts = ['pane', 'latte', 'uova', 'pasta', 'riso', 'formaggio', 'yogurt', 
                                              'caff√®', 'biscotti', 'crackers', 'cereali', 'succo', 'aranciata', 
                                              'cioccolato', 'gelato', 'pizza surgelata', 'maionese', 'ketchup'];
                        
                        if (commonProducts.some(cp => product.includes(cp) || cp.includes(product))) {
                            store.items.push(product);
                        }
                    }
                });
            }
            // Altrimenti, aggiunge solo prodotti pertinenti
            else if (store.type === 'panificio') {
                allProducts.forEach(product => {
                    if (product.includes('pane') || product.includes('biscotti') || 
                        product.includes('crackers') || product.includes('cioccolato')) {
                        if (!store.items.includes(product)) {
                            store.items.push(product);
                        }
                    }
                });
            }
            else if (store.type === 'fruttivendolo') {
                allProducts.forEach(product => {
                    if (product.includes('frutta') || product.includes('verdura') || 
                        product.includes('pomodori') || product.includes('patate') ||
                        product.includes('cipolle') || product.includes('aglio') ||
                        product.includes('carote') || product.includes('insalata') ||
                        product.includes('banane') || product.includes('mele') ||
                        product.includes('arance') || product.includes('limoni')) 
                        if (!store.items.includes(product)) {
                            store.items.push(product);
                        }
                    }
                });
            }
        });
    }

    // Ottimizzazione corrente
    let currentOptimization = null;
*/
    // ==================== SUGGERIMENTI PRODOTTI ====================
    // ==================== DIZIONARIO PRODOTTI MULTILINGUA ====================
const productDictionary = {
    // PANE E SIMILI
    'pane': { name: 'Pane', category: 'Panetteria', translations: { 'it': 'Pane', 'en': 'Bread', 'es': 'Pan', 'fr': 'Pain', 'de': 'Brot', 'ro': 'P√¢ine' } },
    'paine': { name: 'P√¢ine', category: 'Panetteria', translations: { 'it': 'Pane', 'en': 'Bread', 'es': 'Pan', 'fr': 'Pain', 'de': 'Brot', 'ro': 'P√¢ine' } },
    'bread': { name: 'Bread', category: 'Bakery', translations: { 'it': 'Pane', 'en': 'Bread', 'es': 'Pan', 'fr': 'Pain', 'de': 'Brot', 'ro': 'P√¢ine' } },
    'pan': { name: 'Pan', category: 'Panader√≠a', translations: { 'it': 'Pane', 'en': 'Bread', 'es': 'Pan', 'fr': 'Pain', 'de': 'Brot', 'ro': 'P√¢ine' } },
    'pain': { name: 'Pain', category: 'Boulangerie', translations: { 'it': 'Pane', 'en': 'Bread', 'es': 'Pan', 'fr': 'Pain', 'de': 'Brot', 'ro': 'P√¢ine' } },
    'brot': { name: 'Brot', category: 'B√§ckerei', translations: { 'it': 'Pane', 'en': 'Bread', 'es': 'Pan', 'fr': 'Pain', 'de': 'Brot', 'ro': 'P√¢ine' } },
    
    'pane integrale': { name: 'Pane Integrale', category: 'Panetteria', translations: { 'it': 'Pane Integrale', 'en': 'Whole Wheat Bread', 'es': 'Pan Integral', 'fr': 'Pain Complet', 'de': 'Vollkornbrot', 'ro': 'P√¢ine IntegralƒÉ' } },
    'whole wheat bread': { name: 'Whole Wheat Bread', category: 'Bakery', translations: { 'it': 'Pane Integrale', 'en': 'Whole Wheat Bread', 'es': 'Pan Integral', 'fr': 'Pain Complet', 'de': 'Vollkornbrot', 'ro': 'P√¢ine IntegralƒÉ' } },
    
    'pane bianco': { name: 'Pane Bianco', category: 'Panetteria', translations: { 'it': 'Pane Bianco', 'en': 'White Bread', 'es': 'Pan Blanco', 'fr': 'Pain Blanc', 'de': 'Wei√übrot', 'ro': 'P√¢ine AlbƒÉ' } },
    
    // LATTE E LATTICINI
    'latte': { name: 'Latte', category: 'Latticini', translations: { 'it': 'Latte', 'en': 'Milk', 'es': 'Leche', 'fr': 'Lait', 'de': 'Milch', 'ro': 'Lapte' } },
    'milk': { name: 'Milk', category: 'Dairy', translations: { 'it': 'Latte', 'en': 'Milk', 'es': 'Leche', 'fr': 'Lait', 'de': 'Milch', 'ro': 'Lapte' } },
    'leche': { name: 'Leche', category: 'L√°cteos', translations: { 'it': 'Latte', 'en': 'Milk', 'es': 'Leche', 'fr': 'Lait', 'de': 'Milch', 'ro': 'Lapte' } },
    'lait': { name: 'Lait', category: 'Produits laitiers', translations: { 'it': 'Latte', 'en': 'Milk', 'es': 'Leche', 'fr': 'Lait', 'de': 'Milch', 'ro': 'Lapte' } },
    'milch': { name: 'Milch', category: 'Molkereiprodukte', translations: { 'it': 'Latte', 'en': 'Milk', 'es': 'Leche', 'fr': 'Lait', 'de': 'Milch', 'ro': 'Lapte' } },
    'lapte': { name: 'Lapte', category: 'Lactate', translations: { 'it': 'Latte', 'en': 'Milk', 'es': 'Leche', 'fr': 'Lait', 'de': 'Milch', 'ro': 'Lapte' } },
    
    'latte intero': { name: 'Latte Intero', category: 'Latticini', translations: { 'it': 'Latte Intero', 'en': 'Whole Milk', 'es': 'Leche Entera', 'fr': 'Lait Entier', 'de': 'Vollmilch', 'ro': 'Lapte Integral' } },
    'latte scremato': { name: 'Latte Scremato', category: 'Latticini', translations: { 'it': 'Latte Scremato', 'en': 'Skim Milk', 'es': 'Leche Desnatada', 'fr': 'Lait √âcr√©m√©', 'de': 'Magermilch', 'ro': 'Lapte Degresat' } },
    
    'yogurt': { name: 'Yogurt', category: 'Latticini', translations: { 'it': 'Yogurt', 'en': 'Yogurt', 'es': 'Yogur', 'fr': 'Yaourt', 'de': 'Joghurt', 'ro': 'Iaurt' } },
    'yaourt': { name: 'Yaourt', category: 'Produits laitiers', translations: { 'it': 'Yogurt', 'en': 'Yogurt', 'es': 'Yogur', 'fr': 'Yaourt', 'de': 'Joghurt', 'ro': 'Iaurt' } },
    'joghurt': { name: 'Joghurt', category: 'Molkereiprodukte', translations: { 'it': 'Yogurt', 'en': 'Yogurt', 'es': 'Yogur', 'fr': 'Yaourt', 'de': 'Joghurt', 'ro': 'Iaurt' } },
    'iaurt': { name: 'Iaurt', category: 'Lactate', translations: { 'it': 'Yogurt', 'en': 'Yogurt', 'es': 'Yogur', 'fr': 'Yaourt', 'de': 'Joghurt', 'ro': 'Iaurt' } },
    
    'formaggio': { name: 'Formaggio', category: 'Latticini', translations: { 'it': 'Formaggio', 'en': 'Cheese', 'es': 'Queso', 'fr': 'Fromage', 'de': 'K√§se', 'ro': 'Br√¢nzƒÉ' } },
    'cheese': { name: 'Cheese', category: 'Dairy', translations: { 'it': 'Formaggio', 'en': 'Cheese', 'es': 'Queso', 'fr': 'Fromage', 'de': 'K√§se', 'ro': 'Br√¢nzƒÉ' } },
    'queso': { name: 'Queso', category: 'L√°cteos', translations: { 'it': 'Formaggio', 'en': 'Cheese', 'es': 'Queso', 'fr': 'Fromage', 'de': 'K√§se', 'ro': 'Br√¢nzƒÉ' } },
    'fromage': { name: 'Fromage', category: 'Produits laitiers', translations: { 'it': 'Formaggio', 'en': 'Cheese', 'es': 'Queso', 'fr': 'Fromage', 'de': 'K√§se', 'ro': 'Br√¢nzƒÉ' } },
    'k√§se': { name: 'K√§se', category: 'Molkereiprodukte', translations: { 'it': 'Formaggio', 'en': 'Cheese', 'es': 'Queso', 'fr': 'Fromage', 'de': 'K√§se', 'ro': 'Br√¢nzƒÉ' } },
    'branza': { name: 'Br√¢nzƒÉ', category: 'Lactate', translations: { 'it': 'Formaggio', 'en': 'Cheese', 'es': 'Queso', 'fr': 'Fromage', 'de': 'K√§se', 'ro': 'Br√¢nzƒÉ' } },
    
    'mozzarella': { name: 'Mozzarella', category: 'Latticini', translations: { 'it': 'Mozzarella', 'en': 'Mozzarella', 'es': 'Mozzarella', 'fr': 'Mozzarella', 'de': 'Mozzarella', 'ro': 'Mozzarella' } },
    'parmigiano': { name: 'Parmigiano', category: 'Latticini', translations: { 'it': 'Parmigiano', 'en': 'Parmesan', 'es': 'Parmesano', 'fr': 'Parmesan', 'de': 'Parmesan', 'ro': 'Parmezan' } },
    'parmesan': { name: 'Parmesan', category: 'Dairy', translations: { 'it': 'Parmigiano', 'en': 'Parmesan', 'es': 'Parmesano', 'fr': 'Parmesan', 'de': 'Parmesan', 'ro': 'Parmezan' } },
    
    'burro': { name: 'Burro', category: 'Latticini', translations: { 'it': 'Burro', 'en': 'Butter', 'es': 'Mantequilla', 'fr': 'Beurre', 'de': 'Butter', 'ro': 'Unt' } },
    'butter': { name: 'Butter', category: 'Dairy', translations: { 'it': 'Burro', 'en': 'Butter', 'es': 'Mantequilla', 'fr': 'Beurre', 'de': 'Butter', 'ro': 'Unt' } },
    'beurre': { name: 'Beurre', category: 'Produits laitiers', translations: { 'it': 'Burro', 'en': 'Butter', 'es': 'Mantequilla', 'fr': 'Beurre', 'de': 'Butter', 'ro': 'Unt' } },
    
    // UOVA
    'uova': { name: 'Uova', category: 'Uova', translations: { 'it': 'Uova', 'en': 'Eggs', 'es': 'Huevos', 'fr': '≈íufs', 'de': 'Eier', 'ro': 'OuƒÉ' } },
    'eggs': { name: 'Eggs', category: 'Eggs', translations: { 'it': 'Uova', 'en': 'Eggs', 'es': 'Huevos', 'fr': '≈íufs', 'de': 'Eier', 'ro': 'OuƒÉ' } },
    'huevos': { name: 'Huevos', category: 'Huevos', translations: { 'it': 'Uova', 'en': 'Eggs', 'es': 'Huevos', 'fr': '≈íufs', 'de': 'Eier', 'ro': 'OuƒÉ' } },
    'oeufs': { name: '≈íufs', category: '≈íufs', translations: { 'it': 'Uova', 'en': 'Eggs', 'es': 'Huevos', 'fr': '≈íufs', 'de': 'Eier', 'ro': 'OuƒÉ' } },
    'eier': { name: 'Eier', category: 'Eier', translations: { 'it': 'Uova', 'en': 'Eggs', 'es': 'Huevos', 'fr': '≈íufs', 'de': 'Eier', 'ro': 'OuƒÉ' } },
    'oua': { name: 'OuƒÉ', category: 'OuƒÉ', translations: { 'it': 'Uova', 'en': 'Eggs', 'es': 'Huevos', 'fr': '≈íufs', 'de': 'Eier', 'ro': 'OuƒÉ' } },
    
    'uova di gallina': { name: 'Uova di Gallina', category: 'Uova', translations: { 'it': 'Uova di Gallina', 'en': 'Hen Eggs', 'es': 'Huevos de Gallina', 'fr': '≈íufs de Poule', 'de': 'H√ºhnereier', 'ro': 'OuƒÉ de GƒÉinƒÉ' } },
    
    // PASTA E RISO
    'pasta': { name: 'Pasta', category: 'Pasta e Riso', translations: { 'it': 'Pasta', 'en': 'Pasta', 'es': 'Pasta', 'fr': 'P√¢tes', 'de': 'Nudeln', 'ro': 'PastƒÉ' } },
    'pates': { name: 'P√¢tes', category: 'P√¢tes et Riz', translations: { 'it': 'Pasta', 'en': 'Pasta', 'es': 'Pasta', 'fr': 'P√¢tes', 'de': 'Nudeln', 'ro': 'PastƒÉ' } },
    'nudeln': { name: 'Nudeln', category: 'Nudeln und Reis', translations: { 'it': 'Pasta', 'en': 'Pasta', 'es': 'Pasta', 'fr': 'P√¢tes', 'de': 'Nudeln', 'ro': 'PastƒÉ' } },
    
    'penne': { name: 'Penne', category: 'Pasta e Riso', translations: { 'it': 'Penne', 'en': 'Penne', 'es': 'Penne', 'fr': 'Pennes', 'de': 'Penne', 'ro': 'Penne' } },
    'spaghetti': { name: 'Spaghetti', category: 'Pasta e Riso', translations: { 'it': 'Spaghetti', 'en': 'Spaghetti', 'es': 'Espaguetis', 'fr': 'Spaghettis', 'de': 'Spaghetti', 'ro': 'Spaghete' } },
    'lasagne': { name: 'Lasagne', category: 'Pasta e Riso', translations: { 'it': 'Lasagne', 'en': 'Lasagna', 'es': 'Lasa√±a', 'fr': 'Lasagnes', 'de': 'Lasagne', 'ro': 'Lasagna' } },
    
    'riso': { name: 'Riso', category: 'Pasta e Riso', translations: { 'it': 'Riso', 'en': 'Rice', 'es': 'Arroz', 'fr': 'Riz', 'de': 'Reis', 'ro': 'Orez' } },
    'rice': { name: 'Rice', category: 'Pasta and Rice', translations: { 'it': 'Riso', 'en': 'Rice', 'es': 'Arroz', 'fr': 'Riz', 'de': 'Reis', 'ro': 'Orez' } },
    'arroz': { name: 'Arroz', category: 'Pastas y Arroces', translations: { 'it': 'Riso', 'en': 'Rice', 'es': 'Arroz', 'fr': 'Riz', 'de': 'Reis', 'ro': 'Orez' } },
    'riz': { name: 'Riz', category: 'P√¢tes et Riz', translations: { 'it': 'Riso', 'en': 'Rice', 'es': 'Arroz', 'fr': 'Riz', 'de': 'Reis', 'ro': 'Orez' } },
    'reis': { name: 'Reis', category: 'Nudeln und Reis', translations: { 'it': 'Riso', 'en': 'Rice', 'es': 'Arroz', 'fr': 'Riz', 'de': 'Reis', 'ro': 'Orez' } },
    'orez': { name: 'Orez', category: 'PastƒÉ »ôi Orez', translations: { 'it': 'Riso', 'en': 'Rice', 'es': 'Arroz', 'fr': 'Riz', 'de': 'Reis', 'ro': 'Orez' } },
    
    // CARNE
    'carne': { name: 'Carne', category: 'Carne', translations: { 'it': 'Carne', 'en': 'Meat', 'es': 'Carne', 'fr': 'Viande', 'de': 'Fleisch', 'ro': 'Carne' } },
    'meat': { name: 'Meat', category: 'Meat', translations: { 'it': 'Carne', 'en': 'Meat', 'es': 'Carne', 'fr': 'Viande', 'de': 'Fleisch', 'ro': 'Carne' } },
    'viande': { name: 'Viande', category: 'Viande', translations: { 'it': 'Carne', 'en': 'Meat', 'es': 'Carne', 'fr': 'Viande', 'de': 'Fleisch', 'ro': 'Carne' } },
    'fleisch': { name: 'Fleisch', category: 'Fleisch', translations: { 'it': 'Carne', 'en': 'Meat', 'es': 'Carne', 'fr': 'Viande', 'de': 'Fleisch', 'ro': 'Carne' } },
    
    'pollo': { name: 'Pollo', category: 'Carne', translations: { 'it': 'Pollo', 'en': 'Chicken', 'es': 'Pollo', 'fr': 'Poulet', 'de': 'H√§hnchen', 'ro': 'Pui' } },
    'chicken': { name: 'Chicken', category: 'Meat', translations: { 'it': 'Pollo', 'en': 'Chicken', 'es': 'Pollo', 'fr': 'Poulet', 'de': 'H√§hnchen', 'ro': 'Pui' } },
    'poulet': { name: 'Poulet', category: 'Viande', translations: { 'it': 'Pollo', 'en': 'Chicken', 'es': 'Pollo', 'fr': 'Poulet', 'de': 'H√§hnchen', 'ro': 'Pui' } },
    'h√§hnchen': { name: 'H√§hnchen', category: 'Fleisch', translations: { 'it': 'Pollo', 'en': 'Chicken', 'es': 'Pollo', 'fr': 'Poulet', 'de': 'H√§hnchen', 'ro': 'Pui' } },
    'pui': { name: 'Pui', category: 'Carne', translations: { 'it': 'Pollo', 'en': 'Chicken', 'es': 'Pollo', 'fr': 'Poulet', 'de': 'H√§hnchen', 'ro': 'Pui' } },
    
    'manzo': { name: 'Manzo', category: 'Carne', translations: { 'it': 'Manzo', 'en': 'Beef', 'es': 'Ternera', 'fr': 'B≈ìuf', 'de': 'Rindfleisch', 'ro': 'VitƒÉ' } },
    'beef': { name: 'Beef', category: 'Meat', translations: { 'it': 'Manzo', 'en': 'Beef', 'es': 'Ternera', 'fr': 'B≈ìuf', 'de': 'Rindfleisch', 'ro': 'VitƒÉ' } },
    'boeuf': { name: 'B≈ìuf', category: 'Viande', translations: { 'it': 'Manzo', 'en': 'Beef', 'es': 'Ternera', 'fr': 'B≈ìuf', 'de': 'Rindfleisch', 'ro': 'VitƒÉ' } },
    
    'maiale': { name: 'Maiale', category: 'Carne', translations: { 'it': 'Maiale', 'en': 'Pork', 'es': 'Cerdo', 'fr': 'Porc', 'de': 'Schweinefleisch', 'ro': 'Porc' } },
    'pork': { name: 'Pork', category: 'Meat', translations: { 'it': 'Maiale', 'en': 'Pork', 'es': 'Cerdo', 'fr': 'Porc', 'de': 'Schweinefleisch', 'ro': 'Porc' } },
    
    // PESCE
    'pesce': { name: 'Pesce', category: 'Pesce', translations: { 'it': 'Pesce', 'en': 'Fish', 'es': 'Pescado', 'fr': 'Poisson', 'de': 'Fisch', 'ro': 'Pe»ôte' } },
    'fish': { name: 'Fish', category: 'Fish', translations: { 'it': 'Pesce', 'en': 'Fish', 'es': 'Pescado', 'fr': 'Poisson', 'de': 'Fisch', 'ro': 'Pe»ôte' } },
    'pescado': { name: 'Pescado', category: 'Pescado', translations: { 'it': 'Pesce', 'en': 'Fish', 'es': 'Pescado', 'fr': 'Poisson', 'de': 'Fisch', 'ro': 'Pe»ôte' } },
    'poisson': { name: 'Poisson', category: 'Poisson', translations: { 'it': 'Pesce', 'en': 'Fish', 'es': 'Pescado', 'fr': 'Poisson', 'de': 'Fisch', 'ro': 'Pe»ôte' } },
    'fisch': { name: 'Fisch', category: 'Fisch', translations: { 'it': 'Pesce', 'en': 'Fish', 'es': 'Pescado', 'fr': 'Poisson', 'de': 'Fisch', 'ro': 'Pe»ôte' } },
    'peste': { name: 'Pe»ôte', category: 'Pe»ôte', translations: { 'it': 'Pesce', 'en': 'Fish', 'es': 'Pescado', 'fr': 'Poisson', 'de': 'Fisch', 'ro': 'Pe»ôte' } },
    
    'salmone': { name: 'Salmone', category: 'Pesce', translations: { 'it': 'Salmone', 'en': 'Salmon', 'es': 'Salm√≥n', 'fr': 'Saumon', 'de': 'Lachs', 'ro': 'Somon' } },
    'salmon': { name: 'Salmon', category: 'Fish', translations: { 'it': 'Salmone', 'en': 'Salmon', 'es': 'Salm√≥n', 'fr': 'Saumon', 'de': 'Lachs', 'ro': 'Somon' } },
    'somon': { name: 'Somon', category: 'Pe»ôte', translations: { 'it': 'Salmone', 'en': 'Salmon', 'es': 'Salm√≥n', 'fr': 'Saumon', 'de': 'Lachs', 'ro': 'Somon' } },
    
    'tonno': { name: 'Tonno', category: 'Pesce', translations: { 'it': 'Tonno', 'en': 'Tuna', 'es': 'At√∫n', 'fr': 'Thon', 'de': 'Thunfisch', 'ro': 'Ton' } },
    'tuna': { name: 'Tuna', category: 'Fish', translations: { 'it': 'Tonno', 'en': 'Tuna', 'es': 'At√∫n', 'fr': 'Thon', 'de': 'Thunfisch', 'ro': 'Ton' } },
    
    // FRUTTA E VERDURA
    'frutta': { name: 'Frutta', category: 'Frutta', translations: { 'it': 'Frutta', 'en': 'Fruit', 'es': 'Fruta', 'fr': 'Fruits', 'de': 'Obst', 'ro': 'Fructe' } },
    'fruit': { name: 'Fruit', category: 'Fruit', translations: { 'it': 'Frutta', 'en': 'Fruit', 'es': 'Fruta', 'fr': 'Fruits', 'de': 'Obst', 'ro': 'Fructe' } },
    'obst': { name: 'Obst', category: 'Obst', translations: { 'it': 'Frutta', 'en': 'Fruit', 'es': 'Fruta', 'fr': 'Fruits', 'de': 'Obst', 'ro': 'Fructe' } },
    
    'verdura': { name: 'Verdura', category: 'Verdura', translations: { 'it': 'Verdura', 'en': 'Vegetables', 'es': 'Verdura', 'fr': 'L√©gumes', 'de': 'Gem√ºse', 'ro': 'Legume' } },
    'vegetables': { name: 'Vegetables', category: 'Vegetables', translations: { 'it': 'Verdura', 'en': 'Vegetables', 'es': 'Verdura', 'fr': 'L√©gumes', 'de': 'Gem√ºse', 'ro': 'Legume' } },
    'legumes': { name: 'L√©gumes', category: 'L√©gumes', translations: { 'it': 'Verdura', 'en': 'Vegetables', 'es': 'Verdura', 'fr': 'L√©gumes', 'de': 'Gem√ºse', 'ro': 'Legume' } },
    'gem√ºse': { name: 'Gem√ºse', category: 'Gem√ºse', translations: { 'it': 'Verdura', 'en': 'Vegetables', 'es': 'Verdura', 'fr': 'L√©gumes', 'de': 'Gem√ºse', 'ro': 'Legume' } },
    
    'mele': { name: 'Mele', category: 'Frutta', translations: { 'it': 'Mele', 'en': 'Apples', 'es': 'Manzanas', 'fr': 'Pommes', 'de': '√Ñpfel', 'ro': 'Mere' } },
    'apples': { name: 'Apples', category: 'Fruit', translations: { 'it': 'Mele', 'en': 'Apples', 'es': 'Manzanas', 'fr': 'Pommes', 'de': '√Ñpfel', 'ro': 'Mere' } },
    'mere': { name: 'Mere', category: 'Fructe', translations: { 'it': 'Mele', 'en': 'Apples', 'es': 'Manzanas', 'fr': 'Pommes', 'de': '√Ñpfel', 'ro': 'Mere' } },
    
    'banane': { name: 'Banane', category: 'Frutta', translations: { 'it': 'Banane', 'en': 'Bananas', 'es': 'Pl√°tanos', 'fr': 'Bananes', 'de': 'Bananen', 'ro': 'Banane' } },
    'bananas': { name: 'Bananas', category: 'Fruit', translations: { 'it': 'Banane', 'en': 'Bananas', 'es': 'Pl√°tanos', 'fr': 'Bananes', 'de': 'Bananen', 'ro': 'Banane' } },
    
    'arance': { name: 'Arance', category: 'Frutta', translations: { 'it': 'Arance', 'en': 'Oranges', 'es': 'Naranjas', 'fr': 'Oranges', 'de': 'Orangen', 'ro': 'Portocale' } },
    'oranges': { name: 'Oranges', category: 'Fruit', translations: { 'it': 'Arance', 'en': 'Oranges', 'es': 'Naranjas', 'fr': 'Oranges', 'de': 'Orangen', 'ro': 'Portocale' } },
    
    'limoni': { name: 'Limoni', category: 'Frutta', translations: { 'it': 'Limoni', 'en': 'Lemons', 'es': 'Limones', 'fr': 'Citrons', 'de': 'Zitronen', 'ro': 'LƒÉm√¢i' } },
    
    'patate': { name: 'Patate', category: 'Verdura', translations: { 'it': 'Patate', 'en': 'Potatoes', 'es': 'Patatas', 'fr': 'Pommes de terre', 'de': 'Kartoffeln', 'ro': 'Cartofi' } },
    'potatoes': { name: 'Potatoes', category: 'Vegetables', translations: { 'it': 'Patate', 'en': 'Potatoes', 'es': 'Patatas', 'fr': 'Pommes de terre', 'de': 'Kartoffeln', 'ro': 'Cartofi' } },
    'kartoffeln': { name: 'Kartoffeln', category: 'Gem√ºse', translations: { 'it': 'Patate', 'en': 'Potatoes', 'es': 'Patatas', 'fr': 'Pommes de terre', 'de': 'Kartoffeln', 'ro': 'Cartofi' } },
    
    'pomodori': { name: 'Pomodori', category: 'Verdura', translations: { 'it': 'Pomodori', 'en': 'Tomatoes', 'es': 'Tomates', 'fr': 'Tomates', 'de': 'Tomaten', 'ro': 'Ro»ôii' } },
    'tomatoes': { name: 'Tomatoes', category: 'Vegetables', translations: { 'it': 'Pomodori', 'en': 'Tomatoes', 'es': 'Tomates', 'fr': 'Tomates', 'de': 'Tomaten', 'ro': 'Ro»ôii' } },
    'rosii': { name: 'Ro»ôii', category: 'Legume', translations: { 'it': 'Pomodori', 'en': 'Tomatoes', 'es': 'Tomates', 'fr': 'Tomates', 'de': 'Tomaten', 'ro': 'Ro»ôii' } },
    
    'cipolle': { name: 'Cipolle', category: 'Verdura', translations: { 'it': 'Cipolle', 'en': 'Onions', 'es': 'Cebollas', 'fr': 'Oignons', 'de': 'Zwiebeln', 'ro': 'CeapƒÉ' } },
    'onions': { name: 'Onions', category: 'Vegetables', translations: { 'it': 'Cipolle', 'en': 'Onions', 'es': 'Cebollas', 'fr': 'Oignons', 'de': 'Zwiebeln', 'ro': 'CeapƒÉ' } },
    
    'carote': { name: 'Carote', category: 'Verdura', translations: { 'it': 'Carote', 'en': 'Carrots', 'es': 'Zanahorias', 'fr': 'Carottes', 'de': 'Karotten', 'ro': 'Morcovi' } },
    'carrots': { name: 'Carrots', category: 'Vegetables', translations: { 'it': 'Carote', 'en': 'Carrots', 'es': 'Zanahorias', 'fr': 'Carottes', 'de': 'Karotten', 'ro': 'Morcovi' } },
    
    'insalata': { name: 'Insalata', category: 'Verdura', translations: { 'it': 'Insalata', 'en': 'Lettuce', 'es': 'Lechuga', 'fr': 'Salade', 'de': 'Salat', 'ro': 'SalatƒÉ' } },
    
    // BEVANDE
    'acqua': { name: 'Acqua', category: 'Bevande', translations: { 'it': 'Acqua', 'en': 'Water', 'es': 'Agua', 'fr': 'Eau', 'de': 'Wasser', 'ro': 'ApƒÉ' } },
    'water': { name: 'Water', category: 'Beverages', translations: { 'it': 'Acqua', 'en': 'Water', 'es': 'Agua', 'fr': 'Eau', 'de': 'Wasser', 'ro': 'ApƒÉ' } },
    'apa': { name: 'ApƒÉ', category: 'BƒÉuturi', translations: { 'it': 'Acqua', 'en': 'Water', 'es': 'Agua', 'fr': 'Eau', 'de': 'Wasser', 'ro': 'ApƒÉ' } },
    
    'caff√®': { name: 'Caff√®', category: 'Bevande', translations: { 'it': 'Caff√®', 'en': 'Coffee', 'es': 'Caf√©', 'fr': 'Caf√©', 'de': 'Kaffee', 'ro': 'Cafea' } },
    'caffe': { name: 'Caff√®', category: 'Bevande', translations: { 'it': 'Caff√®', 'en': 'Coffee', 'es': 'Caf√©', 'fr': 'Caf√©', 'de': 'Kaffee', 'ro': 'Cafea' } },
    'coffee': { name: 'Coffee', category: 'Beverages', translations: { 'it': 'Caff√®', 'en': 'Coffee', 'es': 'Caf√©', 'fr': 'Caf√©', 'de': 'Kaffee', 'ro': 'Cafea' } },
    'cafea': { name: 'Cafea', category: 'BƒÉuturi', translations: { 'it': 'Caff√®', 'en': 'Coffee', 'es': 'Caf√©', 'fr': 'Caf√©', 'de': 'Kaffee', 'ro': 'Cafea' } },
    
    'vino': { name: 'Vino', category: 'Bevande', translations: { 'it': 'Vino', 'en': 'Wine', 'es': 'Vino', 'fr': 'Vin', 'de': 'Wein', 'ro': 'Vin' } },
    'wine': { name: 'Wine', category: 'Beverages', translations: { 'it': 'Vino', 'en': 'Wine', 'es': 'Vino', 'fr': 'Vin', 'de': 'Wein', 'ro': 'Vin' } },
    
    'birra': { name: 'Birra', category: 'Bevande', translations: { 'it': 'Birra', 'en': 'Beer', 'es': 'Cerveza', 'fr': 'Bi√®re', 'de': 'Bier', 'ro': 'Bere' } },
    'beer': { name: 'Beer', category: 'Beverages', translations: { 'it': 'Birra', 'en': 'Beer', 'es': 'Cerveza', 'fr': 'Bi√®re', 'de': 'Bier', 'ro': 'Bere' } },
    'bere': { name: 'Bere', category: 'BƒÉuturi', translations: { 'it': 'Birra', 'en': 'Beer', 'es': 'Cerveza', 'fr': 'Bi√®re', 'de': 'Bier', 'ro': 'Bere' } },
    
    'succo': { name: 'Succo', category: 'Bevande', translations: { 'it': 'Succo', 'en': 'Juice', 'es': 'Zumo', 'fr': 'Jus', 'de': 'Saft', 'ro': 'Suc' } },
    'juice': { name: 'Juice', category: 'Beverages', translations: { 'it': 'Succo', 'en': 'Juice', 'es': 'Zumo', 'fr': 'Jus', 'de': 'Saft', 'ro': 'Suc' } },
    
    // DOLCI
    'cioccolato': { name: 'Cioccolato', category: 'Dolci', translations: { 'it': 'Cioccolato', 'en': 'Chocolate', 'es': 'Chocolate', 'fr': 'Chocolat', 'de': 'Schokolade', 'ro': 'CiocolatƒÉ' } },
    'chocolate': { name: 'Chocolate', category: 'Sweets', translations: { 'it': 'Cioccolato', 'en': 'Chocolate', 'es': 'Chocolate', 'fr': 'Chocolat', 'de': 'Schokolade', 'ro': 'CiocolatƒÉ' } },
    
    'biscotti': { name: 'Biscotti', category: 'Dolci', translations: { 'it': 'Biscotti', 'en': 'Cookies', 'es': 'Galletas', 'fr': 'Biscuits', 'de': 'Kekse', 'ro': 'Biscui»õi' } },
    'cookies': { name: 'Cookies', category: 'Sweets', translations: { 'it': 'Biscotti', 'en': 'Cookies', 'es': 'Galletas', 'fr': 'Biscuits', 'de': 'Kekse', 'ro': 'Biscui»õi' } },
    
    'gelato': { name: 'Gelato', category: 'Dolci', translations: { 'it': 'Gelato', 'en': 'Ice Cream', 'es': 'Helado', 'fr': 'Glace', 'de': 'Eis', 'ro': '√énghe»õatƒÉ' } },
    'ice cream': { name: 'Ice Cream', category: 'Sweets', translations: { 'it': 'Gelato', 'en': 'Ice Cream', 'es': 'Helado', 'fr': 'Glace', 'de': 'Eis', 'ro': '√énghe»õatƒÉ' } },
    'nutella': { name: 'Nutella', category: 'Dolci', translations: { 'it': 'Nutella', 'en': 'Nutella', 'es': 'Nutella', 'fr': 'Nutella', 'de': 'Nutella', 'ro': 'Nutella' } },
    
    'marmellata': { name: 'Marmellata', category: 'Dolci', translations: { 'it': 'Marmellata', 'en': 'Jam', 'es': 'Mermelada', 'fr': 'Confiture', 'de': 'Marmelade', 'ro': 'Gem' } },
    'miele': { name: 'Miele', category: 'Dolci', translations: { 'it': 'Miele', 'en': 'Honey', 'es': 'Miel', 'fr': 'Miel', 'de': 'Honig', 'ro': 'Miere' } }
};
window.productDictionary = productDictionary;


    // ==================== HELPER FUNCTIONS ====================
    function formatCurrency(amount) {
    // Gestisci valori null/undefined
    if (amount === null || amount === undefined || amount === '' || isNaN(amount)) {
        amount = 0;
    }
    
    const numAmount = parseFloat(amount);
    if (isNaN(numAmount)) {
        // Fallback sicuro
        return `${userProfile?.currencySymbol || '‚Ç¨'}0,00`;
    }
    
    const fixedAmount = numAmount.toFixed(2);
    const parts = fixedAmount.toString().split('.');
    let integerPart = parts[0];
    const decimalPart = parts[1] || '00';
    
    // Usa oggetto sicuro
    const profile = userProfile || { language: 'it', currencySymbol: '‚Ç¨' };
    let currencySymbol = profile.currencySymbol || '‚Ç¨';
    
    // Se il simbolo non esiste, cerca nel dizionario corretto
    if (!currencySymbol && profile.currency) {
        const currencyInfo = currencies[profile.currency];
        currencySymbol = currencyInfo?.symbol || '‚Ç¨';
    }
    
    // Formattazione
    if (profile.language === 'en' || profile.language === 'ro') {
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        return `${currencySymbol}${integerPart}.${decimalPart}`;
    } else {
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return `${currencySymbol}${integerPart},${decimalPart}`;
    }
}
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('it-IT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    }
    function updateCurrencyLabel() {
    // Ottieni la valuta dal profilo utente
    const currency = userProfile?.currency || 'EUR';
    const code = currency;
    
    // Trova l'etichetta dell'importo nella schermata entrate
    const amountLabel = document.querySelector('[data-translate="amount-with-currency"]');
    if (amountLabel) {
        const lang = userProfile?.language || 'it';
        
        // Testo in base alla lingua
        if (lang === 'ro') {
            amountLabel.textContent = `SumƒÉ (${code}) *`;
        } else if (lang === 'en') {
            amountLabel.textContent = `Amount (${code}) *`;
        } else if (lang === 'es') {
            amountLabel.textContent = `Importe (${code}) *`;
        } else if (lang === 'fr') {
            amountLabel.textContent = `Montant (${code}) *`;
        } else if (lang === 'de') {
            amountLabel.textContent = `Betrag (${code}) *`;
        } else {
            // Italiano (default)
            amountLabel.textContent = `Importo (${code}) *`;
        }
    }
    
    // Fai lo stesso per la schermata uscite se necessario
    const expenseAmountLabel = document.querySelector('#expense-amount + label, label[for="expense-amount"]');
    if (expenseAmountLabel) {
        const lang = userProfile?.language || 'it';
        if (lang === 'ro') {
            expenseAmountLabel.textContent = `SumƒÉ (${code}) *`;
        } else if (lang === 'en') {
            expenseAmountLabel.textContent = `Amount (${code}) *`;
        } else {
            expenseAmountLabel.textContent = `Importo (${code}) *`;
        }
    }
}

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg z-50';
        toast.textContent = message;
        toast.style.animation = 'fadeIn 0.3s';
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }

    function levenshteinDistance(a, b) {
        const matrix = [];
        
        for (let i = 0; i <= b.length; i++) {
            matrix[i] = [i];
        }
        
        for (let j = 0; j <= a.length; j++) {
            matrix[0][j] = j;
        }
        
        for (let i = 1; i <= b.length; i++) {
            for (let j = 1; j <= a.length; j++) {
                if (b.charAt(i - 1) === a.charAt(j - 1)) {
                    matrix[i][j] = matrix[i - 1][j - 1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j - 1] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j] + 1
                    );
                }
            }
        }
        
        return matrix[b.length][a.length];
    }
    window.levenshteinDistance = levenshteinDistance;  // üî• AGGIUNGI


    function findSuggestions(input) {
    const inputLower = input.toLowerCase().trim();
    const suggestions = [];
    const lang = userProfile?.language || 'it';
    
    // Controllo esatto
    if (productDictionary[inputLower]) {
        const product = productDictionary[inputLower];
        return [{
            original: input,
            corrected: product.translations[lang] || product.name,
            confidence: 100,
            reason: 'Prodotto riconosciuto'
        }];
    }
    
    // Ricerca per similarit√†
    for (const [key, product] of Object.entries(productDictionary)) {
        const distance = levenshteinDistance(inputLower, key);
        const maxLength = Math.max(inputLower.length, key.length);
        const similarity = 100 - (distance / maxLength) * 100;
        
        if (similarity > 70) {
            suggestions.push({
                key: key,
                name: product.translations[lang] || product.name,
                category: product.category,
                distance: distance,
                similarity: similarity
            });
        }
    }
    
    suggestions.sort((a, b) => b.similarity - a.similarity);
    
    return suggestions.slice(0, 3).map(s => ({
        original: input,
        corrected: s.name,
        confidence: Math.round(s.similarity),
        reason: `Simile a "${s.key}" (${s.category})`
    }));
}
window.findSuggestions = findSuggestions;


    function checkDuplicate(itemName) {
        const itemLower = itemName.toLowerCase().trim();
        return shoppingList.some(item => 
            item.name.toLowerCase() === itemLower && !item.checked
        );
    }

    function showProductSuggestionModal(input, suggestions, isDuplicate) {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    const modal = document.createElement('div');
    modal.id = 'product-suggestion-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = '';
    
    let modalContent = `
        <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-exclamation-triangle ${isDuplicate ? 'text-yellow-500' : 'text-blue-500'} mr-2"></i>
                    ${isDuplicate ? (t['duplicate-product'] || 'Prodotto Duplicato') : (t['check-product'] || 'Controlla il Prodotto')}
                </h3>
                
                <div class="mb-6">
                    <p class="text-gray-600 mb-2">${t['you-entered'] || 'Hai inserito'}:</p>
                    <div class="p-3 bg-gray-100 rounded-lg">
                        <p class="font-medium">"${input}"</p>
                    </div>
                </div>
    `;
    
    if (isDuplicate) {
        const existingItem = shoppingList.find(item => 
            item.name.toLowerCase() === input.toLowerCase().trim() && !item.checked
        );
        
        modalContent += `
            <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-yellow-500 mt-1 mr-3"></i>
                    <div>
                        <p class="font-medium text-yellow-800">${t['already-in-list'] || 'Questo prodotto √® gi√† nella lista!'}</p>
                        <p class="text-sm text-yellow-700 mt-1">
                            "${existingItem.name}" ${t['already-in-list'] || '√® gi√† nella lista'}
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <button onclick="addDuplicateProduct('${input.replace(/'/g, "\\'")}')" 
                        class="w-full p-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> ${t['add-anyway'] || 'Aggiungi comunque (duplicato)'}
                </button>
                <button onclick="closeSuggestionModal()" 
                        class="w-full p-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                    ${t['cancel'] || 'Annulla'}
                </button>
            </div>
        `;
    } else if (suggestions.length > 0) {
        modalContent += `
            <div class="mb-6">
                <p class="text-gray-600 mb-3">${t['perhaps-you-meant'] || 'Forse intendevi'}:</p>
                <div class="space-y-3">
        `;
        
        suggestions.forEach((suggestion, index) => {
            const confidenceColor = suggestion.confidence > 85 ? 'text-green-600' : 
                                   suggestion.confidence > 70 ? 'text-yellow-600' : 'text-blue-600';
            
            modalContent += `
                <button onclick="acceptSuggestion('${input.replace(/'/g, "\\'")}', '${suggestion.corrected.replace(/'/g, "\\'")}')" 
                        class="w-full p-4 border rounded-lg text-left hover:border-green-400 hover:bg-green-50 transition group">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold text-gray-800">${suggestion.corrected}</p>
                            <p class="text-sm text-gray-500 mt-1">${suggestion.reason}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs font-semibold ${confidenceColor}">${suggestion.confidence}%</span>
                            <i class="fas fa-chevron-right text-gray-400 group-hover:text-green-500 ml-2"></i>
                        </div>
                    </div>
                </button>
            `;
        });
        
        modalContent += `
                </div>
            </div>
            
            <div class="space-y-3">
                <button onclick="addAsIs('${input.replace(/'/g, "\\'")}')" 
                        class="w-full p-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 flex items-center justify-center gap-2">
                    <i class="fas fa-check"></i> ${(t['use-as-is'] || 'Usa "{product}" cos√¨ com\'√®').replace('{product}', input)}
                </button>
                <button onclick="closeSuggestionModal()" 
                        class="w-full p-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                    ${t['cancel'] || 'Annulla'}
                </button>
            </div>
        `;
    } else {
        modalContent += `
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                    <div>
                        <p class="font-medium text-blue-800">${t['product-not-recognized'] || 'Prodotto non riconosciuto'}</p>
                        <p class="text-sm text-blue-700 mt-1">
                            ${(t['not-in-database'] || '"{product}" non √® nel nostro database').replace('{product}', input)}
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <button onclick="addAsIs('${input.replace(/'/g, "\\'")}')" 
                        class="w-full p-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> ${(t['add-product'] || 'Aggiungi "{product}"').replace('{product}', input)}
                </button>
                <button onclick="closeSuggestionModal()" 
                        class="w-full p-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                    ${t['edit'] || 'Modifica'}
                </button>
            </div>
        `;
    }
    
    modalContent += `
                </div>
            </div>
        `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
}
window.findSuggestions = findSuggestions;


// üî¥ QUESTA DEVE ESSERE FUORI, NON DENTRO!
function closeSuggestionModal() {
    const modal = document.getElementById('product-suggestion-modal');
    if (modal) {
        document.body.removeChild(modal);
    }
}

async function addAsIs(productName) {
    closeSuggestionModal();
    
    // Mostra loader
    showToast('üîç Cerco il miglior prezzo...');
    
    // üî• MODIFICATO: usa getBestPrice invece di findBestPriceForItem
    const bestPrice = await getBestPrice(productName);
    
    shoppingList.push({
        id: Date.now(),
        name: productName,
        checked: false,
        bestPrice: bestPrice.price,
        bestStore: bestPrice.store,
        prices: [bestPrice],
        recognized: true,
        source: bestPrice.source,
        confidence: bestPrice.confidence
    });
    
    document.getElementById('shopping-item').value = '';
    // üî• AGGIUNTO: salva i dati
    saveAllData();
    renderShoppingList();
    
    const confidenceIcon = bestPrice.confidence > 0.8 ? '‚úÖ' : '‚ö†Ô∏è';
    showToast(`${confidenceIcon} ${productName} aggiunto - ${formatCurrency(bestPrice.price)} @ ${bestPrice.store}`);
        
        // Aggiorna i prodotti nei negozi quando aggiungi un nuovo prodotto
        updateStoreProducts();
    }

    function addDuplicateProduct(productName) {
        closeSuggestionModal();
        addShoppingItemInternal(productName, true);
    }

    async function addShoppingItemInternal(name, quantity = 1, selectedStore = null, forceAdd = false) {
    console.log('4Ô∏è‚É£ addShoppingItemInternal chiamata con', name, quantity, selectedStore);
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    const input = document.getElementById('shopping-item');
    console.log('üîç Input trovato:', input);
    console.log('üîç Valore prima:', input?.value);
    const itemName = name || input.value.trim();
    
    if (!itemName) {
        showToast(`‚ö†Ô∏è ${t['enter-item-name'] || 'Inserisci un nome per l\'articolo'}`);
        return;
    }
    
    if (!forceAdd && checkDuplicate(itemName)) {
        showProductSuggestionModal(itemName, [], true);
        return;
    }
    
    const suggestions = findSuggestions(itemName);
    console.log('üîç Suggerimenti per', itemName, ':', suggestions);

    // BLOCCA PAROLE NON RICONOSCIUTE
    if (suggestions.length === 0) {
        console.log('‚ùå Nessun suggerimento -> BLOCCATO');
        showToast(`‚ö†Ô∏è ${t['product-not-recognized-short'] || 'Prodotto non riconosciuto. Usa un nome valido.'}`);
        return;
    }

    if (suggestions[0].confidence < 60) {
        console.log('‚ö†Ô∏è Confidence bassa -> mostro modal con suggerimenti');
        showProductSuggestionModal(itemName, suggestions, false);
        return;
    }
    
    showToast(`üîç ${t['searching-best-price'] || 'Cerco il miglior prezzo...'}`);
    
    let bestPrice;
    if (selectedStore) {
        bestPrice = await getBestPrice(itemName, selectedStore);
    } else {
        bestPrice = await getBestPrice(itemName);
    }
    
    shoppingList.push({
        id: Date.now(),
        name: itemName,
        quantity: quantity,
        checked: false,
        bestPrice: bestPrice.price,
        bestStore: bestPrice.store,
        selectedStore: selectedStore || bestPrice.store,
        prices: [bestPrice],
        recognized: true,
        source: bestPrice.source,
        confidence: bestPrice.confidence
    });

    // SALVA I DATI
    saveAllData();
    
     // üî• FORZA LO SVUOTAMENTO
    if (input) {
        input.value = '';
        console.log('‚úÖ Dopo svuotamento, valore:', input.value);
    } else {
        console.log('‚ùå Input non trovato al momento dello svuotamento');
    }
    renderShoppingList();
    
    const confidenceIcon = bestPrice.confidence > 0.8 ? '‚úÖ' : '‚ö†Ô∏è';
    showToast(`${confidenceIcon} ${itemName} x${quantity} ${t['added'] || 'aggiunto'} - ${formatCurrency(bestPrice.price * quantity)} @ ${bestPrice.store}`);
}

    // ==================== SHOPPING PRICE FUNCTIONS ====================
    async function updateItemPrices() {
    for (const item of shoppingList) {
        if (!item.checked) {
            const bestPrice = await getBestPrice(item.name);
            item.bestPrice = bestPrice.price;
            item.bestStore = bestPrice.store;
            item.confidence = bestPrice.confidence;
            item.source = bestPrice.source;
        }
    }
    updateOptimizationPreview();
}

    function updateOptimizationPreview() {
        const itemsToBuy = shoppingList.filter(item => !item.checked);
        
        if (itemsToBuy.length === 0) {
            document.getElementById('lowest-price-total').textContent = '‚Ç¨0,00 / 0 negozi';
            document.getElementById('fewest-stores-count').textContent = '‚Ç¨0,00 / 0 negozi';
            document.getElementById('balanced-optimization').textContent = '‚Ç¨0,00 / 0 negozi';
            return;
        }

        const lowestPriceSolution = calculateLowestPriceSolution(itemsToBuy);
        document.getElementById('lowest-price-total').textContent = 
            `${formatCurrency(lowestPriceSolution.totalPrice)} / ${lowestPriceSolution.storeCount} negozi`;

        const fewestStoresSolution = calculateFewestStoresSolution(itemsToBuy);
        document.getElementById('fewest-stores-count').textContent = 
            `${formatCurrency(fewestStoresSolution.totalPrice)} / ${fewestStoresSolution.storeCount} negozi`;

        const balancedSolution = calculateBalancedSolution(itemsToBuy);
        document.getElementById('balanced-optimization').textContent = 
            `${formatCurrency(balancedSolution.totalPrice)} / ${balancedSolution.storeCount} negozi`;
    }

    function calculateLowestPriceSolution(items) {
    let totalPrice = 0;
    const storesUsed = new Set();
    
    items.forEach(item => {
        const quantity = item.quantity || 1;  // üî• USARE quantity
        totalPrice += (item.bestPrice || 0) * quantity;
        storesUsed.add(item.bestStore);
    });
    
    return {
        totalPrice: totalPrice,
        storeCount: storesUsed.size,
        stores: Array.from(storesUsed)
    };
}

function calculateFewestStoresSolution(items) {
    const storeProducts = {};
    
    // Mappa delle quantit√†
    const productQuantities = {};
    items.forEach(item => {
        productQuantities[item.name] = item.quantity || 1;
    });
    
    // üî• USA SOLO bestStore e bestPrice (niente item.prices)
    items.forEach(item => {
        const quantity = item.quantity || 1;
        
        // Considera solo negozi REALI (non "Prezzo stimato")
        if (item.bestStore && item.bestStore !== 'Prezzo stimato') {
            if (!storeProducts[item.bestStore]) {
                storeProducts[item.bestStore] = [];
            }
            storeProducts[item.bestStore].push({
                name: item.name,
                price: item.bestPrice || 0,
                quantity: quantity
            });
        }
    });
    
    const selectedStores = [];
    const coveredProducts = new Set();
    let totalPrice = 0;
    
    while (coveredProducts.size < items.length && Object.keys(storeProducts).length > 0) {
        let bestStore = null;
        let bestCoverage = 0;
        
        Object.entries(storeProducts).forEach(([storeName, products]) => {
            const newProducts = products.filter(p => !coveredProducts.has(p.name));
            if (newProducts.length > bestCoverage) {
                bestCoverage = newProducts.length;
                bestStore = storeName;
            }
        });
        
        if (bestStore) {
            selectedStores.push(bestStore);
            storeProducts[bestStore].forEach(product => {
                if (!coveredProducts.has(product.name)) {
                    coveredProducts.add(product.name);
                    totalPrice += product.price * product.quantity;
                }
            });
            delete storeProducts[bestStore];
        } else {
            break;
        }
    }
    
    return {
        totalPrice: totalPrice,
        storeCount: selectedStores.length,
        stores: selectedStores
    };
}

function calculateBalancedSolution(items) {
    if (items.length === 0) {
        return {
            totalPrice: 0,
            storeCount: 0,
            stores: []
        };
    }

    // üî• Mappa delle quantit√†
    const productQuantities = {};
    items.forEach(item => {
        productQuantities[item.name] = item.quantity || 1;
    });

    // üî• Raccogli SOLO i negozi REALI (escludi "Prezzo stimato")
    const allStores = new Set();
    items.forEach(item => {
        if (item.bestStore && item.bestStore !== 'Prezzo stimato') {
            allStores.add(item.bestStore);
        }
    });
    
    const storesArray = Array.from(allStores);
    
    // Se non ci sono negozi reali, usa lowest price
    if (storesArray.length === 0) {
        return calculateLowestPriceSolution(items);
    }
    
    let bestSolution = null;
    let bestScore = -Infinity;
    let bestTotalPrice = Infinity;
    
    const maxStores = Math.min(3, storesArray.length);
    
    for (let numStores = 1; numStores <= maxStores; numStores++) {
        const combinations = getStoreCombinationsArray(storesArray, numStores);
        
        for (const storeCombo of combinations) {
            // üî• Calcola direttamente senza usare calculateSolutionForStores
            let totalPrice = 0;
            const coveredProducts = new Set();
            const itemsByStore = {};
            
            storeCombo.forEach(store => {
                itemsByStore[store] = [];
            });
            
            items.forEach(item => {
                const quantity = item.quantity || 1;
                if (storeCombo.includes(item.bestStore)) {
                    coveredProducts.add(item.name);
                    const itemTotal = (item.bestPrice || 0) * quantity;
                    totalPrice += itemTotal;
                    
                    itemsByStore[item.bestStore].push({
                        name: item.name,
                        price: item.bestPrice,
                        quantity: quantity,
                        total: itemTotal
                    });
                }
            });
            
            const coverage = coveredProducts.size / items.length;
            
            // üî• Score: bilancia copertura, prezzo e numero negozi
            const storePenalty = storeCombo.length / maxStores;
            const priceFactor = 100 / (totalPrice + 1);
            const coverageFactor = coverage * 100;
            const storeFactor = (1 - storePenalty) * 50;
            const score = coverageFactor + priceFactor + storeFactor;
            
            // Costruisci la soluzione
            const solution = {
                totalPrice: totalPrice,
                storeCount: storeCombo.length,
                stores: storeCombo,
                coverage: coverage,
                items: Array.from(coveredProducts).map(name => {
                    const item = items.find(i => i.name === name);
                    return {
                        name: name,
                        store: item.bestStore,
                        price: item.bestPrice,
                        quantity: item.quantity || 1
                    };
                }),
                itemsByStore: itemsByStore
            };
            
            // Aggiorna la miglior soluzione
            if (coverage > 0.99) { // Soluzione che copre tutti i prodotti
                if (!bestSolution || 
                    bestSolution.coverage < 0.99 ||
                    storeCombo.length < bestSolution.storeCount ||
                    (storeCombo.length === bestSolution.storeCount && totalPrice < bestTotalPrice)) {
                    
                    bestScore = score;
                    bestTotalPrice = totalPrice;
                    bestSolution = solution;
                }
            } else if (!bestSolution || 
                      coverage > bestSolution.coverage || 
                      (coverage === bestSolution.coverage && totalPrice < bestTotalPrice)) {
                
                bestScore = score;
                bestTotalPrice = totalPrice;
                bestSolution = solution;
            }
        }
    }
    
    // Fallback
    if (!bestSolution || bestSolution.coverage < 0.7) {
        return calculateLowestPriceSolution(items);
    }
    
    return bestSolution;
}

    // ==================== OPTIMIZATION ALGORITHMS ====================
    function optimizeLowestPrice() {
    const itemsToBuy = shoppingList.filter(item => !item.checked);
    
    if (itemsToBuy.length === 0) {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        showToast(`‚ö†Ô∏è ${t['empty-list-warning'] || 'La lista della spesa √® vuota'}`);
        return;
    }

    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);

    const solution = {
        name: t['lowest-price'] || 'Prezzo pi√π basso',
        description: t['min-total-desc'] || 'Ogni prodotto acquistato al prezzo minimo disponibile',
        totalPrice: 0,
        stores: new Set(),
        itemsByStore: {},
        items: []
    };

    itemsToBuy.forEach(item => {
        solution.totalPrice += item.bestPrice;
        solution.stores.add(item.bestStore);
        
        if (!solution.itemsByStore[item.bestStore]) {
            solution.itemsByStore[item.bestStore] = [];
        }
        solution.itemsByStore[item.bestStore].push({
            name: item.name,
            price: item.bestPrice
        });
        
        solution.items.push({
            name: item.name,
            store: item.bestStore,
            price: item.bestPrice
        });
    });

    solution.stores = Array.from(solution.stores);
    currentOptimization = solution;
    showOptimizationResults(solution);
}

// ==================== FUNZIONE OTTIMIZZAZIONE "MENO NEGOZI" ====================
function optimizeFewestStores() {
    const itemsToBuy = shoppingList.filter(item => !item.checked);
    
    if (itemsToBuy.length === 0) {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        showToast(`‚ö†Ô∏è ${t['empty-list-warning'] || 'La lista della spesa √® vuota'}`);
        return;
    }

    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);

    // Raccogli i negozi con i loro prodotti
    const storeProducts = {};
    itemsToBuy.forEach(item => {
        if (item.bestStore && item.bestStore !== 'Prezzo stimato') {
            if (!storeProducts[item.bestStore]) {
                storeProducts[item.bestStore] = [];
            }
            storeProducts[item.bestStore].push({
                name: item.name,
                price: item.bestPrice,
                itemId: item.id,
                quantity: item.quantity || 1
            });
        }
    });

    const selectedStores = [];
    const coveredItems = new Set();
    let totalPrice = 0;

    // Seleziona greedy i negozi che coprono pi√π prodotti
    while (coveredItems.size < itemsToBuy.length && Object.keys(storeProducts).length > 0) {
        let bestStore = null;
        let bestProducts = [];
        let bestStorePrice = 0;
        
        Object.entries(storeProducts).forEach(([storeName, products]) => {
            const newProducts = products.filter(p => !coveredItems.has(p.itemId));
            if (newProducts.length > bestProducts.length) {
                bestStore = storeName;
                bestProducts = newProducts;
                bestStorePrice = products.reduce((sum, p) => sum + (p.price * p.quantity), 0);
            }
        });
        
        if (bestStore && bestProducts.length > 0) {
            selectedStores.push({
                name: bestStore,
                products: bestProducts,
                totalPrice: bestStorePrice
            });
            
            bestProducts.forEach(product => {
                coveredItems.add(product.itemId);
                totalPrice += product.price * product.quantity;
            });
            
            delete storeProducts[bestStore];
        } else {
            break;
        }
    }

    // Costruisci la soluzione
    const solution = {
        name: t['fewest-stores'] || 'Meno negozi',
        description: t['fewer-stores-desc'] || 'Visita meno punti vendita possibile',
        totalPrice: totalPrice,
        stores: selectedStores.map(s => s.name),
        itemsByStore: {},
        items: []
    };

    selectedStores.forEach(store => {
        solution.itemsByStore[store.name] = store.products;
        store.products.forEach(product => {
            solution.items.push({
                name: product.name,
                store: store.name,
                price: product.price,
                quantity: product.quantity
            });
        });
    });

    currentOptimization = solution;
    showOptimizationResults(solution);
}
function optimizeBalanced() {
    const itemsToBuy = shoppingList.filter(item => !item.checked);
    
    if (itemsToBuy.length === 0) {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        showToast(`‚ö†Ô∏è ${t['empty-list-warning'] || 'La lista della spesa √® vuota'}`);
        return;
    }

    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);

    // Raccogli i negozi REALI
    const allStores = new Set();
    itemsToBuy.forEach(item => {
        if (item.bestStore && item.bestStore !== 'Prezzo stimato') {
            allStores.add(item.bestStore);
        }
    });
    
    const storesArray = Array.from(allStores);
    
    if (storesArray.length === 0) {
        optimizeLowestPrice();
        return;
    }
    
    let bestSolution = null;
    let bestCoverage = 0;
    let bestTotalPrice = Infinity;
    let bestStores = [];
    
    const maxStores = Math.min(storesArray.length, 4);
    
    for (let numStores = 1; numStores <= maxStores; numStores++) {
        const combinations = getStoreCombinationsArray(storesArray, numStores);
        
        for (const storeCombo of combinations) {
            let totalPrice = 0;
            const coveredProducts = [];
            const itemsByStore = {};
            
            storeCombo.forEach(store => {
                itemsByStore[store] = [];
            });
            
            itemsToBuy.forEach(item => {
                const quantity = item.quantity || 1;
                if (storeCombo.includes(item.bestStore)) {
                    const itemTotal = (item.bestPrice || 0) * quantity;
                    totalPrice += itemTotal;
                    coveredProducts.push({
                        name: item.name,
                        store: item.bestStore,
                        price: item.bestPrice,
                        quantity: quantity,
                        total: itemTotal
                    });
                    
                    itemsByStore[item.bestStore].push({
                        name: item.name,
                        price: item.bestPrice,
                        quantity: quantity,
                        total: itemTotal
                    });
                }
            });
            
            const coverage = coveredProducts.length / itemsToBuy.length;
            
            if (coverage > bestCoverage) {
                bestCoverage = coverage;
                bestTotalPrice = totalPrice;
                bestStores = storeCombo;
                
                bestSolution = {
                    name: t['optimized'] || 'Ottimizzato',
                    description: coverage === 1 ? 
                        (t['price-stores-balanced-desc'] || 'Prezzo e negozi bilanciati') : 
                        `${t['covers'] || 'Copre'} ${coveredProducts.length} ${t['of'] || 'di'} ${itemsToBuy.length} ${t['products'] || 'prodotti'}`,
                    totalPrice: totalPrice,
                    storeCount: storeCombo.length,
                    stores: storeCombo,
                    items: coveredProducts,
                    itemsByStore: itemsByStore
                };
            } else if (coverage === bestCoverage) {
                if (storeCombo.length < bestStores.length || 
                    (storeCombo.length === bestStores.length && totalPrice < bestTotalPrice)) {
                    bestTotalPrice = totalPrice;
                    bestStores = storeCombo;
                    
                    bestSolution = {
                        name: t['optimized'] || 'Ottimizzato',
                        description: coverage === 1 ? 
                            (t['price-stores-balanced-desc'] || 'Prezzo e negozi bilanciati') : 
                            `${t['covers'] || 'Copre'} ${coveredProducts.length} ${t['of'] || 'di'} ${itemsToBuy.length} ${t['products'] || 'prodotti'}`,
                        totalPrice: totalPrice,
                        storeCount: storeCombo.length,
                        stores: storeCombo,
                        items: coveredProducts,
                        itemsByStore: itemsByStore
                    };
                }
            }
        }
    }
    
    if (!bestSolution || bestCoverage < 0.9) {
        optimizeLowestPrice();
        return;
    }
    
    currentOptimization = bestSolution;
    showOptimizationResults(bestSolution);
}

    function getStoreCombinationsArray(arr, k) {
        const result = [];
        
        function backtrack(start, current) {
            if (current.length === k) {
                result.push([...current]);
                return;
            }
            
            for (let i = start; i < arr.length; i++) {
                current.push(arr[i]);
                backtrack(i + 1, current);
                current.pop();
            }
        }
        
        backtrack(0, []);
        return result;
    }

    function calculateSolutionForStores(storeCombo, items) {
    const solution = {
        totalPrice: 0,
        itemsByStore: {},
        items: []
    };
    
    storeCombo.forEach(store => {
        solution.itemsByStore[store] = [];
    });
    
    items.forEach(item => {
        let bestPrice = Infinity;
        let bestStore = null;
        const quantity = item.quantity || 1;
        
        if (item.prices && item.prices.length > 0) {
            item.prices.forEach(price => {
                if (storeCombo.includes(price.store) && price.price < bestPrice) {
                    bestPrice = price.price;
                    bestStore = price.store;
                }
            });
        } else if (item.bestStore && storeCombo.includes(item.bestStore)) {
            bestPrice = item.bestPrice || 0;
            bestStore = item.bestStore;
        }
        
        if (bestStore && bestPrice < Infinity) {
            const itemTotal = bestPrice * quantity;
            solution.totalPrice += itemTotal;
            solution.itemsByStore[bestStore].push({
                name: item.name,
                price: bestPrice,
                quantity: quantity,
                total: itemTotal
            });
            solution.items.push({
                name: item.name,
                store: bestStore,
                price: bestPrice,
                quantity: quantity,
                total: itemTotal
            });
        }
    });
    
    return solution;
}

function showOptimizationResults(solution) {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    document.getElementById('optimization-title').textContent = solution.name;
    document.getElementById('opt-total-price').textContent = formatCurrency(solution.totalPrice);
    document.getElementById('opt-store-count').textContent = solution.stores.length;
    
    const detailsContainer = document.getElementById('optimization-details');
    detailsContainer.innerHTML = '';
    
    const totalItems = shoppingList.filter(item => !item.checked).length;
    const totalProducts = shoppingList
        .filter(item => !item.checked)
        .reduce((sum, item) => sum + (item.quantity || 1), 0);
    
    detailsContainer.innerHTML += `
        <div class="p-3 bg-white rounded-lg mb-3">
            <p class="text-sm text-gray-600">${solution.description}</p>
            <p class="text-xs text-gray-500 mt-1">
                <i class="fas fa-info-circle mr-1"></i>
                ${solution.items.length} ${t['products'] || 'prodotti'} ${t['covered'] || 'coperti'} su ${totalItems}
                (${solution.items.reduce((sum, i) => sum + (i.quantity || 1), 0)} ${t['units'] || 'unit√†'} totali)
            </p>
        </div>
    `;
    
    if (solution.stores && solution.stores.length > 0) {
        solution.stores.forEach(storeName => {
            const storeItems = [];
            let storeTotal = 0;
            
            if (solution.itemsByStore && solution.itemsByStore[storeName]) {
                solution.itemsByStore[storeName].forEach(item => {
                    const quantity = item.quantity || 1;
                    const itemTotal = item.price * quantity;
                    storeItems.push({
                        name: item.name,
                        price: item.price,
                        quantity: quantity,
                        total: itemTotal
                    });
                    storeTotal += itemTotal;
                });
            } else {
                solution.items.forEach(item => {
                    if (item.store === storeName) {
                        const quantity = item.quantity || 1;
                        const itemTotal = item.price * quantity;
                        storeItems.push({
                            name: item.name,
                            price: item.price,
                            quantity: quantity,
                            total: itemTotal
                        });
                        storeTotal += itemTotal;
                    }
                });
            }
            
            if (storeItems.length > 0) {
                const storeHTML = `
                    <div class="p-3 bg-white rounded-lg border mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2">
                                <p class="font-semibold">${storeName}</p>
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                    ${storeItems.length} ${t['products'] || 'prodotti'} 
                                    (${storeItems.reduce((sum, i) => sum + i.quantity, 0)} ${t['units'] || 'unit√†'})
                                </span>
                            </div>
                            <p class="font-bold text-green-600">${formatCurrency(storeTotal)}</p>
                        </div>
                        <div class="space-y-2">
                            ${storeItems.map(item => `
                                <div class="flex justify-between text-sm items-center">
                                    <span>${item.name} ${item.quantity > 1 ? `x${item.quantity}` : ''}</span>
                                    <span class="text-gray-600">${formatCurrency(item.total)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-2 pt-2 border-t text-xs text-gray-500">
                            ${t['store-total'] || 'Totale negozio'}: ${formatCurrency(storeTotal)}
                        </div>
                    </div>
                `;
                detailsContainer.innerHTML += storeHTML;
            }
        });
    }
    
    const allItemsInList = shoppingList.filter(item => !item.checked).map(item => item.name);
    const coveredItems = solution.items.map(item => item.name);
    const missingItems = allItemsInList.filter(item => !coveredItems.includes(item));
    
    if (missingItems.length > 0) {
        const missingHTML = `
            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    <p class="font-semibold text-yellow-800">${t['attention'] || 'Attenzione'}: ${t['missing-products'] || 'prodotti mancanti'}</p>
                </div>
                <p class="text-sm text-yellow-700">
                    ${missingItems.length} ${t['products'] || 'prodotti'} ${t['not-covered'] || 'non sono coperti da questa soluzione'}:
                    <span class="font-medium">${missingItems.join(', ')}</span>
                </p>
                <p class="text-xs text-yellow-600 mt-1">
                    ${t['not-available'] || 'Questi prodotti non sono disponibili nei negozi selezionati'}
                </p>
            </div>
        `;
        detailsContainer.innerHTML += missingHTML;
    }
    
    const hasEstimatedPrices = solution.items.some(item => 
        item.store === 'Prezzo stimato' || item.source === 'estimate'
    );
    
    if (hasEstimatedPrices) {
        detailsContainer.innerHTML += `
            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg mt-3">
                <div class="flex items-start gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-500 mt-1"></i>
                    <div>
                        <p class="font-semibold text-yellow-800">${t['estimated-prices'] || 'Prezzi stimati'}</p>
                        <p class="text-sm text-yellow-700">
                            ${t['estimated-warning'] || 'Alcuni prezzi sono stimati. Per un\'ottimizzazione accurata, correggi i prezzi manualmente.'}
                        </p>
                    </div>
                </div>
            </div>
        `;
    }
    
    const summaryHTML = `
        <div class="grid grid-cols-2 gap-2 mt-4">
            <div class="p-2 bg-green-50 rounded text-center">
                <p class="text-xs text-gray-600">${t['total-price'] || 'Prezzo Totale'}</p>
                <p class="font-bold text-green-600">${formatCurrency(solution.totalPrice)}</p>
            </div>
            <div class="p-2 bg-blue-50 rounded text-center">
                <p class="text-xs text-gray-600">${t['stores'] || 'Negozi'}</p>
                <p class="font-bold text-blue-600">${solution.stores.length}</p>
            </div>
        </div>
    `;
    detailsContainer.innerHTML += summaryHTML;
    
    document.getElementById('optimization-results').classList.remove('hidden');
}
    // ==================== SCREEN MANAGEMENT ====================
    function showScreen(screenName) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    
    document.getElementById(`screen-${screenName}`).classList.add('active');

    if (screenName === 'add-income' || screenName === 'add-expense') {
        setTimeout(fixAmountLabel, 100);
    }
    
    if (screenName === 'dashboard') {
        updateDashboard();
    } else if (screenName === 'shopping') {
        renderShoppingList();
        setTimeout(() => {
            renderNearbyStores();
        }, 100);
    } else if (screenName === 'budget') {
        renderBudget();
    } else if (screenName === 'transactions') {
        renderAllTransactions();
    } else if (screenName === 'profile') {
        loadProfileToForm();
    } else if (screenName === 'reports') {
        // Aspetta che la schermata sia attiva
        setTimeout(() => {
            // Traduci i titoli statici usando il sistema di traduzione
            const lang = userProfile?.language || 'it';
            const t = getTranslations(lang);
            
            const categoryTitle = document.querySelector('[data-translate="expenses-by-category"]');
            if (categoryTitle) categoryTitle.textContent = t['expenses-by-category'] || 'Spese per Categoria';
            
            const storeTitle = document.querySelector('[data-translate="expenses-by-store"]');
            if (storeTitle) storeTitle.textContent = t['expenses-by-store'] || 'Spese per Negozio';
            
            const trendTitle = document.querySelector('[data-translate="monthly-trend"]');
            if (trendTitle) trendTitle.textContent = t['monthly-trend'] || 'Andamento Mensile';
            
            // Poi popola i dati
            renderReports();
        }, 100);
    }
}
    function askExpenseType() {
        showScreen('expense-choice');
    }
// ==================== SCELTA TIPO TRANSAZIONE ====================
function askTransactionType() {
    // Crea un modal per scegliere il tipo di transazione
    const modal = document.createElement('div');
    modal.id = 'transaction-type-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = '';
    
    // Ottieni le traduzioni corrette in base alla lingua
    const lang = userProfile?.language || 'it';
    
    const translations = {
        'it': {
            'title': 'Aggiungi Transazione',
            'income': 'Entrata',
            'expense': 'Uscita',
            'income-desc': 'Stipendio, vendite, investimenti...',
            'expense-desc': 'Spese, acquisti, bollette...',
            'cancel': 'Annulla'
        },
        'en': {
            'title': 'Add Transaction',
            'income': 'Income',
            'expense': 'Expense',
            'income-desc': 'Salary, sales, investments...',
            'expense-desc': 'Expenses, purchases, bills...',
            'cancel': 'Cancel'
        },
        'es': {
            'title': 'A√±adir Transacci√≥n',
            'income': 'Ingreso',
            'expense': 'Gasto',
            'income-desc': 'Salario, ventas, inversiones...',
            'expense-desc': 'Gastos, compras, facturas...',
            'cancel': 'Cancelar'
        },
        'fr': {
            'title': 'Ajouter Transaction',
            'income': 'Revenu',
            'expense': 'D√©pense',
            'income-desc': 'Salaire, ventes, investissements...',
            'expense-desc': 'D√©penses, achats, factures...',
            'cancel': 'Annuler'
        },
        'de': {
            'title': 'Transaktion Hinzuf√ºgen',
            'income': 'Einnahme',
            'expense': 'Ausgabe',
            'income-desc': 'Gehalt, Verk√§ufe, Investitionen...',
            'expense-desc': 'Ausgaben, Eink√§ufe, Rechnungen...',
            'cancel': 'Abbrechen'
        },
        'ro': {
            'title': 'AdƒÉugƒÉ Tranzac»õie',
            'income': 'Venit',
            'expense': 'CheltuialƒÉ',
            'income-desc': 'Salariu, v√¢nzƒÉri, investi»õii...',
            'expense-desc': 'Cheltuieli, achizi»õii, facturi...',
            'cancel': 'AnuleazƒÉ'
        }
    };
    
    const t = translations[lang] || translations['it'];
    
    const modalContent = `
        <div class="bg-white rounded-xl shadow-lg max-w-md w-full">
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-exchange-alt mr-2"></i>${t['title']}
                </h3>
                
                <div class="space-y-4 mb-6">
                    <button onclick="closeTransactionTypeModal(); showScreen('add-income')" 
                            class="w-full p-5 border-2 border-dashed border-green-300 rounded-xl text-left hover:border-green-500 hover:bg-green-50 transition group">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center group-hover:bg-green-200">
                                <i class="fas fa-money-bill-wave text-green-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">${t['income']}</p>
                                <p class="text-sm text-gray-500">${t['income-desc']}</p>
                            </div>
                            <div class="ml-auto">
                                <i class="fas fa-chevron-right text-gray-400 group-hover:text-green-500"></i>
                            </div>
                        </div>
                    </button>
                    
                    <button onclick="closeTransactionTypeModal(); showScreen('expense-choice')" 
                            class="w-full p-5 border-2 border-dashed border-red-300 rounded-xl text-left hover:border-red-500 hover:bg-red-50 transition group">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center group-hover:bg-red-200">
                                <i class="fas fa-shopping-cart text-red-500 text-xl"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">${t['expense']}</p>
                                <p class="text-sm text-gray-500">${t['expense-desc']}</p>
                            </div>
                            <div class="ml-auto">
                                <i class="fas fa-chevron-right text-gray-400 group-hover:text-red-500"></i>
                            </div>
                        </div>
                    </button>
                </div>
                
                <button onclick="closeTransactionTypeModal()" 
                        class="w-full py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                    ${t['cancel']}
                </button>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
}

// Funzione per chiudere il modal
function closeTransactionTypeModal() {
    const modal = document.getElementById('transaction-type-modal');
    if (modal) {
        document.body.removeChild(modal);
    }
}
    // ==================== DASHBOARD FUNCTIONS ====================
    function updateDashboard() {
        const totalIncome = transactions
            .filter(t => t.type === 'entrata')
            .reduce((sum, t) => sum + t.amount, 0);
        
        const totalExpenses = transactions
            .filter(t => t.type === 'uscita')
            .reduce((sum, t) => sum + t.amount, 0);
        
        const balance = totalIncome - totalExpenses;
        const totalBudget = Object.values(budget).reduce((a, b) => a + b, 0);
        
        document.getElementById('dashboard-income').textContent = formatCurrency(totalIncome);
        document.getElementById('dashboard-expenses').textContent = formatCurrency(totalExpenses);
        document.getElementById('dashboard-balance').textContent = formatCurrency(balance);
        document.getElementById('dashboard-budget').textContent = formatCurrency(totalBudget);
        
        const uncheckedItems = shoppingList.filter(item => !item.checked).length;
const shoppingCountEl = document.getElementById('shopping-count');
if (shoppingCountEl) {
    // Ottieni la parola corretta per "articoli" in base alla lingua
    const itemsText = userProfile?.language === 'en' ? 'items' :
                     userProfile?.language === 'es' ? 'art√≠culos' :
                     userProfile?.language === 'fr' ? 'articles' :
                     userProfile?.language === 'de' ? 'Artikel' :
                     userProfile?.language === 'ro' ? 'articole' :
                     'articoli';
    shoppingCountEl.textContent = `${uncheckedItems} ${itemsText}`;
}
        
        const alertDiv = document.getElementById('budgetAlert');
        if (totalBudget > totalIncome) {
            alertDiv.classList.remove('hidden');
        } else {
            alertDiv.classList.add('hidden');
        }
        
        renderRecentTransactions();
    }

    function renderRecentTransactions() {
    const container = document.getElementById('recent-transactions');
    container.innerHTML = '';
    
    const recent = [...transactions]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3);
    
    if (recent.length === 0) {
        // Usa le traduzioni dal sistema di lingua
        const noTransactionsText = userProfile?.language === 'en' ? 'No transactions' :
                                 userProfile?.language === 'es' ? 'Sin transacciones' :
                                 userProfile?.language === 'fr' ? 'Aucune transaction' :
                                 userProfile?.language === 'de' ? 'Keine Transaktionen' :
                                 userProfile?.language === 'ro' ? 'FƒÉrƒÉ tranzac»õii' :
                                 'Nessuna transazione';
        container.innerHTML = `<p class="text-gray-500 text-center py-2">${noTransactionsText}</p>`;
        return;
    }
    
    recent.forEach(trans => {
        const isIncome = trans.type === 'entrata';
        const transactionHTML = `
            <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full ${isIncome ? 'bg-green-100' : 'bg-red-100'} flex items-center justify-center">
                        <i class="fas ${isIncome ? 'fa-arrow-down' : 'fa-arrow-up'} ${isIncome ? 'text-green-500' : 'text-red-500'}"></i>
                    </div>
                    <div>
                        <p class="font-medium">${trans.description}</p>
                        <p class="text-sm text-gray-500">${trans.category} ‚Ä¢ ${formatDate(trans.date)}</p>
                    </div>
                </div>
                <p class="font-bold ${isIncome ? 'text-green-600' : 'text-red-600'}">
                    ${isIncome ? '+' : '-'}${formatCurrency(trans.amount)}
                </p>
            </div>
        `;
        container.innerHTML += transactionHTML;
    });
}

    // ==================== INCOME FUNCTIONS ====================
    function addIncome() {
    const desc = document.getElementById('income-desc').value.trim();
    const amount = parseFloat(document.getElementById('income-amount').value);
    const category = document.getElementById('income-category').value;
    const date = document.getElementById('income-date').value;
    
    if (!desc || !amount || amount <= 0) {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        showToast(`‚ö†Ô∏è ${t['fill-fields'] || 'Compila tutti i campi correttamente'}`);
        return;
    }
    
    // üî• GESTIONE SUGGERIMENTO E APPRENDIMENTO
    const suggestedCategory = suggestCategory(desc);
    if (category !== suggestedCategory) {
        learnCategory(desc, category);
    }
    
    transactions.push({
        id: Date.now(),
        amount: amount,
        description: desc,
        category: category,
        type: 'entrata',
        date: date
    });
    
    document.getElementById('income-desc').value = '';
    document.getElementById('income-amount').value = '';

    saveAllData();
    
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    showToast(`üí∞ ${t['income-registered'] || 'Entrata registrata con successo!'}`);
    showScreen('dashboard');
}

    // ==================== EXPENSE FUNCTIONS ====================
    function addExpense() {
    const desc = document.getElementById('expense-desc').value.trim();
    const amount = parseFloat(document.getElementById('expense-amount').value);
    const category = document.getElementById('expense-category').value;
    const date = document.getElementById('expense-date').value;
    
    if (!desc || !amount || amount <= 0) {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        showToast(`‚ö†Ô∏è ${t['fill-fields'] || 'Compila tutti i campi correttamente'}`);
        return;
    }
    
    // Estrai nome prodotto e cerca negozio nel database
    let productName = desc;
    let storeName = 'Negozio generico';
    
    const atIndex = desc.indexOf('@');
    if (atIndex > 0) {
        productName = desc.substring(0, atIndex).trim();
        const storeQuery = desc.substring(atIndex + 1).trim();
        
        const allStores = getAllStores();
        const foundStore = allStores.find(s => 
            s.name.toLowerCase().includes(storeQuery.toLowerCase())
        );
        
        if (foundStore) {
            storeName = foundStore.name;
        } else {
            storeName = storeQuery;
        }
    }
    
    saveUserPrice(productName, storeName, amount, {
        source: 'receipt',
        confidence: 0.95
    });
    
    const suggestedCategory = suggestCategory(desc);
    // Impara SEMPRE se la categoria scelta √® diversa dal suggerimento
    if (category !== suggestedCategory) {
        learnCategory(desc, category);
    }
    
    // üî• AGGIUNGI LA TRANSAZIONE (UNA SOLA VOLTA)
    transactions.push({
        id: Date.now(),
        amount: amount,
        description: desc,
        category: category,
        type: 'uscita',
        date: date,
        product: productName,
        store: storeName
    });
    
    // Resetta i campi del form
    document.getElementById('expense-desc').value = '';
    document.getElementById('expense-amount').value = '';
    document.getElementById('expense-category').value = 'Altro';
    document.getElementById('category-suggestion-hint').classList.add('hidden');

    // Salva tutti i dati
    saveAllData();
    
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    showToast(`üì§ ${t['expense-registered'] || 'Uscita registrata!'} ${t['price-saved'] || 'Prezzo di'} ${productName} ${t['saved-for'] || 'salvato per'} ${storeName}`);
    showScreen('dashboard');
}

    // ==================== SHOPPING LIST FUNCTIONS ====================
    function renderShoppingList() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    const container = document.getElementById('shopping-list-items');
    container.innerHTML = '';
    
    if (shoppingList.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center py-4">${t['empty-list'] || 'La lista √® vuota'}</p>`;
        return;
    }
    
    const uncheckedItems = shoppingList.filter(item => !item.checked);
    if (uncheckedItems.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center py-4">${t['all-purchased'] || 'Tutti gli articoli sono stati acquistati'}</p>`;
        return;
    }
    
    uncheckedItems.forEach(item => {
        const totalPrice = (item.bestPrice || 0) * (item.quantity || 1);
        const priceInfo = item.bestPrice ? 
            `<span class="text-sm font-semibold text-green-600">${formatCurrency(item.bestPrice)} x ${item.quantity || 1}${item.unit ? ' ' + item.unit : ''} = ${formatCurrency(totalPrice)}</span>
             <span class="text-xs text-gray-500">@ ${item.bestStore}</span>` :
            `<span class="text-xs text-gray-400">${t['searching-prices'] || 'Cerca prezzi...'}</span>`;
        
        const unrecognizedBadge = !item.recognized ? 
            `<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">${t['unrecognized'] || 'Non riconosciuto'}</span>` : '';
        
        const confidenceBadge = item.confidence ? 
            (item.confidence > 0.8 ? 
                '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded">‚úÖ</span>' : 
                '<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">‚ö†Ô∏è</span>') : '';
        
        const itemHTML = `
            <div class="flex items-center justify-between p-3 border rounded-lg">
                <div class="flex items-center gap-3">
                    <button onclick="toggleShoppingItem(${item.id})" 
                            class="w-8 h-8 rounded border-2 border-gray-300 flex items-center justify-center hover:border-green-500">
                        <i class="fas fa-shopping-cart text-gray-400"></i>
                    </button>
                    <div>
                        <div class="flex items-center">
                            <span class="font-medium">${item.displayName || item.name}</span>
                            ${unrecognizedBadge}
                            ${confidenceBadge}
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            ${priceInfo}
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center border rounded-lg mr-2">
                        <button onclick="adjustQuantity(${item.id}, -1)" 
                                class="px-2 py-1 text-gray-600 hover:bg-gray-100 rounded-l-lg">
                            <i class="fas fa-minus text-xs"></i>
                        </button>
                        <span class="px-3 py-1 text-sm font-medium border-x" id="qty-${item.id}">${item.quantity || 1}</span>
                        <button onclick="adjustQuantity(${item.id}, 1)" 
                                class="px-2 py-1 text-gray-600 hover:bg-gray-100 rounded-r-lg">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </div>
                    <button onclick="showPriceDetails(${item.id})" 
                            class="px-3 py-1 text-xs bg-blue-100 text-blue-600 rounded hover:bg-blue-200">
                        <i class="fas fa-chart-bar mr-1"></i>${t['price-button'] || 'Prezzi'}
                    </button>
                    <button onclick="showPriceCorrectionModal(${item.id})" 
                            class="px-3 py-1 text-xs bg-green-100 text-green-600 rounded hover:bg-green-200">
                        <i class="fas fa-pencil-alt mr-1"></i>${t['correct-price'] || 'Correggi'}
                    </button>
                    <button onclick="removeShoppingItem(${item.id})" 
                            class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        container.innerHTML += itemHTML;
    });
    
    updateItemPrices();
}

// Nuova funzione per aggiustare la quantit√†
function adjustQuantity(itemId, change) {
    const item = shoppingList.find(i => i.id === itemId);
    if (item) {
        item.quantity = Math.max(1, (item.quantity || 1) + change);
        // üî• SALVA I DATI
        saveAllData();
        renderShoppingList();
    }
}
function showPriceCorrectionModal(itemId) {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    const item = shoppingList.find(i => i.id === itemId);
    const allStores = getAllStores();
    
    const storeOptions = allStores.map(store => 
        `<option value="${store.name}" ${store.name === item.bestStore ? 'selected' : ''}>${store.name}</option>`
    ).join('');
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">${t['correct-price-for'] || 'Correggi prezzo per'} ${item.name}</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">${t['price'] || 'Prezzo'} (${userProfile?.currencySymbol || '‚Ç¨'})</label>
                    <input type="number" step="0.01" id="correct-price" 
                           class="w-full p-3 border rounded-lg" value="${item.bestPrice}">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">${t['store'] || 'Negozio'}</label>
                    <select id="correct-store-select" class="w-full p-3 border rounded-lg">
                        <option value="">${t['select-store'] || '-- Seleziona un negozio --'}</option>
                        ${storeOptions}
                        <option value="__new__">${t['add-new-store'] || '‚ûï Aggiungi nuovo negozio'}</option>
                    </select>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="submitPriceCorrectionWithStore(${item.id})" 
                            class="flex-1 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                            <i class="fas fa-save mr-2"></i>${t['save'] || 'Salva'}
                    </button>
                    <button onclick="this.closest('.fixed').remove()" 
                            class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            ${t['cancel'] || 'Annulla'}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

window.submitPriceCorrection = function(itemId) {
    const item = shoppingList.find(i => i.id === itemId);
    const newPrice = parseFloat(document.getElementById('correct-price').value);
    const newStore = document.getElementById('correct-store').value.trim();
    
    if (!newPrice || newPrice <= 0) {
        showToast('‚ö†Ô∏è Inserisci un prezzo valido');
        return;
    }
    
    if (!newStore) {
        showToast('‚ö†Ô∏è Inserisci il nome del negozio');
        return;
    }
    
    // üî• NUOVO: Verifica se il negozio esiste gi√†
    const allStores = getAllStores();
    const storeExists = allStores.some(s => s.name.toLowerCase() === newStore.toLowerCase());
    
    if (!storeExists) {
        // Chiedi se vuole aggiungere l'indirizzo
        if (confirm(`Il negozio "${newStore}" non esiste nel database. Vuoi aggiungere l'indirizzo?`)) {
            showNewStoreModal(itemId, newStore, newPrice);
            return;
        }
    }
    
    // Salva nel database
    saveUserPrice(item.name, newStore, newPrice, {
        source: 'correction',
        confidence: 1.0
    });
    
    // Aggiorna l'item corrente
    item.bestPrice = newPrice;
    item.bestStore = newStore;
    item.selectedStore = newStore;
    item.source = 'user';
    item.confidence = 1.0;
    
    // Aggiorna UI
    renderShoppingList();
    document.querySelector('.fixed').remove();
    showToast('‚úÖ Prezzo corretto! Grazie per il contributo');
};
// ==================== QUI INSERISCI LA NUOVA FUNZIONE ====================
window.submitPriceCorrectionWithStore = function(itemId) {
    const item = shoppingList.find(i => i.id === itemId);
    const newPrice = parseFloat(document.getElementById('correct-price').value);
    const storeSelect = document.getElementById('correct-store-select');
    const selectedStore = storeSelect.value;
    
    if (!newPrice || newPrice <= 0) {
        showToast('‚ö†Ô∏è Inserisci un prezzo valido');
        return;
    }
    
    if (!selectedStore) {
        showToast('‚ö†Ô∏è Seleziona un negozio');
        return;
    }
    
    if (selectedStore === '__new__') {
        // Chiudi il modal corrente
        document.querySelector('.fixed').remove();
        // Apri il modal per nuovo negozio
        showNewStoreModal(itemId, '', newPrice);
        return;
    }
    
    // Salva nel database
    saveUserPrice(item.name, selectedStore, newPrice, {
        source: 'correction',
        confidence: 1.0
    });
    
    // Aggiorna l'item corrente
    item.bestPrice = newPrice;
    item.bestStore = selectedStore;
    item.selectedStore = selectedStore;
    item.source = 'user';
    item.confidence = 1.0;
    
    // Aggiorna i prezzi nell'item
    if (!item.prices) item.prices = [];
    item.prices.push({
        price: newPrice,
        store: selectedStore,
        source: 'user',
        confidence: 1.0
    });
    
    // Aggiorna UI
    renderShoppingList();
    document.querySelector('.fixed').remove();
    showToast(`‚úÖ Prezzo corretto! ${item.name} @ ${selectedStore} - ${formatCurrency(newPrice)}`);
};

    function showPriceDetails(itemId) {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        const item = shoppingList.find(i => i.id === itemId);
        if (!item || item.prices.length === 0) {
            showToast('‚ö†Ô∏è Nessun prezzo disponibile per questo articolo');
            return;
        }
        
        let message = `${t['prices-for'] || 'Prezzi per'} ${item.name}:\n\n`;
    
    if (!item.recognized) {
        message += `‚ö†Ô∏è ${t['unrecognized-estimated'] || 'Prodotto non riconosciuto - Prezzi stimati'}\n\n`;
    }
    
    item.prices.forEach(price => {
        const estimatedTag = price.estimated ? ` (${t['estimated'] || 'stimato'})` : '';
        message += `‚Ä¢ ${price.store}: ${formatCurrency(price.price)}${estimatedTag}\n`;
    });
    
    if (item.bestPrice) {
        message += `\n${t['best-price'] || 'Miglior prezzo'}: ${item.bestStore} - ${formatCurrency(item.bestPrice)}`;
        if (item.prices.some(p => p.estimated)) {
            message += `\n\n‚ö†Ô∏è ${t['estimated-warning-short'] || 'Alcuni prezzi sono stimati in base a prodotti simili'}`;
        }
    }
    
    alert(message);
}

    function addShoppingItem() {
        console.log('1Ô∏è‚É£ addShoppingItem chiamata');
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        const input = document.getElementById('shopping-item');
        const itemName = input.value.trim();
        console.log('   itemName:', itemName);

    
        if (!itemName) {
        showToast(`‚ö†Ô∏è ${t['enter-item-name'] || 'Inserisci un nome per l\'articolo'}`);
        return;
    }
    
    // Mostra modal per scegliere la quantit√†
    showQuantityModal(itemName);
}



// ==================== FUNZIONE PER RIMUOVERE PRODOTTO ====================
function removeShoppingItem(id) {
    shoppingList = shoppingList.filter(item => item.id !== id);
    saveAllData();
    renderShoppingList();
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    showToast(`üóëÔ∏è ${t['item-removed'] || 'Articolo rimosso'}`);
}

// Rendi globale per il pulsante nel HTML
window.removeShoppingItem = removeShoppingItem;

// ==================== FUNZIONE PER COMPLETARE/SPUNTARE PRODOTTO ====================
function toggleShoppingItem(id) {
    const item = shoppingList.find(i => i.id === id);
    if (item) {
        item.checked = !item.checked;
        saveAllData();
        renderShoppingList();
    }
}

window.toggleShoppingItem = toggleShoppingItem;
function showQuantityModal(itemName) {
    console.log('2Ô∏è‚É£ showQuantityModal chiamata con', itemName);
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    // Prendi sempre i negozi aggiornati
    const allStores = getAllStores();
    
    // Cerca se esiste gi√† un prezzo per questo prodotto
    const existingItem = shoppingList.find(i => i.name === itemName && !i.checked);
    const defaultPrice = existingItem?.bestPrice || '';
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    
    // Crea le option per i negozi
    const storeOptions = allStores.map(store => 
        `<option value="${store.name}">${store.name}</option>`
    ).join('');
    
    // Opzioni per le unit√† di misura
    const unitOptions = `
        <option value="pz">${t['piece'] || 'pezzo/i'}</option>
        <option value="kg">${t['kg'] || 'kg'}</option>
        <option value="g">${t['g'] || 'g'}</option>
        <option value="l">${t['l'] || 'l'}</option>
        <option value="ml">${t['ml'] || 'ml'}</option>
        <option value="bottiglia">${t['bottle'] || 'bottiglia/e'}</option>
        <option value="confezione">${t['pack'] || 'confezione/i'}</option>
    `;
    
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">${t['add-product-title'].replace('{product}', itemName)}</h3>
            
            <!-- Quantit√† -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t['quantity']}</label>
                <div class="flex items-center justify-center gap-4">
                    <button onclick="updateQuantity(-1)" 
                            class="w-12 h-12 bg-gray-200 rounded-full text-2xl font-bold hover:bg-gray-300">-</button>
                    <span id="quantity-display" class="text-2xl font-bold w-16 text-center">1</span>
                    <button onclick="updateQuantity(1)" 
                            class="w-12 h-12 bg-gray-200 rounded-full text-2xl font-bold hover:bg-gray-300">+</button>
                </div>
            </div>

            <!-- UNIT√Ä DI MISURA (NUOVO) -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t['unit'] || 'Unit√† di misura'}</label>
                <select id="modal-unit" class="w-full p-3 border rounded-lg">
                    ${unitOptions}
                </select>
            </div>

            <!-- Negozio - CON ONCHANGE DIRETTO -->
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">${t['store']}</label>
                <select id="modal-store-select" class="w-full p-3 border rounded-lg" 
                        onchange="handleStoreSelectDirect(this, '${itemName}')">
                    <option value="">${t['select-store']}</option>
                    ${storeOptions}
                    <option value="__new__">${t['add-new-store']}</option>
                </select>
            </div>

            <!-- Prezzo (appare solo se selezioni un negozio esistente) -->
            <div id="price-field-container" class="mb-4 hidden">
                <label class="block text-sm font-medium mb-2">${t['price-optional']}</label>
                <input type="number" step="0.01" id="modal-price" 
                       class="w-full p-3 border rounded-lg" 
                       value="${defaultPrice}"
                       placeholder="${t['price-optional']}">
                <p class="text-xs text-gray-500 mt-1">${t['price-auto-hint']}</p>
            </div>

            <!-- Pulsanti -->
            <div class="flex gap-3 pt-4">
                <button onclick="confirmQuantityWithUnit('${itemName}')" 
                        class="flex-1 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600">
                    <i class="fas fa-check mr-2"></i>${t['confirm']}
                </button>
                <button onclick="closeQuantityModal()" 
                        class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    ${t['cancel']}
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    window.currentQuantity = 1;
    window.currentItemName = itemName;
}
// ==================== GESTIONE DIRETTA NEGOZIO NUOVO ====================
function handleStoreSelectDirect(select, itemName) {
    if (select.value === '__new__') {
        console.log('‚ûï Apertura diretta nuovo negozio per', itemName);
        
        // Prendi il prezzo se √® stato inserito
        const priceInput = document.getElementById('modal-price');
        const customPrice = priceInput ? parseFloat(priceInput.value) : null;
        const quantity = window.currentQuantity || 1;
        const unit = document.getElementById('modal-unit')?.value || 'pz';
        
        // Chiudi il modal quantit√†
        closeQuantityModal();
        
        // Apri DIRETTAMENTE il modal nuovo negozio (senza conferma)
        showNewStoreModalWithProduct(itemName, quantity, unit, customPrice);
    } else if (select.value) {
        // Se ha selezionato un negozio esistente, mostra il campo prezzo
        const priceContainer = document.getElementById('price-field-container');
        if (priceContainer) {
            priceContainer.classList.remove('hidden');
        }
    } else {
        // Se ha deselezionato, nascondi il campo prezzo
        const priceContainer = document.getElementById('price-field-container');
        if (priceContainer) {
            priceContainer.classList.add('hidden');
        }
    }
}
// ==================== FUNZIONI PER MODAL QUANTIT√Ä ====================
window.updateQuantity = function(change) {
    if (window.currentQuantity === undefined) window.currentQuantity = 1;
    window.currentQuantity = Math.max(1, window.currentQuantity + change);
    const display = document.getElementById('quantity-display');
    if (display) display.textContent = window.currentQuantity;
};

window.closeQuantityModal = function() {
    const modal = document.querySelector('.fixed');
    if (modal) modal.remove();
};

// Funzione per mostrare/nascondere il campo prezzo
window.togglePriceField = function() {
    const select = document.getElementById('modal-store-select');
    const priceContainer = document.getElementById('price-field-container');
    
    // üî• SE √à __new__, NON mostrare il campo prezzo (verr√† gestito da handleStoreSelectDirect)
    if (select.value && select.value !== '__new__') {
        priceContainer.classList.remove('hidden');
    } else {
        priceContainer.classList.add('hidden');
    }
};

window.closeQuantityModal = function() {
    const modal = document.querySelector('.fixed');
    if (modal) modal.remove();
};

// ==================== NUOVA FUNZIONE PER CONFERMA CON NEGOZIO ====================
window.confirmQuantityWithStore = function(itemName) {
    console.log('3Ô∏è‚É£ confirmQuantityWithStore chiamata con', itemName);
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    // üîç DEBUG: controlla se gli elementi esistono
    const storeSelect = document.getElementById('modal-store-select');
    console.log('   storeSelect trovato?', storeSelect !== null);
    
    if (!storeSelect) {
        console.log('   ‚ùå storeSelect NON TROVATO!');
        showToast(t['store-not-found'] || 'Errore: selettore negozio non trovato');
        return;
    }
    
    const selectedStore = storeSelect.value;
    console.log('   selectedStore:', selectedStore);
    
    const priceInput = document.getElementById('modal-price');
    console.log('   priceInput trovato?', priceInput !== null);
    
    const customPrice = priceInput ? parseFloat(priceInput.value) : null;
    console.log('   customPrice:', customPrice);
    
    const quantity = window.currentQuantity || 1;
    console.log('   quantity:', quantity);
    
    if (!selectedStore) {
        console.log('   ‚ùå Nessun negozio selezionato');
        showToast(`‚ö†Ô∏è ${t['select-store-warning'] || 'Seleziona un negozio'}`);
        return;
    }
    
    if (selectedStore === '__new__') {
        console.log('   ‚ûï Aggiungi nuovo negozio');
        closeQuantityModal();
        showNewStoreModalWithProduct(itemName, quantity, customPrice);
        return;
    }
    
    console.log('   ‚úÖ Procedo con l\'aggiunta del prodotto');
    closeQuantityModal();
    
    // üî• SALVA SEMPRE IL PREZZO NEL DATABASE
    if (customPrice && customPrice > 0) {
        console.log('   üí∞ Con prezzo personalizzato:', customPrice);
        saveUserPrice(itemName, selectedStore, customPrice, {
            source: 'manual',
            confidence: 1.0
        });
        
        // Aggiungi il prodotto
        shoppingList.push({
            id: Date.now(),
            name: itemName,
            quantity: quantity,
            checked: false,
            bestPrice: customPrice,
            bestStore: selectedStore,
            selectedStore: selectedStore,
            prices: [{
                price: customPrice,
                store: selectedStore,
                source: 'user',
                confidence: 1.0
            }],
            recognized: true,
            source: 'user',
            confidence: 1.0
        });
        
        console.log('   ‚úÖ Prodotto aggiunto con prezzo personalizzato');
        renderShoppingList();
        showToast(`‚úÖ ${itemName} x${quantity} aggiunto - ${formatCurrency(customPrice * quantity)} @ ${selectedStore}`);
        
    } else {
        console.log('   üîç Senza prezzo personalizzato, chiamo getBestPrice per', selectedStore);
        
        // Usa getBestPrice ma FORZA il negozio
        getBestPrice(itemName, selectedStore).then(bestPrice => {
            console.log('   üè∑Ô∏è Prezzo ottenuto:', bestPrice.price, '@', bestPrice.store);
            
            shoppingList.push({
                id: Date.now(),
                name: itemName,
                quantity: quantity,
                checked: false,
                bestPrice: bestPrice.price,
                bestStore: bestPrice.store,
                selectedStore: selectedStore,
                prices: [bestPrice],
                recognized: true,
                source: bestPrice.source,
                confidence: bestPrice.confidence
            });
            
            console.log('   ‚úÖ Prodotto aggiunto con prezzo automatico');
            renderShoppingList();
            showToast(`‚úÖ ${itemName} x${quantity} aggiunto - ${formatCurrency(bestPrice.price * quantity)} @ ${bestPrice.store}`);
        });
        return; // Evita doppio render
    }
};
// ==================== CONFERMA CON UNIT√Ä DI MISURA ====================
window.confirmQuantityWithUnit = function(itemName) {
    console.log('3Ô∏è‚É£ confirmQuantityWithUnit chiamata con', itemName);
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    const storeSelect = document.getElementById('modal-store-select');
    const unitSelect = document.getElementById('modal-unit');
    
    if (!storeSelect) {
        showToast(t['store-not-found'] || 'Errore: selettore negozio non trovato');
        return;
    }
    
    const selectedStore = storeSelect.value;
    const selectedUnit = unitSelect ? unitSelect.value : 'pz';
    
    const priceInput = document.getElementById('modal-price');
    const customPrice = priceInput ? parseFloat(priceInput.value) : null;
    
    const quantity = window.currentQuantity || 1;
    
    if (!selectedStore) {
        showToast(`‚ö†Ô∏è ${t['select-store-warning'] || 'Seleziona un negozio'}`);
        return;
    }
    
    if (selectedStore === '__new__') {
        closeQuantityModal();
        showNewStoreModalWithProduct(itemName, quantity, customPrice);
        return;
    }
    
    closeQuantityModal();
    
    // SALVA SEMPRE IL PREZZO NEL DATABASE
    if (customPrice && customPrice > 0) {
        saveUserPrice(itemName, selectedStore, customPrice, {
            source: 'manual',
            confidence: 1.0
        });
        
        // Aggiungi il prodotto con l'unit√† di misura
        shoppingList.push({
            id: Date.now(),
            name: itemName,
            quantity: quantity,
            unit: selectedUnit, // <-- NUOVO CAMPO
            displayName: formatProductNameWithUnit(itemName, quantity, selectedUnit),
            checked: false,
            bestPrice: customPrice,
            bestStore: selectedStore,
            selectedStore: selectedStore,
            prices: [{
                price: customPrice,
                store: selectedStore,
                source: 'user',
                confidence: 1.0
            }],
            recognized: true,
            source: 'user',
            confidence: 1.0
        });
        
        renderShoppingList();

         // üî• SVUOTA L'INPUT QUI
         const input = document.getElementById('shopping-item');
        if (input) {
            input.value = '';
            console.log('‚úÖ Input svuotato da confirmQuantityWithUnit');
        }
        showToast(`‚úÖ ${formatProductNameWithUnit(itemName, quantity, selectedUnit)} aggiunto - ${formatCurrency(customPrice * quantity)} @ ${selectedStore}`);
        
    } else {
        // Usa getBestPrice ma FORZA il negozio
        getBestPrice(itemName, selectedStore).then(bestPrice => {
            shoppingList.push({
                id: Date.now(),
                name: itemName,
                quantity: quantity,
                unit: selectedUnit, // <-- NUOVO CAMPO
                displayName: formatProductNameWithUnit(itemName, quantity, selectedUnit),
                checked: false,
                bestPrice: bestPrice.price,
                bestStore: bestPrice.store,
                selectedStore: selectedStore,
                prices: [bestPrice],
                recognized: true,
                source: bestPrice.source,
                confidence: bestPrice.confidence
            });
            
            renderShoppingList();

            // üî• SVUOTA L'INPUT QUI
            const input = document.getElementById('shopping-item');
            if (input) {
                input.value = '';
                console.log('‚úÖ Input svuotato da confirmQuantityWithUnit (senza prezzo)');
            }
            showToast(`‚úÖ ${formatProductNameWithUnit(itemName, quantity, selectedUnit)} aggiunto - ${formatCurrency(bestPrice.price * quantity)} @ ${bestPrice.store}`);
        });
        return;
    }
};
// ==================== FORMATTA NOME PRODOTTO CON UNIT√Ä ====================
function formatProductNameWithUnit(name, quantity, unit) {
    const lang = userProfile?.language || 'it';
    
    const unitMap = {
        'pz': { 'it': 'pezzo', 'en': 'piece', 'es': 'pieza', 'fr': 'pi√®ce', 'de': 'St√ºck', 'ro': 'bucatƒÉ' },
        'kg': { 'it': 'kg', 'en': 'kg', 'es': 'kg', 'fr': 'kg', 'de': 'kg', 'ro': 'kg' },
        'g': { 'it': 'g', 'en': 'g', 'es': 'g', 'fr': 'g', 'de': 'g', 'ro': 'g' },
        'l': { 'it': 'l', 'en': 'l', 'es': 'l', 'fr': 'l', 'de': 'l', 'ro': 'l' },
        'ml': { 'it': 'ml', 'en': 'ml', 'es': 'ml', 'fr': 'ml', 'de': 'ml', 'ro': 'ml' },
        'bottiglia': { 'it': 'bottiglia', 'en': 'bottle', 'es': 'botella', 'fr': 'bouteille', 'de': 'Flasche', 'ro': 'sticlƒÉ' },
        'confezione': { 'it': 'confezione', 'en': 'pack', 'es': 'paquete', 'fr': 'paquet', 'de': 'Packung', 'ro': 'pachet' }
    };
    
    const unitText = unitMap[unit] ? unitMap[unit][lang] || unitMap[unit]['it'] : unit;
    
    // Gestisci il plurale
    if (quantity > 1) {
        if (unit === 'pz') {
            const pluralMap = {
                'it': 'pezzi', 'en': 'pieces', 'es': 'piezas', 'fr': 'pi√®ces', 'de': 'St√ºcke', 'ro': 'bucƒÉ»õi'
            };
            return `${name} (${quantity} ${pluralMap[lang] || pluralMap['it']})`;
        }
        if (unit === 'bottiglia') {
            const pluralMap = {
                'it': 'bottiglie', 'en': 'bottles', 'es': 'botellas', 'fr': 'bouteilles', 'de': 'Flaschen', 'ro': 'sticle'
            };
            return `${name} (${quantity} ${pluralMap[lang] || pluralMap['it']})`;
        }
        if (unit === 'confezione') {
            const pluralMap = {
                'it': 'confezioni', 'en': 'packs', 'es': 'paquetes', 'fr': 'paquets', 'de': 'Packungen', 'ro': 'pachete'
            };
            return `${name} (${quantity} ${pluralMap[lang] || pluralMap['it']})`;
        }
    }
    
    // Per kg, g, l, ml il plurale √® uguale al singolare
    return `${name} (${quantity} ${unitText})`;
}
// ==================== üî• QUI AGGIUNGI LE NUOVE FUNZIONI ====================
function showRegisterPurchases() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    const checkedItems = shoppingList.filter(item => item.checked);
    
    if (checkedItems.length === 0) {
        showToast(`‚ö†Ô∏è ${t['no-checked-items'] || 'Nessun articolo spuntato da registrare'}`);
        return;
    }
    
    showScreen('register-purchases');
    renderPurchasesToRegister();
}

function renderPurchasesToRegister() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    const container = document.getElementById('purchases-to-register');
    const checkedItems = shoppingList.filter(item => item.checked);
    
    container.innerHTML = '';
    
    checkedItems.forEach(item => {
        container.innerHTML += `
            <div class="p-4 border rounded-lg" data-item-id="${item.id}">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-gray-500">${t['quantity-label'] || 'Quantit√†:'} ${item.quantity || 1}</p>
                    </div>
                    <button onclick="removeFromPurchases(${item.id})" class="text-red-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flex gap-2">
                    <input type="number" step="0.01" id="price-${item.id}" 
                           class="flex-1 p-2 border rounded" 
                           value="${item.bestPrice || ''}" 
                           placeholder="${t['price-placeholder'] || 'Prezzo'}">
                    <input type="text" id="store-${item.id}" 
                           class="flex-1 p-2 border rounded" 
                           value="${item.bestStore || ''}" 
                           placeholder="${t['store-placeholder'] || 'Negozio'}">
                </div>
            </div>
        `;
    });
}

function removeFromPurchases(itemId) {
    const element = document.querySelector(`[data-item-id="${itemId}"]`);
    if (element) {
        element.remove();
    }
}

function registerAllPurchases() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    const containers = document.querySelectorAll('[data-item-id]');
    let registered = 0;
    
    containers.forEach(container => {
        const itemId = parseInt(container.dataset.itemId);
        const item = shoppingList.find(i => i.id === itemId);
        
        if (item) {
            const newPrice = parseFloat(document.getElementById(`price-${itemId}`).value);
            const newStore = document.getElementById(`store-${itemId}`).value.trim();
            
            // Se l'utente ha modificato prezzo o negozio, salva nel database
            if (newPrice && newPrice > 0) {
                saveUserPrice(item.name, newStore || item.bestStore || 'Negozio', newPrice, {
                    source: 'purchase',
                    confidence: 1.0
                });
                
                // Aggiorna l'item con i nuovi valori
                item.bestPrice = newPrice;
                item.bestStore = newStore || item.bestStore;
            }
            
            // Crea la transazione
            transactions.push({
                id: Date.now() + registered,
                amount: (newPrice || item.bestPrice) * (item.quantity || 1),
                description: `${t['expense-description'] || 'Spesa:'} ${item.name}${item.quantity > 1 ? ' x' + item.quantity : ''} (${newStore || item.bestStore || t['store-generic'] || 'Negozio'})`,
                category: t['food'] || 'Alimentari',
                type: 'uscita',
                date: new Date().toISOString().split('T')[0],
                product: item.name,
                store: newStore || item.bestStore || 'Negozio'
            });
            
            // Rimuovi l'articolo dalla lista (o lascialo se vuoi)
            shoppingList = shoppingList.filter(i => i.id !== itemId);
            
            registered++;
        }
    });
    
    if (registered > 0) {
    saveAllData();
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    showToast(`‚úÖ ${registered} ${t['purchases-registered'] || 'acquisti registrati!'}`);
    // üî• FORZA L'AGGIORNAMENTO DELLE OTTIMIZZAZIONI
    updateOptimizationPreview();
    showScreen('shopping');
    renderShoppingList();
    }   
}
// ==================== SCANSIONE SCONTRINO ====================
function scanReceipt() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    // Verifica se la fotocamera √® disponibile
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showToast(`üì∑ ${t['camera-not-supported'] || 'Fotocamera non supportata su questo dispositivo'}`);
        // Fallback: input file per caricare immagine
        uploadReceiptImage();
        return;
    }
    
    // Controlla se ci sono articoli spuntati
    const checkedItems = shoppingList.filter(item => item.checked);
    if (checkedItems.length === 0) {
        showToast(`‚ö†Ô∏è ${t['no-checked-items'] || 'Nessun articolo spuntato da registrare'}`);
        return;
    }
    
    // Mostra modal per scegliere tra fotocamera o upload
    showScanOptions();
}

// Mostra opzioni di scansione
function showScanOptions() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg max-w-md w-full p-6">
            <h3 class="text-xl font-bold mb-4">üì∑ ${t['scan-title'] || 'Scansione scontrino'}</h3>
            <p class="text-gray-600 mb-6">${t['scan-choose'] || 'Scegli come acquisire lo scontrino:'}</p>
            
            <div class="space-y-3">
                <button onclick="startCameraScan()" 
                        class="w-full p-4 border-2 border-blue-300 rounded-xl text-left hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-camera text-blue-500 text-xl"></i>
                        </div>
                        <div>
                            <p class="font-bold">${t['use-camera'] || 'Usa fotocamera'}</p>
                            <p class="text-sm text-gray-500">${t['scan-realtime'] || 'Scansiona in tempo reale'}</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="uploadReceiptImage()" 
                        class="w-full p-4 border-2 border-green-300 rounded-xl text-left hover:border-green-500 hover:bg-green-50 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-cloud-upload-alt text-green-500 text-xl"></i>
                        </div>
                        <div>
                            <p class="font-bold">${t['upload-image'] || 'Carica immagine'}</p>
                            <p class="text-sm text-gray-500">${t['select-existing'] || 'Seleziona uno scontrino gi√† fotografato'}</p>
                        </div>
                    </div>
                </button>
                
                <button onclick="closeModal()" 
                        class="w-full p-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 mt-4">
                        ${t['cancel'] || 'Annulla'}
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    window.currentModal = modal;
}

// Avvia la fotocamera
async function startCameraScan() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    closeModal();
    showToast(`üì∑ ${t['start-camera'] || 'Avvio fotocamera...'}`);
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } // Usa fotocamera posteriore
        });
        
        // Crea modal con video
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg max-w-2xl w-full p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">${t['frame-receipt'] || 'Inquadra lo scontrino'}</h3>
                    <button onclick="stopCameraScan()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <video id="camera-preview" autoplay playsinline class="w-full rounded-lg bg-black" style="max-height: 400px;"></video>
                <div class="flex gap-3 mt-4">
                    <button onclick="captureReceipt()" 
                            class="flex-1 py-3 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600">
                        <i class="fas fa-camera mr-2"></i> ${t['capture'] || 'Acquisisci'}
                    </button>
                    <button onclick="stopCameraScan()" 
                            class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                            ${t['cancel'] || 'Annulla'}
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        window.currentModal = modal;
        window.cameraStream = stream;
        
        const video = document.getElementById('camera-preview');
        video.srcObject = stream;
        
    } catch (error) {
        console.error('Errore fotocamera:', error);
        showToast(`‚ùå ${t['camera-error'] || 'Impossibile accedere alla fotocamera'}`);
        // Fallback a upload
        uploadReceiptImage();
    }
}

// Ferma la fotocamera
function stopCameraScan() {
    if (window.cameraStream) {
        window.cameraStream.getTracks().forEach(track => track.stop());
        window.cameraStream = null;
    }
    closeModal();
}

// Acquisisci immagine dalla fotocamera
function captureReceipt() {
    const video = document.getElementById('camera-preview');
    if (!video) return;
    
    // Crea un canvas per catturare il frame
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Converti in data URL
    const imageData = canvas.toDataURL('image/jpeg');
    
    // Ferma la fotocamera
    stopCameraScan();
    
    // Processa l'immagine
    processReceiptImage(imageData);
}

// Upload immagine da file
function uploadReceiptImage() {
    closeModal();
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            processReceiptImage(event.target.result);
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

// Processa l'immagine dello scontrino (SIMULATO)
function processReceiptImage(imageData) {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    showToast(`üîç ${t['analyzing'] || 'Analisi scontrino in corso...'}`);
    
    // üî• QUI ANDREBBE L'INTEGRAZIONE CON UN SERVIZIO OCR
    // Per ora simulo la lettura
    
    setTimeout(() => {
        // Prendi gli articoli spuntati
        const checkedItems = shoppingList.filter(item => item.checked);
        
        if (checkedItems.length === 0) {
            showToast(`‚ö†Ô∏è ${t['no-items-to-register'] || 'Nessun articolo da registrare'}`);
            return;
        }
        
        // Simula la lettura dei prezzi (genera prezzi casuali)
        checkedItems.forEach(item => {
            // Prezzo simulato (tra 0.5 e 5 volte il prezzo originale)
            const simulatedPrice = (item.bestPrice || 2) * (0.8 + Math.random() * 0.7);
            const roundedPrice = Math.round(simulatedPrice * 100) / 100;
            
            // Aggiorna l'item nel DOM se presente
            const priceInput = document.getElementById(`price-${item.id}`);
            if (priceInput) {
                priceInput.value = roundedPrice;
                priceInput.style.borderColor = '#10b981';
                priceInput.style.backgroundColor = '#f0fdf4';
            }
        });
        
        showToast(`‚úÖ ${t['receipt-processed'] || 'Scontrino elaborato! Verifica i prezzi'}`);
        
        // Evidenzia gli articoli aggiornati
        setTimeout(() => {
            document.querySelectorAll('[data-item-id] input').forEach(input => {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            });
        }, 2000);
        
    }, 1500);
}

// Chiudi modale
function closeModal() {
    const modal = document.querySelector('.fixed');
    if (modal) modal.remove();
}

    // ==================== BUDGET FUNCTIONS ====================
    function renderBudget() {
    const container = document.getElementById('budget-items');
    container.innerHTML = '';
    
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    const currencySymbol = userProfile?.currencySymbol || 'lei';
    
    const expensesByCategory = {};
    transactions
        .filter(t => t.type === 'uscita')
        .forEach(t => {
            expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
        });
    
    Object.entries(budget).forEach(([category, budgetAmount]) => {
        const spent = expensesByCategory[category] || 0;
        const percentage = budgetAmount > 0 ? (spent / budgetAmount) * 100 : 0;
        
        // Traduci il nome della categoria
        let categoryName = category;
        
        const categoryMap = {
            'Alimentari': 'food',
            'Affitto': 'rent',
            'Mutuo': 'mortgage',
            'Bollette': 'utilities',
            'Trasporti': 'transport',
            'Svago': 'entertainment',
            'Salute': 'health',
            'Shopping': 'shopping-cat',
            'Cibo': 'food',
            'Abitazione': 'housing',
            'Intrattenimento': 'entertainment',
            'Altro': 'other'
        };
        
        const translationKey = categoryMap[category];
        if (translationKey && t[translationKey]) {
            categoryName = t[translationKey];
        }
        else if (t[category.toLowerCase()]) {
            categoryName = t[category.toLowerCase()];
        }
        
        // üî• MODIFICATO: valore vuoto invece di 0
        const budgetValue = budgetAmount > 0 ? budgetAmount : '';
        
        const budgetHTML = `
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <span class="font-medium">${categoryName}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-gray-500">${currencySymbol}</span>
                        <input type="number" value="${budgetValue}" 
                               onchange="updateBudget('${category}', this.value)"
                               class="w-24 p-2 border rounded text-right"
                               placeholder="0">
                    </div>
                </div>
                
                <div class="flex justify-between text-sm text-gray-500">
                    <span>${t['current-spending'] || 'Cheltuieli curente'}: ${formatCurrency(spent)}</span>
                    <span>${percentage.toFixed(1)}%</span>
                </div>
                
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div class="h-full ${percentage > 100 ? 'bg-red-500' : 'bg-green-500'} progress-bar"
                         style="width: ${Math.min(percentage, 100)}%">
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += budgetHTML;
    });
}

    function updateBudget(category, value) {
        budget[category] = parseFloat(value) || 0;
        // üî• SALVA I DATI
    saveAllData();
        updateDashboard();
    }

    // ==================== PROFILE FUNCTIONS ====================
    function loadProfileToForm() {
        document.getElementById('profile-firstname').value = userProfile.firstName;
        document.getElementById('profile-lastname').value = userProfile.lastName;
        document.getElementById('profile-email').value = userProfile.email;
        
        document.getElementById('home-street').value = userProfile.homeStreet;
        document.getElementById('home-number').value = userProfile.homeNumber;
        document.getElementById('home-city').value = userProfile.homeCity;
        document.getElementById('home-province').value = userProfile.homeProvince;
        document.getElementById('home-country').value = userProfile.homeCountry || 'IT';
        
        document.getElementById('work-street').value = userProfile.workStreet;
        document.getElementById('work-number').value = userProfile.workNumber;
        document.getElementById('work-city').value = userProfile.workCity;
        document.getElementById('work-province').value = userProfile.workProvince;
        document.getElementById('work-country').value = userProfile.workCountry || '';
        document.getElementById('work-company').value = userProfile.workCompany;
        document.getElementById('profile-firstname').value = userProfile.firstName;
    document.getElementById('profile-lastname').value = userProfile.lastName;
    document.getElementById('profile-email').value = userProfile.email;
     // NUOVI CAMPI: Lingua e Valuta
     document.getElementById('profile-language').value = userProfile.language || 'it';
    document.getElementById('profile-currency').value = userProfile.currency || 'EUR';
      // Aggiorna anteprima valuta
      updateCurrencyPreview();
    }
    function updateCurrencyPreview() {
    const currencySelect = document.getElementById('profile-currency');
    const languageSelect = document.getElementById('profile-language');
    const previewDiv = document.getElementById('currency-preview');
    const previewAmount = document.getElementById('preview-amount');
    const previewInfo = document.getElementById('preview-info');
    
    if (!currencySelect || !languageSelect) return;
    
    const currencyCode = currencySelect.value;
    const languageCode = languageSelect.value;
    
    if (currencyCode && currencies[currencyCode]) {
        const currency = currencies[currencyCode];
        const lang = languages[languageCode] || languages['it'];
        
        // Simula formattazione
        let formattedAmount;
        if (languageCode === 'en' || languageCode === 'ro') {
            formattedAmount = `${currency.symbol}1,234.56`;
        } else {
            formattedAmount = `${currency.symbol}1.234,56`;
        }
        
        previewAmount.textContent = formattedAmount;
        previewInfo.textContent = `${currency.name} (${currencyCode}) - ${lang.name}`;
        previewDiv.classList.remove('hidden');
    }
}
function saveProfile() {
    console.log('üíæ SALVATAGGIO PROFILO - INIZIO');
    
    // Ottieni la lingua corrente per i messaggi
    const currentLang = document.getElementById('profile-language').value;
    const t = getTranslations(currentLang);
    
    // Raccogli TUTTI i dati (compreso indirizzo completo!)
    const firstName = document.getElementById('profile-firstname').value.trim();
    const lastName = document.getElementById('profile-lastname').value.trim();
    const email = document.getElementById('profile-email').value.trim();
    
    const homeStreet = document.getElementById('home-street').value.trim();
    const homeNumber = document.getElementById('home-number').value.trim();
    const homeCity = document.getElementById('home-city').value.trim();
    const homeProvince = document.getElementById('home-province').value.trim();
    const homeCountry = document.getElementById('home-country').value;
    
    const language = document.getElementById('profile-language').value;
    const currency = document.getElementById('profile-currency').value;
    
    console.log('üìù Dati raccolti:', {
        firstName, lastName, email,
        homeStreet, homeNumber, homeCity, homeProvince, homeCountry,
        language, currency
    });
    
    // Mappa dei nomi dei campi per i messaggi di errore
    const fieldNames = {
        'it': { 'firstName': 'Nome', 'lastName': 'Cognome', 'email': 'Email', 'street': 'Via', 'number': 'Numero', 'city': 'Citt√†', 'province': 'Provincia', 'country': 'Paese' },
        'en': { 'firstName': 'First Name', 'lastName': 'Last Name', 'email': 'Email', 'street': 'Street', 'number': 'Number', 'city': 'City', 'province': 'Province', 'country': 'Country' },
        'es': { 'firstName': 'Nombre', 'lastName': 'Apellido', 'email': 'Email', 'street': 'Calle', 'number': 'N√∫mero', 'city': 'Ciudad', 'province': 'Provincia', 'country': 'Pa√≠s' },
        'fr': { 'firstName': 'Pr√©nom', 'lastName': 'Nom', 'email': 'Email', 'street': 'Rue', 'number': 'Num√©ro', 'city': 'Ville', 'province': 'Province', 'country': 'Pays' },
        'de': { 'firstName': 'Vorname', 'lastName': 'Nachname', 'email': 'Email', 'street': 'Stra√üe', 'number': 'Hausnummer', 'city': 'Stadt', 'province': 'Provinz', 'country': 'Land' },
        'ro': { 'firstName': 'Prenume', 'lastName': 'Nume', 'email': 'Email', 'street': 'StradƒÉ', 'number': 'NumƒÉr', 'city': 'Ora»ô', 'province': 'Provincie', 'country': '»öarƒÉ' }
    };
    
    const fieldName = fieldNames[language] || fieldNames['it'];
    
    // VALIDAZIONE COMPLETA - tutti i campi obbligatori!
    const errors = [];
    if (!firstName) errors.push(fieldName.firstName);
    if (!lastName) errors.push(fieldName.lastName);
    if (!email) errors.push(fieldName.email);
    if (!homeStreet) errors.push(fieldName.street);
    if (!homeNumber) errors.push(fieldName.number);
    if (!homeCity) errors.push(fieldName.city);
    if (!homeProvince) errors.push(fieldName.province);
    if (!homeCountry) errors.push(fieldName.country);
    
    if (errors.length > 0) {
        showToast(`‚ö†Ô∏è ${t['missing-fields'] || 'Campi obbligatori mancanti'}: ${errors.join(', ')}`);
        return;
    }
    
    if (!email.includes('@') || !email.includes('.')) {
        showToast(`‚ö†Ô∏è ${t['invalid-email'] || 'Inserisci un\'email valida'}`);
        return;
    }
    
    // üî¥ AGGIORNA TUTTI I CAMPI
    userProfile.firstName = firstName;
    userProfile.lastName = lastName;
    userProfile.email = email;
    
    // Indirizzo casa - COMPLETO!
    userProfile.homeStreet = homeStreet;
    userProfile.homeNumber = homeNumber;
    userProfile.homeCity = homeCity;
    userProfile.homeProvince = homeProvince;
    userProfile.homeCountry = homeCountry;
    userProfile.homeFullAddress = `${homeStreet} ${homeNumber}, ${homeCity} (${homeProvince})`;

    // üî• AGGIUNGI IL SALVATAGGIO DEI DATI DI LAVORO
    const workStreet = document.getElementById('work-street').value.trim();
    const workNumber = document.getElementById('work-number').value.trim();
    const workCity = document.getElementById('work-city').value.trim();
    const workProvince = document.getElementById('work-province').value.trim();
    const workCountry = document.getElementById('work-country').value;
    const workCompany = document.getElementById('work-company').value.trim();

    userProfile.workStreet = workStreet;
    userProfile.workNumber = workNumber;
    userProfile.workCity = workCity;
    userProfile.workProvince = workProvince;
    userProfile.workCountry = workCountry;
    userProfile.workCompany = workCompany;

    // Costruisci l'indirizzo completo solo se almeno un campo √® compilato
    if (workStreet || workNumber || workCity || workProvince) {
        userProfile.workFullAddress = `${workStreet} ${workNumber}, ${workCity} (${workProvince})`.trim();
    } else {
        userProfile.workFullAddress = '';
}
    
    // Lingua e valuta
    userProfile.language = language;
    userProfile.currency = currency;
    userProfile.currencySymbol = currencies[currency]?.symbol || '‚Ç¨';
    
    console.log('‚úÖ userProfile aggiornato:', userProfile);
    
    // üî• SALVA TUTTI I DATI (compreso il profilo appena aggiornato)
    saveAllData();
    
    // üî¥ QUESTA √à LA RIGA FONDAMENTALE PER TRADURRE! (VA MESSA QUI, FUORI DAL GEOCODING)
    applyLanguageSettings();
    updateCurrencyLabel();
    fixAmountLabel();
    translateCategoryDropdowns();
    translateSelectPlaceholders();
    
    showScreen('dashboard');
    
    // Aggiorna TUTTI i componenti
    setTimeout(() => {
        updateDashboard();
        renderRecentTransactions();
        renderShoppingList();
        renderBudget();
        renderAllTransactions();
        
        // üî• FORZA ANCHE L'AGGIORNAMENTO DELL'ICONA PROFILO
        const profileIcon = document.querySelector('button[onclick="showScreen(\'profile\')"] i');
        if (profileIcon) {
            profileIcon.className = 'fas fa-user text-blue-500';  // Rendi blu
        }
        
        const langName = languages[language]?.name || language;
        const currName = currencies[currency]?.name || currency;
        showToast(`‚úÖ ${t['profile-saved'] || 'Profilo salvato!'} ${t['language'] || 'Lingua'}: ${langName}, ${t['currency'] || 'Valuta'}: ${currName}`);
    }, 200);
    
    // üî• GEOCODING DELL'INDIRIZZO (IN BACKGROUND, NON BLOCCA IL RITORNO ALLA DASHBOARD)
    if (userProfile.homeFullAddress) {
        console.log('üìç Avvio geocoding per:', userProfile.homeFullAddress);
        
        geocodeAddress(userProfile.homeFullAddress).then(coords => {
            if (coords) {
                userProfile.homeLat = coords.lat;
                userProfile.homeLon = coords.lon;
                localStorage.setItem('smart_billing_profile_v2', JSON.stringify(userProfile));
                console.log('üìç Coordinate salvate:', coords);
            } else {
                console.log('‚ö†Ô∏è Geocoding non ha trovato coordinate');
            }
        }).catch(error => {
            console.log('‚ö†Ô∏è Geocoding fallito:', error);
        });
    }
}
    // ==================== TRANSACTIONS FUNCTIONS ====================
    function renderAllTransactions() {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        const container = document.getElementById('all-transactions');
        container.innerHTML = '';
        
        const sorted = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (sorted.length === 0) {
            container.innerHTML = `<p class="text-gray-500 text-center py-4">${t['no-transactions-registered'] || 'Nessuna transazione registrata'}</p>`;
            return;
        }
        
        sorted.forEach(trans => {
            const isIncome = trans.type === 'entrata';
            const transactionHTML = `
                <div class="flex items-center justify-between p-4 border rounded-lg">
                    <div>
                        <p class="font-semibold">${trans.description}</p>
                        <p class="text-sm text-gray-500">${trans.category} ‚Ä¢ ${formatDate(trans.date)}</p>
                    </div>
                    <p class="font-bold text-lg ${isIncome ? 'text-green-600' : 'text-red-600'}">
                        ${isIncome ? '+' : '-'}${formatCurrency(trans.amount)}
                    </p>
                </div>
            `;
            container.innerHTML += transactionHTML;
        });
    }
    window.renderAllTransactions = renderAllTransactions;

    // ==================== REPORT FUNCTIONS ====================
    function renderReports() {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        
        // Calcola totali
        const totalIncome = transactions
            .filter(t => t.type === 'entrata')
            .reduce((sum, t) => sum + t.amount, 0);
        
        const totalExpenses = transactions
            .filter(t => t.type === 'uscita')
            .reduce((sum, t) => sum + t.amount, 0);
        
        // Aggiorna i totali nella schermata
        const incomeEl = document.getElementById('report-total-income');
        const expensesEl = document.getElementById('report-total-expenses');
        
        if (incomeEl) incomeEl.textContent = formatCurrency(totalIncome);
        if (expensesEl) expensesEl.textContent = formatCurrency(totalExpenses);
        
        // Spese per categoria
        const expensesByCategory = {};
        transactions
            .filter(t => t.type === 'uscita')
            .forEach(t => {
                expensesByCategory[t.category] = (expensesByCategory[t.category] || 0) + t.amount;
            });
        
        const categoryContainer = document.getElementById('category-chart');
        if (categoryContainer) {
            categoryContainer.innerHTML = '';
            
            if (Object.keys(expensesByCategory).length === 0) {
                categoryContainer.innerHTML = '<p class="text-gray-500 text-sm">Nessuna spesa registrata</p>';
            } else {
                // Mappa per tradurre le categorie
                const categoryMap = {
                    'Alimentari': t['food'] || 'Alimentari',
                    'Affitto': t['rent'] || 'Affitto',
                    'Mutuo': t['mortgage'] || 'Mutuo',
                    'Bollette': t['utilities'] || 'Bollette',
                    'Trasporti': t['transport'] || 'Trasporti',
                    'Svago': t['entertainment'] || 'Svago',
                    'Salute': t['health'] || 'Salute',
                    'Shopping': t['shopping-cat'] || 'Shopping',
                    'Cibo': t['food'] || 'Cibo',
                    'Abitazione': t['housing'] || 'Abitazione',
                    'Intrattenimento': t['entertainment'] || 'Intrattenimento',
                    'Altro': t['other'] || 'Altro'
                };
                
                Object.entries(expensesByCategory)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([category, amount]) => {
                        const percentage = totalExpenses > 0 ? (amount / totalExpenses * 100).toFixed(1) : 0;
                        const translatedCategory = categoryMap[category] || category;
                        
                        categoryContainer.innerHTML += `
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span>${translatedCategory}</span>
                                    <span class="font-medium">${formatCurrency(amount)} (${percentage}%)</span>
                                </div>
                                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-purple-500" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    });
            }
        }
        
        // Spese per negozio
        const storeExpenses = {};
        transactions
            .filter(t => t.type === 'uscita' && t.description && t.description.includes('@'))
            .forEach(t => {
                // Determina il nome del negozio
        let store = 'Altro';
        
        // 1. Se esiste il campo store nella transazione, usalo
        if (t.store && t.store.trim() !== '') {
            store = t.store;
        }
        // 2. Altrimenti cerca nella descrizione con @
        else if (t.description && t.description.includes('@')) {
            const parts = t.description.split('@');
            store = parts.length > 1 ? parts[1].trim() : 'Altro';
        }
        
        // Aggrega per negozio
        storeExpenses[store] = (storeExpenses[store] || 0) + t.amount;
    });
        
        const storeContainer = document.getElementById('store-chart');
        if (storeContainer) {
            storeContainer.innerHTML = '';
            
            if (Object.keys(storeExpenses).length === 0) {
                storeContainer.innerHTML = `<p class="text-gray-500 text-sm">${t['no-store-data'] || 'Nessun dato negozio disponibile'}</p>`;
            } else {
                Object.entries(storeExpenses)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([store, amount]) => {
                        storeContainer.innerHTML += `
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span>${store}</span>
                                <span class="font-medium">${formatCurrency(amount)}</span>
                            </div>
                        `;
                    });
            }
        }
        
        // Andamento mensile
        const monthlyData = {};
        transactions.forEach(t => {
            const month = t.date.substring(0, 7); // YYYY-MM
            if (!monthlyData[month]) {
                monthlyData[month] = { income: 0, expenses: 0 };
            }
            if (t.type === 'entrata') {
                monthlyData[month].income += t.amount;
            } else {
                monthlyData[month].expenses += t.amount;
            }
        });
        
        const monthlyContainer = document.getElementById('monthly-trend');
        if (monthlyContainer) {
            monthlyContainer.innerHTML = '';
            
            if (Object.keys(monthlyData).length === 0) {
                monthlyContainer.innerHTML = '<p class="text-gray-500 text-sm">Nessuna transazione mensile</p>';
            } else {
                Object.entries(monthlyData)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .forEach(([month, data]) => {
                        const balance = data.income - data.expenses;
                        monthlyContainer.innerHTML += `
                            <div class="p-3 border rounded-lg">
                                <div class="flex justify-between mb-2">
                                    <span class="font-medium">${month}</span>
                                    <span class="${balance >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(balance)}</span>
                                </div>
                                <div class="flex gap-2 text-sm">
                                    <span class="text-green-600">+${formatCurrency(data.income)}</span>
                                    <span class="text-red-600">-${formatCurrency(data.expenses)}</span>
                                </div>
                            </div>
                        `;
                    });
            }
        }
    }
    // Rendi accessibili globalmente per debug
    window.transactions = transactions;
    window.renderReports = renderReports;
    window.shoppingList = shoppingList;
    window.budget = budget;
    window.userProfile = userProfile;


    // ==================== STORE FUNCTIONS - CORRETTE ====================
    function findNearbyStores() {
    // Determina quale indirizzo/posizione usare
    if (currentLocationType === 'current') {
        if (currentCoords) {
            // Usa le coordinate gi√† ottenute
            showScreen('shopping');
            setTimeout(() => {
                renderNearbyStoresWithCoords(currentCoords.lat, currentCoords.lon);
            }, 100);
            return;
        } else {
            showToast('üìç Ottenimento posizione...');
            getCurrentPosition();
            // Dopo aver ottenuto la posizione, la funzione verr√† richiamata
            setTimeout(() => {
                if (currentCoords) {
                    findNearbyStores();
                }
            }, 2000);
            return;
        }
    }
    
    // Altrimenti usa l'indirizzo (casa o lavoro)
    let address = '';
    if (currentLocationType === 'home') {
        address = userProfile.homeFullAddress;
        if (!address) {
            showToast('‚ö†Ô∏è Imposta prima il tuo indirizzo di casa nel profilo');
            showScreen('profile');
            return;
        }
    } else if (currentLocationType === 'work') {
        address = userProfile.workFullAddress;
        if (!address) {
            showToast('‚ö†Ô∏è Imposta prima il tuo indirizzo di lavoro nel profilo');
            showScreen('profile');
            return;
        }
    }
    
    showScreen('shopping');
    setTimeout(() => {
        renderNearbyStores(); // La tua funzione esistente che usa l'indirizzo
    }, 100);
}

async function renderNearbyStores() {
    const container = document.getElementById('nearby-stores');
    const searchBtn = document.getElementById('search-stores-btn');
    
    // üî• OTTIENI LE TRADUZIONI
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    const originalBtnText = searchBtn.innerHTML;
    searchBtn.innerHTML = `<div class="store-loader"></div> ${t['searching'] || 'Ricerca in corso...'}`;
    searchBtn.disabled = true;
    
    container.innerHTML = `<p class="text-center text-gray-500 py-4">üîç ${t['searching-nearby'] || 'Cerco negozi nelle vicinanze...'}</p>`;
    
    try {
        if (!userProfile.homeFullAddress) {
            throw new Error('Indirizzo non impostato');
        }
        
        // Ottieni coordinate (geocoding)
        let lat = userProfile.homeLat;
        let lon = userProfile.homeLon;
        
        if (!lat || !lon) {
            const coords = await geocodeAddress(userProfile.homeFullAddress);
            if (!coords) throw new Error('Indirizzo non trovato');
            
            lat = coords.lat;
            lon = coords.lon;
            
            // Salva per futuro uso
            userProfile.homeLat = lat;
            userProfile.homeLon = lon;
            localStorage.setItem('smart_billing_profile_v2', JSON.stringify(userProfile));
        }
        
        // Cerca negozi
        const shops = await findNearbyShops(lat, lon);

        if (shops.length > 0) {
            updateStoresFromOSM(shops);
        }
        
        container.innerHTML = '';
        
        // Header indirizzo - TRADOTTO
        container.innerHTML += `
            <div class="p-3 bg-blue-50 rounded-lg mb-4">
                <p class="text-sm text-gray-600">${t['searching-near'] || 'Negozi vicino a:'}</p>
                <p class="font-semibold text-blue-800">${userProfile.homeFullAddress}</p>
            </div>
        `;
        
        if (shops.length === 0) {
            container.innerHTML += `
                <div class="text-center py-8">
                    <i class="fas fa-store-slash text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-500">${t['no-stores-found'] || 'Nessun negozio trovato nel raggio di'} ${OSM_CONFIG.SEARCH_RADIUS/1000}${t['km'] || 'km'}</p>
                </div>
            `;
        } else {
            // Calcola e ordina per distanza
            const shopsWithDistance = shops.map(shop => {
                const distance = calculateDistance(
                    lat, lon,
                    parseFloat(shop.lat || shop.center?.lat || 0),
                    parseFloat(shop.lon || shop.center?.lon || 0)
                );
                return { ...shop, distance };
            }).sort((a, b) => a.distance - b.distance);
            
            shopsWithDistance.forEach(shop => {
                // üî• TUTTI I TESTI TRADOTTI
                const name = shop.tags?.name || shop.tags?.brand || t['store'] || 'Negozio';
                const type = shop.tags?.shop || 'generico';
                const distanceValue = shop.distance;
                const distance = distanceValue < 1 ? 
                    `${Math.round(distanceValue * 1000)}${t['m'] || 'm'}` : 
                    `${distanceValue.toFixed(1)}${t['km'] || 'km'}`;
                const address = shop.tags?.['addr:street'] ? 
                    `${shop.tags['addr:street']} ${shop.tags['addr:housenumber'] || ''}`.trim() : 
                    (t['address-not-available'] || 'Indirizzo non disponibile');
                
                container.innerHTML += `
                    <div class="p-4 border rounded-lg mb-3 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-800">${name}</p>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                        ${getShopTypeTranslation(type)}
                                    </span>
                                    <span class="text-sm text-gray-600">
                                        <i class="fas fa-road mr-1"></i>${distance}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-500 mt-2">
                                    <i class="fas fa-map-pin mr-1"></i>${address}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML += `
                <div class="mt-4 text-xs text-gray-400 text-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    ${t['osm-credit'] || 'Dati ¬© contributori OpenStreetMap'}
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fas fa-exclamation-triangle text-4xl mb-3"></i>
                <p>${error.message === 'Indirizzo non impostato' ? 
                    (t['set-address-message'] || 'Imposta il tuo indirizzo nel profilo') : 
                    (t['search-error'] || 'Errore nella ricerca dei negozi')}</p>
                <button onclick="showScreen('profile')" 
                        class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                    ${t['go-to-profile'] || 'Vai al Profilo'}
                </button>
            </div>
        `;
    } finally {
        searchBtn.innerHTML = originalBtnText;
        searchBtn.disabled = false;
    }
}
    // Funzione per stimare il prezzo di un prodotto non nel database
    function estimatePriceForItem(itemName, storeName) {
        const itemLower = itemName.toLowerCase();
        
        // Prima cerca nel database dei prezzi
        if (storePrices[storeName] && storePrices[storeName][itemLower]) {
            return storePrices[storeName][itemLower];
        }
        
        // Se non trovato, cerca prodotti simili
        let estimatedPrice = 5.00; // Prezzo di default
        
        // Cerca per categorie simili
        if (itemLower.includes('pane') || itemLower.includes('biscotti') || itemLower.includes('crackers')) {
            estimatedPrice = storePrices[storeName]?.['pane'] || 2.00;
        } else if (itemLower.includes('latte') || itemLower.includes('yogurt') || itemLower.includes('formaggio')) {
            estimatedPrice = storePrices[storeName]?.['latte'] || 1.50;
        } else if (itemLower.includes('frutta') || itemLower.includes('verdura')) {
            estimatedPrice = storePrices[storeName]?.['frutta'] || 3.00;
        } else if (itemLower.includes('carne') || itemLower.includes('pollo') || itemLower.includes('pesce')) {
            estimatedPrice = storePrices[storeName]?.['carne'] || 10.00;
        } else if (itemLower.includes('acqua') || itemLower.includes('succo') || itemLower.includes('bevanda')) {
            estimatedPrice = storePrices[storeName]?.['acqua'] || 0.50;
        }
        
        return estimatedPrice;
    }

    // Mostra consigli di ottimizzazione
    function showOptimizationTips() {
        const lang = userProfile?.language || 'it';
        const t = getTranslations(lang);
        const uncheckedItems = shoppingList.filter(item => !item.checked);
        
        if (uncheckedItems.length === 0) {
            showToast(`‚ö†Ô∏è ${t['empty-list-warning'] || 'La lista della spesa √® vuota'}`);
            return;
        }
        
        let message = `üí° ${t['shopping-tips'] || 'CONSIGLI PER LA SPESA'}:\n\n`;
        
        // Suggerisci ottimizzazione in base al numero di prodotti
        if (uncheckedItems.length <= 3) {
            message += `‚Ä¢ ${t['few-products'] || 'Hai pochi prodotti: acquista tutto nello stesso negozio'}\n`;
            message += `‚Ä¢ ${t['choose-nearest'] || 'Scegli il negozio pi√π vicino per risparmiare tempo'}\n`;
        } else if (uncheckedItems.length <= 8) {
            message += `‚Ä¢ ${t['consider-fewest'] || 'Considera l\'ottimizzazione \'Meno negozi\''}\n`;
            message += `‚Ä¢ ${t['save-time'] || 'Risparmierai tempo visitando meno punti vendita'}\n`;
        } else {
            message += `‚Ä¢ ${t['use-balanced'] || 'Usa l\'ottimizzazione \'Bilanciata\' per il miglior compromesso'}\n`;
            message += `‚Ä¢ ${t['use-lowest'] || 'O \'Prezzo pi√π basso\' per risparmiare di pi√π'}\n`;
        }
        
        message += `\nüìä ${t['statistics'] || 'STATISTICHE'}:\n`;
        message += `‚Ä¢ ${t['products-to-buy'] || 'Prodotti da acquistare'}: ${uncheckedItems.length}\n`;
        
        // Calcola il prezzo totale stimato
        const totalPrice = uncheckedItems.reduce((sum, item) => sum + (item.bestPrice || 0), 0);
        message += `‚Ä¢ ${t['estimated-total'] || 'Prezzo totale stimato'}: ${formatCurrency(totalPrice)}\n`;
        
        // Trova il negozio con pi√π prodotti
        const storeProductCount = {};
        uncheckedItems.forEach(item => {
            if (item.bestStore) {
                storeProductCount[item.bestStore] = (storeProductCount[item.bestStore] || 0) + 1;
            }
        });
        
        const bestStore = Object.entries(storeProductCount).sort((a, b) => b[1] - a[1])[0];
        if (bestStore) {
            message += `‚Ä¢ ${t['best-single-store'] || 'Migliore negozio unico'}: ${bestStore[0]} (${bestStore[1]} ${t['products-count'] || 'prodotti'})\n`;
        }
        
        alert(message);
    }
// Aggiungi queste funzioni prima di initApp()
function acceptSuggestion(original, corrected) {
    closeSuggestionModal();
    addShoppingItemInternal(corrected, true);
}

// ==================== FUNZIONI AGGIUNTE ====================

function addDuplicateProduct(productName) {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    closeSuggestionModal();
    
    // Forza l'aggiunta nonostante il duplicato
    const priceInfo = findBestPriceForItem(productName);
    
    shoppingList.push({
        id: Date.now(),
        name: productName,
        checked: false,
        bestPrice: priceInfo.bestPrice,
        bestStore: priceInfo.bestStore,
        prices: priceInfo.prices,
        recognized: priceInfo.recognized
    });
    
    document.getElementById('shopping-item').value = '';
    renderShoppingList();
    showToast(`üõí ${productName} ${t['added-duplicate'] || 'aggiunto (duplicato)'} - ${formatCurrency(priceInfo.bestPrice)}`);
}
      // ==================== APPLICA LINGUA ALL'INTERFACCIA ====================
      function applyLanguageSettings() {
    console.log('üöÄ applyLanguageSettings INIZIO');
    console.log('userProfile:', userProfile);

    // Se userProfile non esiste, esci
    if (!userProfile) {
        console.log('‚ö†Ô∏è userProfile non definito - ESCE');
        return;
    }
    
    console.log('‚úÖ userProfile definito, proseguo');
    updateCurrencyLabel();
    
    const lang = userProfile.language || 'it';
    console.log('üåê Applico lingua:', lang);
    const t = getTranslations(lang);

    
    // 1. Traduci elementi con data-translate
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        if (t[key]) {
            element.textContent = t[key];
        }
    });
    
    // 2. Traduci placeholder
    document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
        const key = element.getAttribute('data-translate-placeholder');
        if (t[key]) {
            element.placeholder = t[key];
        }
    });
    
    // 3. Traduci titoli
    document.querySelectorAll('[data-translate-title]').forEach(element => {
        const key = element.getAttribute('data-translate-title');
        if (t[key]) {
            element.title = t[key];
        }
    });
    
    // ==================== TRADUZIONI ESTESE ====================
    
    // 1. Dashboard - Elementi principali
    const subtitle = document.querySelector('p.text-gray-500.mt-2');
    if (subtitle && t['app-subtitle']) {
        subtitle.textContent = t['app-subtitle'];
    }
    
    // 2. Card labels
    const labels = document.querySelectorAll('.text-gray-500.text-sm.uppercase');
    if (labels.length >= 4) {
        if (t['income']) labels[0].textContent = t['income'];
        if (t['expenses']) labels[1].textContent = t['expenses'];
        if (t['balance']) labels[2].textContent = t['balance'];
        if (t['budget']) labels[3].textContent = t['budget'];
    }
    
    // 3. Sezione "Entrate - Uscite" nella card saldo
    const incomeExpenseText = document.querySelector('.card-balance .text-sm.text-gray-500');
    if (incomeExpenseText && t['income-minus-expenses']) {
        const icon = incomeExpenseText.querySelector('i');
        if (icon) {
            incomeExpenseText.innerHTML = `<i class="fas fa-info-circle mr-1"></i> ${t['income-minus-expenses']}`;
        } else {
            incomeExpenseText.textContent = t['income-minus-expenses'];
        }
    }
    
        // 4. Bottoni principali
document.querySelectorAll('button').forEach(button => {
    const html = button.innerHTML;
    
    // Bottoni della dashboard
    if (html.includes('Aggiungi Entrata') || html.includes('Add income') || html.includes('A√±adir ingreso') || html.includes('Ajouter un revenu') || html.includes('Einkommen hinzuf√ºgen') || html.includes('AdaugƒÉ venit')) {
        button.innerHTML = `<i class="fas fa-plus"></i> ${t['add-income']}`;
    }
    if (html.includes('Aggiungi Uscita') || html.includes('Add expense') || html.includes('A√±adir gasto') || html.includes('Ajouter une d√©pense') || html.includes('Ausgabe hinzuf√ºgen') || html.includes('AdaugƒÉ cheltuialƒÉ')) {
        button.innerHTML = `<i class="fas fa-plus"></i> ${t['add-expense']}`;
    }
    if (html.includes('Gestisci Budget') || html.includes('Manage Budget') || html.includes('Gestionar Presupuesto') || html.includes('G√©rer Budget') || html.includes('Budget verwalten') || html.includes('GestioneazƒÉ Buget')) {
        button.innerHTML = `<i class="fas fa-cog"></i> ${t['budget']}`;
    }
    if (html.includes('Vedi tutte') || html.includes('View details') || html.includes('Ver detalles') || html.includes('Voir les d√©tails') || html.includes('Details anzeigen') || html.includes('Vezi detalii')) {
        button.innerHTML = `${t['view-details']} ‚Üí`;
    }
    if (html.includes('Aggiungi Nuova Transazione') || html.includes('Add New Transaction') || html.includes('A√±adir Nueva Transacci√≥n') || html.includes('Ajouter Nouvelle Transaction') || html.includes('Neue Transaktion hinzuf√ºgen') || html.includes('AdaugƒÉ Tranzac»õie NouƒÉ')) {
        button.innerHTML = `<i class="fas fa-plus mr-2"></i>${t['new-transaction']}`;
    }
    
    // TITOLI nei bottoni (p.font-semibold)
    const titleSpans = button.querySelectorAll('p.font-semibold');
    titleSpans.forEach(span => {
        const text = span.textContent;
        
        if (text.includes('Lista Spesa') || text.includes('Shopping List') || text.includes('Lista de Compras') || text.includes('Liste de Courses') || text.includes('Einkaufsliste') || text.includes('Lista de CumpƒÉrƒÉturi')) {
            span.textContent = t['shopping-list'];
        }
        if (text.includes('Uscita Generica') || text.includes('Generic Expense') || text.includes('Gasto Gen√©rico') || text.includes('D√©pense G√©n√©rique') || text.includes('Allgemeine Ausgabe') || text.includes('CheltuialƒÉ GenericƒÉ')) {
            span.textContent = t['generic-expense'];
        }
        if (text.includes('Report e Grafici') || text.includes('Reports') || text.includes('Informes') || text.includes('Rapports') || text.includes('Berichte') || text.includes('Rapoarte')) {
            span.textContent = t['reports'];
        }
    });
    
    // ASSICURA CHE LE DESCRIZIONI ABBIANO DATA-TRANSLATE
    const descSpans = button.querySelectorAll('p.text-sm.text-gray-500');
    descSpans.forEach(span => {
        const text = span.textContent;
        
        // Se non ha gi√† data-translate, glielo aggiungiamo in base al testo ITALIANO
        if (!span.hasAttribute('data-translate')) {
            if (text.includes('Aggiungi articoli da acquistare') || text.includes('Add items to buy')) {
                span.setAttribute('data-translate', 'add-shopping-items');
            }
            else if (text.includes('Bollette, ristorante, carburante') || text.includes('Bills, restaurant, fuel')) {
                span.setAttribute('data-translate', 'bills-restaurant');
            }
            else if (text.includes('Visualizza statistiche') || text.includes('View statistics')) {
                span.setAttribute('data-translate', 'view-stats');
            }
        }
        
        // Applica la traduzione se ha data-translate
        const key = span.getAttribute('data-translate');
        if (key && t[key]) {
            span.textContent = t[key];
        }
    });
});
       
        // 5. Testi dinamici
        const shoppingCount = shoppingList.filter(item => !item.checked).length;
        const shoppingCountEl = document.getElementById('shopping-count');
        if (shoppingCountEl) {
            const itemsText = t['items'] || 'articoli';
            shoppingCountEl.textContent = `${shoppingCount} ${itemsText}`;
        }
        
        // 6. Placeholder
        const placeholders = document.querySelectorAll('input[placeholder]');
        placeholders.forEach(input => {
            const placeholder = input.getAttribute('placeholder');
            if (placeholder) {
                if (placeholder.includes('Cosa devi comprare') || placeholder.includes('What do you need to buy')) {
                    input.placeholder = t['shopping-placeholder'];
                }
                if (placeholder.includes('Stipendio, Bonus') || placeholder.includes('Salary, Bonus')) {
                    input.placeholder = t['description-placeholder-income'];
                }
                if (placeholder.includes('Cena, Benzina') || placeholder.includes('Dinner, Gas')) {
                    input.placeholder = t['description-placeholder-expense'];
                }
            }
        });
        
        // 7. Imposta la lingua sul tag html
        document.documentElement.lang = lang;
        
        // 8. Aggiorna i testi dinamici delle transazioni
        updateRecentTransactionsText();
        
        // 9. Traduci TUTTE le schermate
        translateAllScreens();
        
        // 10. Menu a tendina e fix vari
        translateCategoryDropdowns();
        translateSelectPlaceholders();
        fixBalanceTranslation();
        renderBudget();
        fixAmountLabel();
        
        // üî• FORZA TRADUZIONE ASSOLUTA PER LE DESCRIZIONI
console.log('üîç CERCO DESCRIZIONI DA TRADURRE...');

// Trova TUTTI gli elementi con data-translate nella schermata di scelta
const allTranslatableInChoice = document.querySelectorAll('#screen-expense-choice [data-translate]');
console.log(`Trovati ${allTranslatableInChoice.length} elementi con data-translate in screen-expense-choice`);

allTranslatableInChoice.forEach(el => {
    const key = el.getAttribute('data-translate');
    console.log(`- Elemento con chiave: "${key}", testo attuale: "${el.textContent}"`);
    
    if (t[key]) {
        el.textContent = t[key];
        console.log(`  ‚úÖ Tradotto in: "${el.textContent}"`);
    } else {
        console.log(`  ‚ùå Chiave "${key}" non trovata nel dizionario per lingua ${lang}`);
    }
});

// In particolare, cerca le descrizioni che ci interessano
const billsElements = document.querySelectorAll('[data-translate="bills-restaurant"]');
console.log(`Trovati ${billsElements.length} elementi con data-translate="bills-restaurant"`);
billsElements.forEach(el => {
    if (t['bills-restaurant']) {
        el.textContent = t['bills-restaurant'];
        console.log(`‚úÖ bills-restaurant tradotto in: "${el.textContent}"`);
    }
});

const shoppingItemsElements = document.querySelectorAll('[data-translate="add-shopping-items"]');
console.log(`Trovati ${shoppingItemsElements.length} elementi con data-translate="add-shopping-items"`);
shoppingItemsElements.forEach(el => {
    if (t['add-shopping-items']) {
        el.textContent = t['add-shopping-items'];
        console.log(`‚úÖ add-shopping-items tradotto in: "${el.textContent}"`);
    }
});
        console.log('‚úÖ Lingua applicata e schermate tradotte');
        console.log('üî¥ applyLanguageSettings FINE');
    }
// ==================== TRADUZIONE MENU A TENDINA ====================
function translateCategoryDropdowns() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    console.log('üîÑ Traduco menu a tendina categorie in:', lang);
    
    // Traduci menu entrate
    const incomeSelect = document.getElementById('income-category');
    if (incomeSelect) {
        Array.from(incomeSelect.options).forEach(option => {
            const key = option.getAttribute('data-translate');
            if (key && t[key]) {
                option.textContent = t[key];
            }
        });
        console.log('‚úÖ Menu entrate tradotto');
    }
    
    // Traduci menu uscite
    const expenseSelect = document.getElementById('expense-category');
    if (expenseSelect) {
        Array.from(expenseSelect.options).forEach(option => {
            const key = option.getAttribute('data-translate');
            if (key && t[key]) {
                option.textContent = t[key];
            }
        });
        console.log('‚úÖ Menu uscite tradotto');
    }
    
    // Traduci anche i menu dei budget se presenti
    const budgetCategorySelects = document.querySelectorAll('[id^="budget-category-"]');
    budgetCategorySelects.forEach(select => {
        Array.from(select.options).forEach(option => {
            const key = option.getAttribute('data-translate');
            if (key && t[key]) {
                option.textContent = t[key];
            }
        });
    });
}
// ==================== TRADUZIONE PLACEHOLDER SELECT ====================
function translateSelectPlaceholders() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    // Traduci il placeholder del select entrate
    const incomeSelect = document.getElementById('income-category');
    if (incomeSelect && t['select-category']) {
        // Se vuoi un'opzione placeholder "Seleziona categoria"
        const placeholderOption = incomeSelect.querySelector('option[value=""]');
        if (placeholderOption) {
            placeholderOption.textContent = t['select-category'];
        }
    }
    
    // Traduci il placeholder del select uscite
    const expenseSelect = document.getElementById('expense-category');
    if (expenseSelect && t['select-category']) {
        const placeholderOption = expenseSelect.querySelector('option[value=""]');
        if (placeholderOption) {
            placeholderOption.textContent = t['select-category'];
        }
    }
}

// ==================== TRADUZIONE COMPLETA INTERFACCIA ====================
function translateAllScreens() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    console.log('üåê Traduco interfaccia in:', lang);
    
    // DEBUG - Controllo schermate
    console.log('screen-add-income:', document.getElementById('screen-add-income') ? 'TROVATO' : 'NON TROVATO');
    console.log('screen-add-expense:', document.getElementById('screen-add-expense') ? 'TROVATO' : 'NON TROVATO');
    console.log('screen-shopping:', document.getElementById('screen-shopping') ? 'TROVATO' : 'NON TROVATO');
    console.log('screen-budget:', document.getElementById('screen-budget') ? 'TROVATO' : 'NON TROVATO');
    
    // ===== SCHERMATA NUOVA ENTRATA =====
    const incomeScreen = document.getElementById('screen-add-income');
    if (incomeScreen) {
        // Titolo - FORZA MODIFICA
        const title = incomeScreen.querySelector('h2.text-xl');
        if (title) {
            title.innerHTML = `<i class="fas fa-money-bill-wave text-green-500 mr-2"></i>${t['new-income'] || 'NUOVA ENTRATA'}`;
            console.log('‚úÖ Titolo entrata modificato:', title.innerHTML);
        }
        
        // Sottotitolo
        const subtitle = incomeScreen.querySelector('p.text-gray-500.mb-6');
        if (subtitle) subtitle.textContent = t['register-income'] || 'Registra una nuova entrata';
        
        // Placeholder
        const descInput = incomeScreen.querySelector('#income-desc');
        if (descInput) descInput.placeholder = t['description-placeholder-income'] || 'Stipendio, Bonus, Vendita...';
        
        // Bottone salva
        const saveBtn = incomeScreen.querySelector('button.btn-income');
        if (saveBtn) saveBtn.innerHTML = `<i class="fas fa-save mr-2"></i>${t['save-income'] || 'Salva Entrata'}`;
        
        // Bottone annulla
        const cancelBtn = incomeScreen.querySelector('button.bg-gray-200');
        if (cancelBtn) cancelBtn.innerHTML = `${t['cancel'] || 'Annulla'}`;
        
        // Bottone back
        const backBtn = incomeScreen.querySelector('button.flex.items-center.gap-2');
        if (backBtn) backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${t['back-to-dashboard'] || 'Torna alla Dashboard'}`;
    }
    
    // ===== SCHERMATA NUOVA USCITA =====
    const expenseScreen = document.getElementById('screen-add-expense');
    if (expenseScreen) {
        // Titolo
        const title = expenseScreen.querySelector('h2.text-xl');
        if (title) {
            title.innerHTML = `<i class="fas fa-receipt text-red-500 mr-2"></i>${t['new-expense'] || 'NUOVA USCITA'}`;
            console.log('‚úÖ Titolo uscita modificato:', title.innerHTML);
        }
        
        // Sottotitolo
        const subtitle = expenseScreen.querySelector('p.text-gray-500.mb-6');
        if (subtitle) subtitle.textContent = t['register-expense'] || 'Registra una nuova spesa';
        
        // Placeholder
        const descInput = expenseScreen.querySelector('#expense-desc');
        if (descInput) descInput.placeholder = t['description-placeholder-expense'] || 'Cena, Benzina, Bolletta...';
        
        // Bottone salva
        const saveBtn = expenseScreen.querySelector('button.btn-expense');
        if (saveBtn) saveBtn.innerHTML = `<i class="fas fa-save mr-2"></i>${t['save-expense'] || 'Salva Uscita'}`;
        
        // Bottone back
        const backBtn = expenseScreen.querySelector('button.flex.items-center.gap-2');
        if (backBtn) backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${t['back-to-dashboard'] || 'Torna alla Dashboard'}`;
    }
    
    // ===== SCHERMATA LISTA SPESA =====
const shoppingScreen = document.getElementById('screen-shopping');
if (shoppingScreen) {
    // Titolo principale
    const title = shoppingScreen.querySelector('.bg-white.rounded-xl.shadow.p-6 h2.text-xl');
    if (title) {
        title.innerHTML = `<i class="fas fa-shopping-basket text-green-500 mr-2"></i>${t['shopping-list'] || 'LISTA SPESA'}`;
        console.log('‚úÖ Titolo lista spesa modificato:', title.innerHTML);
    }
    
    // Placeholder input
    const input = shoppingScreen.querySelector('#shopping-item');
    if (input) input.placeholder = t['shopping-placeholder'] || 'Cosa devi comprare?';
    
    // üî• NUOVO: Titolo Ottimizza Acquisti
    const optimizeTitle = shoppingScreen.querySelector('#optimization-section h3');
    if (optimizeTitle) {
        optimizeTitle.innerHTML = `<i class="fas fa-chart-line text-purple-500 mr-2"></i>${t['optimize-purchases'] || 'OTTIMIZZA ACQUISTI'}`;
        console.log('‚úÖ Titolo ottimizzazione modificato:', optimizeTitle.innerHTML);
    }
    
    // üî• NUOVO: Card ottimizzazione - TITOLI
    const cardTitles = shoppingScreen.querySelectorAll('.optimization-card p.font-bold');
    if (cardTitles.length >= 3) {
        if (cardTitles[0]) cardTitles[0].textContent = t['lowest-price'] || 'Prezzo pi√π basso';
        if (cardTitles[1]) cardTitles[1].textContent = t['fewest-stores'] || 'Meno negozi';
        if (cardTitles[2]) cardTitles[2].textContent = t['optimized'] || 'Ottimizzato';
        console.log('‚úÖ Card ottimizzazione titoli modificati');
    }
    
    // üî• NUOVO: Card ottimizzazione - DESCRIZIONI
    const cardDescs = shoppingScreen.querySelectorAll('.optimization-card p.text-sm');
    if (cardDescs.length >= 3) {
        if (cardDescs[0]) cardDescs[0].textContent = t['min-total'] || 'Spesa minima totale';
        if (cardDescs[1]) cardDescs[1].textContent = t['fewer-stores'] || 'Visita meno punti vendita';
        if (cardDescs[2]) cardDescs[2].textContent = t['price-stores-balanced'] || 'Prezzo e negozi bilanciati';
        console.log('‚úÖ Card ottimizzazione descrizioni modificate');
    }
    
    // üî• NUOVO: Titolo Negozi Vicini
    const storesTitle = shoppingScreen.querySelector('.bg-white.rounded-xl.shadow.p-6 h2:not(.text-xl)');
    if (storesTitle) {
        storesTitle.innerHTML = `<i class="fas fa-store text-blue-500 mr-2"></i>${t['nearby-stores'] || 'NEGOZI VICINI'}`;
        console.log('‚úÖ Titolo negozi vicini modificato:', storesTitle.innerHTML);
    }
    
    // üî• NUOVO: Bottone Cerca Negozi
    const searchBtn = shoppingScreen.querySelector('#search-stores-btn');
    if (searchBtn) {
        searchBtn.innerHTML = `<i class="fas fa-search mr-2"></i>${t['find-nearby-stores'] || 'Cerca Negozi Vicini'}`;
        console.log('‚úÖ Bottone cerca negozi modificato');
    }
    
    // Bottone back
    const backBtn = shoppingScreen.querySelector('button.flex.items-center.gap-2');
    if (backBtn) backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${t['back-to-dashboard'] || 'Torna alla Dashboard'}`;
}
// ===== SCHERMATA SCELTA TIPO USCITA =====
const choiceScreen = document.getElementById('screen-expense-choice');
if (choiceScreen) {
    const title = choiceScreen.querySelector('h2.text-xl');
    if (title) {
        title.innerHTML = `<i class="fas fa-shopping-cart text-red-500 mr-2"></i>${t['add-expense'] || 'Aggiungi Uscita'}`;
        console.log('‚úÖ Titolo scelta uscita modificato:', title.innerHTML);
    }
    
    const subtitle = choiceScreen.querySelector('p.text-gray-500.mb-8');
    if (subtitle) subtitle.textContent = t['choose-expense-type'] || 'Cosa vuoi aggiungere?';
    
    // Bottone Lista Spesa
    const shoppingBtn = choiceScreen.querySelector('button[onclick*="showScreen(\'shopping\')"] p.font-bold');
    if (shoppingBtn) shoppingBtn.textContent = t['shopping-list'] || 'Lista della Spesa';
    
    // Bottone Uscita Generica
    const expenseBtn = choiceScreen.querySelector('button[onclick*="showScreen(\'add-expense\')"] p.font-bold');
    if (expenseBtn) expenseBtn.textContent = t['generic-expense'] || 'Uscita Generica';
    
    const backBtn = choiceScreen.querySelector('button.flex.items-center.gap-2');
    if (backBtn) backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${t['back-to-dashboard'] || 'Torna alla Dashboard'}`;
}
    
    // ===== SCHERMATA BUDGET =====
    const budgetScreen = document.getElementById('screen-budget');
    if (budgetScreen) {
        const title = budgetScreen.querySelector('h2.text-xl');
        if (title) {
            title.innerHTML = `<i class="fas fa-piggy-bank text-purple-500 mr-2"></i>${t['budget-management'] || 'GESTIONE BUDGET'}`;
            console.log('‚úÖ Titolo budget modificato:', title.innerHTML);
        }
        
        const subtitle = budgetScreen.querySelector('p.text-gray-500.mb-6');
        if (subtitle) subtitle.textContent = t['set-monthly-budgets'] || 'Imposta i budget mensili per categoria';
        
        const button = budgetScreen.querySelector('button.w-full.py-3');
        if (button) button.innerHTML = `<i class="fas fa-check mr-2"></i>${t['confirm-budget'] || 'Conferma Budget'}`;
        
        const backBtn = budgetScreen.querySelector('button.flex.items-center.gap-2');
        if (backBtn) backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${t['back-to-dashboard'] || 'Torna alla Dashboard'}`;
    }
    
    // ===== SCHERMATA PROFILO =====
const profileScreen = document.getElementById('screen-profile');
if (profileScreen) {
    // Titolo principale
    const title = profileScreen.querySelector('h2.text-xl');
    if (title) {
        title.innerHTML = `<i class="fas fa-user text-blue-500 mr-2"></i>${t['your-profile'] || 'IL TUO PROFILO'}`;
        console.log('‚úÖ Titolo profilo modificato:', title.innerHTML);
    }
    
    // Sottotitolo
    const subtitle = profileScreen.querySelector('p.text-gray-500.mb-6');
    if (subtitle) subtitle.textContent = t['configure-data'] || 'Configura i tuoi dati per un\'esperienza personalizzata';
    
    // üî• TRADUCI TUTTE LE ETICHETTE DEI CAMPI
    const labels = profileScreen.querySelectorAll('label');
    labels.forEach(label => {
        const text = label.textContent.trim();
        
        // Dati Personali
        if (text.includes('Nome') || text.includes('First Name') || text.includes('Prenume')) {
            label.textContent = t['name'] + ' *';
        }
        else if (text.includes('Cognome') || text.includes('Last Name') || text.includes('Nume')) {
            label.textContent = t['surname'] + ' *';
        }
        else if (text.includes('Email')) {
            label.textContent = t['email'] + ' *';
        }
        
        // Indirizzo Casa
        else if (text.includes('Via') || text.includes('Street') || text.includes('StradƒÉ')) {
            label.textContent = t['street'] + ' *';
        }
        else if (text.includes('Numero') || text.includes('Number') || text.includes('NumƒÉr')) {
            label.textContent = t['number'] + ' *';
        }
        else if (text.includes('Citt√†') || text.includes('City') || text.includes('Ora»ô')) {
            label.textContent = t['city'] + ' *';
        }
        else if (text.includes('Provincia') || text.includes('Province') || text.includes('Provincie')) {
            label.textContent = t['province'] + ' *';
        }
        else if (text.includes('Paese') || text.includes('Country') || text.includes('»öarƒÉ')) {
            label.textContent = t['country'] + ' *';
        }
        
        // Indirizzo Lavoro
        else if (text.includes('Via') && text.includes('Lavoro')) {
            label.textContent = t['street'];
        }
        else if (text.includes('Numero') && text.includes('Lavoro')) {
            label.textContent = t['number'];
        }
        else if (text.includes('Citt√†') && text.includes('Lavoro')) {
            label.textContent = t['city'];
        }
        else if (text.includes('Provincia') && text.includes('Lavoro')) {
            label.textContent = t['province'];
        }
        else if (text.includes('Paese') && text.includes('Lavoro')) {
            label.textContent = t['country'];
        }
        else if (text.includes('Nome Azienda') || text.includes('Company') || text.includes('Companie')) {
            label.textContent = t['company'];
        }
        
        // Preferenze Internazionali
        else if (text.includes('Lingua Preferita') || text.includes('Preferred Language') || text.includes('Limba PreferatƒÉ')) {
            label.innerHTML = `<i class="fas fa-language mr-1"></i>${t['preferred-language']} *`;
        }
        else if (text.includes('Valuta Predefinita') || text.includes('Default Currency') || text.includes('Moneda ImplicitƒÉ')) {
            label.innerHTML = `<i class="fas fa-money-bill-wave mr-1"></i>${t['default-currency']} *`;
        }
    });
    
    // üî• TRADUCI I TITOLI DELLE SEZIONI
    const sectionTitles = profileScreen.querySelectorAll('h3.text-lg');
    sectionTitles.forEach(section => {
        const html = section.innerHTML;
        if (html.includes('Dati Personali') || html.includes('Personal Data') || html.includes('Date Personale')) {
            section.innerHTML = `<i class="fas fa-id-card mr-2"></i>${t['personal-data']}`;
        }
        else if (html.includes('Indirizzo di Casa') || html.includes('Home Address') || html.includes('Adresa de Domiciliu')) {
            section.innerHTML = `<i class="fas fa-home mr-2"></i>${t['home-address']}`;
        }
        else if (html.includes('Indirizzo di Lavoro') || html.includes('Work Address') || html.includes('Adresa de MuncƒÉ')) {
            section.innerHTML = `<i class="fas fa-briefcase mr-2"></i>${t['work-address']}`;
        }
        else if (html.includes('Preferenze Internazionali') || html.includes('International Preferences') || html.includes('Preferin»õe Interna»õionale')) {
            section.innerHTML = `<i class="fas fa-globe mr-2"></i>${t['international-preferences']}`;
        }
    });
    
    // üî• TRADUCI I BOTTONI
    const buttons = profileScreen.querySelectorAll('button');
    buttons.forEach(button => {
        const html = button.innerHTML;
        if (html.includes('Salva Profilo') || html.includes('Save Profile') || html.includes('SalveazƒÉ Profil')) {
            button.innerHTML = `<i class="fas fa-save"></i> ${t['save-profile'] || 'Save Profile'}`;
        }
        else if (html.includes('Annulla') || html.includes('Cancel') || html.includes('AnuleazƒÉ')) {
            button.innerHTML = `<i class="fas fa-times"></i> ${t['cancel'] || 'Cancel'}`;
        }
        else if (html.includes('Torna alla Dashboard') || html.includes('Back to Dashboard') || html.includes('√énapoi la Tablou de bord')) {
            button.innerHTML = `<i class="fas fa-arrow-left"></i> ${t['back-to-dashboard'] || 'Back to Dashboard'}`;
        }
    });
    
    // üî• TRADUCI L'ANTEPRIMA VALUTA
    const previewLabel = profileScreen.querySelector('#currency-preview p.text-sm');
    if (previewLabel && t['formatting-preview']) {
        previewLabel.textContent = t['formatting-preview'] + ':';
    }
    
    console.log('‚úÖ Profilo tradotto completamente');
}
    
    // ===== SCHERMATA TRANSAZIONI =====
    const transactionsScreen = document.getElementById('screen-transactions');
    if (transactionsScreen) {
        const title = transactionsScreen.querySelector('h2.text-xl');
        if (title) {
            title.innerHTML = `<i class="fas fa-exchange-alt mr-2"></i>${t['all-transactions'] || 'TUTTE LE TRANSAZIONI'}`;
            console.log('‚úÖ Titolo transazioni modificato:', title.innerHTML);
        }
        
        const backBtn = transactionsScreen.querySelector('button.flex.items-center.gap-2');
        if (backBtn) backBtn.innerHTML = `<i class="fas fa-arrow-left"></i> ${t['back-to-dashboard'] || 'Torna alla Dashboard'}`;
    }
    // üî• ALLA FINE, proteggi il pulsante viola
    const registerBtn = document.querySelector('button[onclick="showRegisterPurchases()"] span[data-translate="register-checked"]');
    if (registerBtn) {
        // Salva la traduzione corrente
        const currentText = registerBtn.textContent;
        
        // Dopo un millisecondo, ripristinala (nel caso qualcosa l'abbia sovrascritta)
        setTimeout(() => {
            const lang = userProfile?.language || 'it';
            const t = getTranslations(lang);
            if (t['register-checked']) {
                registerBtn.textContent = t['register-checked'];
            }
        }, 10);
    }
    
    console.log('‚úÖ Traduzione completata');
}

// Funzione helper per ottenere le traduzioni
// Funzione helper per ottenere le traduzioni
// Funzione helper per ottenere le traduzioni
function getTranslations(lang) {
    const translations = {
        'it': {
            'shopping-list': 'Lista della Spesa',
            'shopping-placeholder': 'Cosa devi comprare?',
            'optimize-purchases': 'Ottimizza Acquisti',
            'lowest-price': 'Prezzo pi√π basso',
            'fewest-stores': 'Meno negozi',
            'optimized': 'Ottimizzato',
            'nearby-stores': 'Negozi Vicini',
            'find-nearby-stores': 'Cerca Negozi Vicini',
            'budget-management': 'Gestione Budget',
            'set-monthly-budgets': 'Imposta i budget mensili per categoria',
            'confirm-budget': 'Conferma Budget',
            'your-profile': 'Il Tuo Profilo',
            'configure-data': 'Configura i tuoi dati per un\'esperienza personalizzata',
            'all-transactions': 'Tutte le Transazioni',
            'new-income': 'Nuova Entrata',
            'register-income': 'Registra una nuova entrata',
            'new-expense': 'Nuova Uscita',
            'register-expense': 'Registra una nuova spesa',
            'save-income': 'Salva Entrata',
            'save-expense': 'Salva Uscita',
            'description-placeholder-income': 'Stipendio, Bonus, Vendita...',
            'description-placeholder-expense': 'Cena, Benzina, Bolletta...',
            'cancel': 'Annulla',
            'back-to-dashboard': 'Torna alla Dashboard',
            'min-total': 'Spesa minima totale',
            'fewer-stores': 'Visita meno punti vendita',
            'price-stores-balanced': 'Prezzo e negozi bilanciati',
            'choose-expense-type': 'Cosa vuoi aggiungere?',
            'generic-expense': 'Uscita Generica',
            'add-expense': 'Aggiungi Uscita',
            'back-to-choice': 'Torna alla scelta',
            'save-profile': 'Salva Profilo',
            'email': 'Email',
            'price-button': 'Prezzi',
            'duplicate-product': 'Prodotto Duplicato',
            'check-product': 'Controlla il Prodotto',
            'you-entered': 'Hai inserito:',
            'already-in-list': 'Questo prodotto √® gi√† nella lista!',
            'add-anyway': 'Aggiungi comunque (duplicato)',
            'cancel': 'Annulla',
            'perhaps-you-meant': 'Forse intendevi:',
            'use-as-is': 'Usa "{product}" cos√¨ com\'√®',
            'product-not-recognized': 'Prodotto non riconosciuto',
            'not-in-database': '"{product}" non √® nel nostro database. Verr√† aggiunto con prezzo di default.',
            'add-product': 'Aggiungi "{product}"',
            'edit': 'Modifica',
            'close': 'Chiudi',
            'duplicate-product': 'Produs Duplicat',
            'check-product': 'VerificƒÉ Produsul',
            'you-entered': 'Ai introdus:',
            'already-in-list': 'Acest produs este deja √Æn listƒÉ!',
            'add-anyway': 'AdaugƒÉ oricum (duplicat)',
            'perhaps-you-meant': 'Poate ai vrut sƒÉ spui:',
            'use-as-is': 'Folose»ôte "{product}" a»ôa cum este',
            'product-not-recognized': 'Produs nerecunoscut',
            'not-in-database': '"{product}" nu este √Æn baza noastrƒÉ de date. Va fi adƒÉugat cu pre»õ implicit.',
            'add-product': 'AdaugƒÉ "{product}"',
            'edit': 'EditeazƒÉ',
            'close': '√énchide',
            'balance': 'Saldo',
            'set-address-message': 'Imposta il tuo indirizzo nel profilo per trovare negozi',
            'name': 'Nome',
            'surname': 'Cognome',
            'email': 'Email',
            'street': 'Via',
            'number': 'Numero',
            'city': 'Citt√†',
            'province': 'Provincia',
            'country': 'Paese',
            'company': 'Nome Azienda',
            'personal-data': 'Dati Personali',
            'home-address': 'Indirizzo di Casa',
            'work-address': 'Indirizzo di Lavoro',
            'international-preferences': 'Preferenze Internazionali',
            'preferred-language': 'Lingua Preferita',
            'default-currency': 'Valuta Predefinita',
            'formatting-preview': 'Anteprima formattazione',
            'save-profile': 'Salva Profilo',
            'salary': 'Stipendio',
            'bonus': 'Bonus',
            'investments': 'Investimenti',
            'rental-income': 'Rendite',
            'food': 'Alimentari',
            'utilities': 'Bollette',
            'transport': 'Trasporti',
            'entertainment': 'Svago',
            'health': 'Salute',
            'shopping': 'Shopping',
            'rent': 'Affitto',
            'mortgage': 'Mutuo',  // NUOVA!
            'select-category': 'Seleziona categoria',  // per IT
            'first-name': 'Nome',           // per IT
            'last-name': 'Cognome',         // per IT
            'used-for-stores': 'Usato per trovare negozi',  // per IT
            'optional': 'Facoltativo',      // per IT
            'amount-with-currency': 'Importo (‚Ç¨)', // per IT
            'income-placeholder': 'Stipendio, Bonus, Vendita...', // per IT
            'current-spending': 'Spesa attuale',        // per IT
            'products': 'prodotti',              // IT
            'total-price': 'Prezzo Totale',      // IT
            'not-available': 'Questi prodotti non sono disponibili nei negozi selezionati',  // IT
            'not-covered': 'non sono coperti da questa soluzione',  // IT
            'missing-products': 'prodotti mancanti',     // IT
            'attention': 'Attenzione',           // IT
            'store-total': 'Totale negozio',     // IT
            'covered': 'coperti',                // IT
            'apply-solution': 'Applica questa soluzione',
            'reports': 'Report e Grafici',
            'view-stats': 'Visualizza statistiche',
            'expenses-by-category': 'Spese per Categoria',
            'expenses-by-store': 'Spese per Negozio',
            'monthly-trend': 'Andamento Mensile',
            'no-store-data': 'Nessun dato negozio disponibile',
            'estimated-prices': 'Prezzi stimati',
            'estimated-warning': 'Alcuni prezzi sono stimati. Per un\'ottimizzazione accurata, correggi i prezzi manualmente.',
            'quantity': 'Quantit√†',              // IT
            'store': 'Negozio',                  // IT
            'select-store': '-- Seleziona un negozio --',
            'add-new-store': '‚ûï Aggiungi nuovo negozio',
            'price-optional': 'Prezzo (opzionale)',
            'price-auto-hint': 'Se non inserisci un prezzo, verr√† usato il miglior prezzo disponibile',
            'confirm': 'Conferma',
            'add-product-title': 'Aggiungi {product}',
            'search-location': 'Cerca negozi vicino a:',
            'home': 'Casa',
            'work': 'Lavoro',
            'current-location': 'Posizione attuale',
            'searching-near': 'Cerco negozi vicino a:',
            'set-address-message': 'Imposta il tuo indirizzo nel profilo per trovare negozi',
            'find-nearby-stores': 'Cerca Negozi Vicini',
            'searching': 'Ricerca in corso...',
            'searching-nearby': 'Cerco negozi nelle vicinanze...',
            'no-stores-found': 'Nessun negozio trovato nel raggio di',
            'address-not-available': 'Indirizzo non disponibile',
            'osm-credit': 'Dati ¬© contributori OpenStreetMap',
            'search-error': 'Errore nella ricerca dei negozi',
            'go-to-profile': 'Vai al Profilo',
            'getting-location': 'Ottenimento posizione...',
            'location-obtained': 'Posizione ottenuta',
            'location-not-supported': 'Geolocalizzazione non supportata',
            'location-permission-denied': 'Permesso negato',
            'location-timeout': 'Timeout',
            'location-error': 'Errore nel ottenere la posizione',
            'geocoding': 'Cerco coordinate...',
            'address-not-found': 'Indirizzo non trovato',
            'work-address-not-set': 'Imposta prima l\'indirizzo di lavoro nel profilo',
            'searching-near': 'Cerco negozi vicino a:',
            'set-address-message': 'Imposta il tuo indirizzo nel profilo per trovare negozi',
            'address-not-available': 'Indirizzo non disponibile',
            'store': 'Negozio',
            'supermarket': 'Supermercato',
            'searching': 'Ricerca in corso...',
            'km': 'km',
            'm': 'm',
            'supermarket': 'Supermercato',
            'convenience': 'Alimentari',
            'grocery': 'Drogheria',
            'greengrocer': 'Fruttivendolo',
            'butcher': 'Macelleria',
            'bakery': 'Panetteria',
            'chemist': 'Drogeria',
            'pharmacy': 'Farmacia',
            'department_store': 'Grande magazzino',
            'reset-all-data': 'Cancella tutti i dati',
            'confirm-reset': '‚ö†Ô∏è Sei sicuro? Tutti i dati verranno cancellati!',
            // NUOVE CHIAVI PER ITALIANO
            'app-subtitle': 'Gestisci le tue finanze in modo intelligente',
            'incomes': 'Entrate',
            'expenses': 'Uscite',
            'add-income': 'Aggiungi Entrata',
            'add-expense': 'Aggiungi Uscita',
            'view-all': 'Vedi tutte',
            'shopping': 'Lista Spesa',
            'items': 'articoli',
            'back-to-dashboard': 'Torna alla Dashboard',
            'cancel': 'Annulla',
            'what-to-add': 'Cosa vuoi aggiungere?',
            'add-shopping-items': 'Aggiungi articoli da acquistare',
            'generic-expense': 'Uscita Generica',
            'bills-restaurant': 'Bollette, ristorante, carburante...',
            'back-to-choice': 'Torna alla scelta',
            'new-expense': 'Nuova Uscita',
            'register-expense': 'Registra una nuova spesa',
            'shopping-list': 'Lista della Spesa',
            'register-checked': 'Registra acquisti spuntati',
            'optimization-result': 'Risultato Ottimizzazione',
            'total-price': 'Prezzo Totale',
            'stores': 'Negozi',
            'register-purchases': 'Registra Acquisti',
            'modify-prices': 'Modifica prezzi e conferma gli acquisti',
            'scan-receipt': 'Scansiona scontrino con fotocamera',
            'camera-hint': 'Usa la fotocamera per leggere automaticamente prezzi e prodotti',
            'confirm-purchases': 'Conferma Acquisti',
            'budget-management': 'Gestione Budget',
            'set-monthly-budgets': 'Imposta i budget mensili per categoria',
            'confirm-budget': 'Conferma Budget',
            'your-profile': 'Il Tuo Profilo',
            'configure-data': 'Configura i tuoi dati per un\'esperienza personalizzata',
            'all-transactions': 'Tutte le Transazioni',
            // NUOVE CHIAVI PER ITALIANO
            'empty-list': 'La lista √® vuota',
            'all-purchased': 'Tutti gli articoli sono stati acquistati',
            'searching-prices': 'Cerca prezzi...',
            'unrecognized': 'Non riconosciuto',
            'correct-price': 'Correggi',
            'empty-list-warning': 'La lista della spesa √® vuota',
            'min-total-desc': 'Ogni prodotto acquistato al prezzo minimo disponibile',
            'fewer-stores-desc': 'Visita meno punti vendita possibile',
            'price-stores-balanced-desc': 'Prezzo e negozi bilanciati',
            'covers': 'Copre',
            'of': 'di',
            'units': 'unit√†',
            'not-covered': 'non sono coperti da questa soluzione',
            'covered': 'coperti',
            // PER TUTTE LE LINGUE
            'fill-fields': 'Compila tutti i campi correttamente',
            'income-registered': 'Entrata registrata con successo!',
            'expense-registered': 'Uscita registrata!',
            'price-saved': 'Prezzo di',
            'saved-for': 'salvato per',
            'added': 'aggiunto',
            'item-removed': 'Articolo rimosso',
            'purchases-registered': 'acquisti registrati!',
            'profile-saved': 'Profilo salvato!',
            'language': 'Lingua',
            'currency': 'Valuta',
            'confirm-reset': '‚ö†Ô∏è Sei sicuro? Tutti i dati verranno cancellati!',
            'enter-item-name': 'Inserisci un nome per l\'articolo',
            'product-not-recognized-short': 'Prodotto non riconosciuto. Usa un nome valido.',
            'searching-best-price': 'Cerco il miglior prezzo...',
            'unit': 'Unit√† di misura',
                'piece': 'pezzo/i',
                'kg': 'kg',
                'g': 'g',
                'l': 'l',
                'ml': 'ml',
                'bottle': 'bottiglia/e',
                'pack': 'confezione/i',
            'reset-history': 'Cancella storico records',
            'bills-restaurant': 'Bollette, ristorante, carburante...',
            'manage-budget': 'Gestisci Budget',
            'back-to-shopping-list': 'Torna alla Lista',
            'correct-price-for': 'Correggi prezzo per',
            'price': 'Prezzo',
            'store': 'Negozio',
            'select-store': '-- Seleziona un negozio --',
            'add-new-store': '‚ûï Aggiungi nuovo negozio',
            'save': 'Salva',
            'no-prices': 'Nessun prezzo disponibile per questo articolo',
            'prices-for': 'Prezzi per',
            'unrecognized-estimated': 'Prodotto non riconosciuto - Prezzi stimati',
            'estimated': 'stimato',
            'best-price': 'Miglior prezzo',
            'estimated-warning-short': 'Alcuni prezzi sono stimati in base a prodotti simili',
            'manage-budget': 'Gestisci Budget',
            'back-to-shopping-list': 'Torna alla Lista',
            // NUOVE CHIAVI PER ITALIANO
            'store-not-found': 'Errore: selettore negozio non trovato',
            'select-store-warning': 'Seleziona un negozio',
            'no-checked-items': 'Nessun articolo spuntato da registrare',
            'quantity-label': 'Quantit√†:',
            'price-placeholder': 'Prezzo',
            'store-placeholder': 'Negozio',
            'expense-description': 'Spesa:',
            'store-generic': 'Negozio',
            'camera-not-supported': 'Fotocamera non supportata su questo dispositivo',
            'scan-title': 'Scansione scontrino',
            'scan-choose': 'Scegli come acquisire lo scontrino:',
            'use-camera': 'Usa fotocamera',
            'scan-realtime': 'Scansiona in tempo reale',
            'upload-image': 'Carica immagine',
            'select-existing': 'Seleziona uno scontrino gi√† fotografato',
            'start-camera': 'Avvio fotocamera...',
            'frame-receipt': 'Inquadra lo scontrino',
            'capture': 'Acquisisci',
            'camera-error': 'Impossibile accedere alla fotocamera',
            'analyzing': 'Analisi scontrino in corso...',
            'no-items-to-register': 'Nessun articolo da registrare',
            'receipt-processed': 'Scontrino elaborato! Verifica i prezzi',
            'no-transactions-registered': 'Nessuna transazione registrata',
            'shopping-tips': 'CONSIGLI PER LA SPESA',
            'few-products': 'Hai pochi prodotti: acquista tutto nello stesso negozio',
            'choose-nearest': 'Scegli il negozio pi√π vicino per risparmiare tempo',
            'consider-fewest': 'Considera l\'ottimizzazione \'Meno negozi\'',
            'save-time': 'Risparmierai tempo visitando meno punti vendita',
            'use-balanced': 'Usa l\'ottimizzazione \'Bilanciata\' per il miglior compromesso',
            'use-lowest': 'O \'Prezzo pi√π basso\' per risparmiare di pi√π',
            'statistics': 'STATISTICHE',
            'products-to-buy': 'Prodotti da acquistare',
            'estimated-total': 'Prezzo totale stimato',
            'best-single-store': 'Migliore negozio unico',
            'products-count': 'prodotti',
            'added-duplicate': 'aggiunto (duplicato)',
            'budget-exceeds-income': 'Budget superiore alle entrate',
            'review-budget': 'Rivedi il budget o aggiungi entrate',
            'description': 'Descrizione',
            'category': 'Categoria',
            'date': 'Data',
            'amount': 'Importo',
            'income-minus-expenses': 'Entrate - Uscite',
            'suggestion': 'Suggerimento',
            'recent-transactions': 'Ultime Transazioni',
            'view-all': 'Vedi tutte',
            'add-new-transaction': 'Aggiungi Nuova Transazione',
            'no-transactions': 'Nessuna transazione',
            'other': 'Altro',
        },
        'en': {
            'shopping-list': 'Shopping List',
            'shopping-placeholder': 'What do you need to buy?',
            'optimize-purchases': 'Optimize Purchases',
            'lowest-price': 'Lowest price',
            'fewest-stores': 'Fewest stores',
            'optimized': 'Optimized',
            'nearby-stores': 'Nearby Stores',
            'find-nearby-stores': 'Find Nearby Stores',
            'budget-management': 'Budget Management',
            'set-monthly-budgets': 'Set monthly budgets by category',
            'confirm-budget': 'Confirm Budget',
            'your-profile': 'Your Profile',
            'configure-data': 'Configure your data for a personalized experience',
            'all-transactions': 'All Transactions',
            'new-income': 'New Income',
            'register-income': 'Register a new income',
            'new-expense': 'New Expense',
            'register-expense': 'Register a new expense',
            'save-income': 'Save Income',
            'save-expense': 'Save Expense',
            'description-placeholder-income': 'Salary, Bonus, Sale...',
            'description-placeholder-expense': 'Dinner, Gas, Bill...',
            'cancel': 'Cancel',
            'back-to-dashboard': 'Back to Dashboard',
            'min-total': 'Minimum total expense',
            'fewer-stores': 'Visit fewer stores',
            'price-stores-balanced': 'Price and stores balanced',
            'choose-expense-type': 'What do you want to add?',
            'generic-expense': 'Generic Expense',
            'add-expense': 'Add Expense',
            'back-to-choice': 'Back to choice',
            'save-profile': 'Save Profile',
            'email': 'Email',
            'price-button': 'Prices',
            'duplicate-product': 'Duplicate Product',
            'check-product': 'Check Product',
            'you-entered': 'You entered:',
            'already-in-list': 'This product is already in the list!',
            'add-anyway': 'Add anyway (duplicate)',
            'cancel': 'Cancel',
            'perhaps-you-meant': 'Perhaps you meant:',
            'use-as-is': 'Use "{product}" as is',
            'product-not-recognized': 'Product not recognized',
            'not-in-database': '"{product}" is not in our database. It will be added with default price.',
            'add-product': 'Add "{product}"',
            'edit': 'Edit',
            'close': 'Close',
            'balance': 'Balance',
            'set-address-message': 'Set your address in the profile to find stores',
            'name': 'First Name',
            'surname': 'Last Name',
            'email': 'Email',
            'street': 'Street',
            'number': 'Number',
            'city': 'City',
            'province': 'Province',
            'country': 'Country',
            'company': 'Company Name',
            'personal-data': 'Personal Data',
            'home-address': 'Home Address',
            'work-address': 'Work Address',
            'international-preferences': 'International Preferences',
            'preferred-language': 'Preferred Language',
            'default-currency': 'Default Currency',
            'formatting-preview': 'Formatting preview',
            'save-profile': 'Save Profile',
            'salary': 'Salary',
            'bonus': 'Bonus',
            'investments': 'Investments',
            'rental-income': 'Rental Income',
            'food': 'Food',
            'utilities': 'Utilities',
            'transport': 'Transport',
            'entertainment': 'Entertainment',
            'health': 'Health',
            'shopping': 'Shopping',
            'rent': 'Rent',
            'mortgage': 'Mortgage',  // NUOVA!
            'select-category': 'Select category',      // per EN
            'first-name': 'First Name',     // per EN
            'last-name': 'Last Name',       // per EN
            'used-for-stores': 'Used to find stores',       // per EN
            'optional': 'Optional',         // per EN
            'amount-with-currency': 'Amount (‚Ç¨)',  // per EN
            'income-placeholder': 'Salary, Bonus, Sale...',       // per EN
            'current-spending': 'Current spending',     // per EN
            'products': 'products',              // EN
            'covered': 'covered',                // EN
            'store-total': 'Store total',        // EN
            'attention': 'Attention',            // EN
            'missing-products': 'missing products',      // EN
            'not-covered': 'are not covered by this solution',      // EN
            'not-available': 'These products are not available in selected stores',          // EN
            'total-price': 'Total Price',        // EN
            'apply-solution': 'Apply this solution',
            'reports': 'Reports & Charts',
            'view-stats': 'View statistics',
            'expenses-by-category': 'Expenses by Category',
            'expenses-by-store': 'Expenses by Store',
            'monthly-trend': 'Monthly Trend',
            'no-store-data': 'No store data available',
            'estimated-prices': 'Estimated prices',
            'estimated-warning': 'Some prices are estimated. For accurate optimization, correct the prices manually.',
            'quantity': 'Quantity',              // EN
            'store': 'Store',                    // EN
            'select-store': '-- Select a store --',
            'add-new-store': '‚ûï Add new store',
            'price-optional': 'Price (optional)',
            'price-auto-hint': 'If you leave this empty, the best available price will be used',
            'confirm': 'Confirm',
            'add-product-title': 'Add {product}',
            'search-location': 'Search stores near:',
            'home': 'Home',
            'work': 'Work',
            'current-location': 'Current location',
            'searching-near': 'Searching stores near:',
            'set-address-message': 'Set your address in the profile to find stores',
            'find-nearby-stores': 'Find Nearby Stores',
            'searching': 'Searching...',
            'searching-nearby': 'Searching for nearby stores...',
            'no-stores-found': 'No stores found within',
            'address-not-available': 'Address not available',
            'osm-credit': 'Data ¬© OpenStreetMap contributors',
            'search-error': 'Error searching for stores',
            'go-to-profile': 'Go to Profile',
            'getting-location': 'Getting location...',
            'location-obtained': 'Location obtained',
            'location-not-supported': 'Geolocation not supported',
            'location-permission-denied': 'Permission denied',
            'location-timeout': 'Timeout',
            'location-error': 'Error getting location',
            'geocoding': 'Searching coordinates...',
            'address-not-found': 'Address not found',
            'work-address-not-set': 'Set your work address in the profile first',
            'searching-near': 'Searching stores near:',
            'set-address-message': 'Set your address in the profile to find stores',
            'address-not-available': 'Address not available',
            'store': 'Store',
            'supermarket': 'Supermarket',
            'searching': 'Searching...',
            'km': 'km',
            'm': 'm',
            'supermarket': 'Supermarket',
            'convenience': 'Convenience store',
            'grocery': 'Grocery',
            'greengrocer': 'Greengrocer',
            'butcher': 'Butcher',
            'bakery': 'Bakery',
            'chemist': 'Chemist',
            'pharmacy': 'Pharmacy',
            'department_store': 'Department store',
            'reset-all-data': 'Delete all data',
            'confirm-reset': '‚ö†Ô∏è Are you sure? All data will be deleted!',
            // NEW KEYS FOR ENGLISH
            'app-subtitle': 'Manage your finances intelligently',
            'incomes': 'Income',
            'expenses': 'Expenses',
            'add-income': 'Add Income',
            'add-expense': 'Add Expense',
            'view-all': 'View all',
            'shopping': 'Shopping List',
            'items': 'items',
            'back-to-dashboard': 'Back to Dashboard',
            'cancel': 'Cancel',
            'what-to-add': 'What do you want to add?',
            'add-shopping-items': 'Add items to buy',
            'generic-expense': 'Generic Expense',
            'bills-restaurant': 'Bills, restaurant, fuel...',
            'back-to-choice': 'Back to choice',
            'new-expense': 'New Expense',
            'register-expense': 'Register a new expense',
            'shopping-list': 'Shopping List',
            'register-checked': 'Register checked purchases',
            'optimization-result': 'Optimization Result',
            'total-price': 'Total Price',
            'stores': 'Stores',
            'register-purchases': 'Register Purchases',
            'modify-prices': 'Modify prices and confirm purchases',
            'scan-receipt': 'Scan receipt with camera',
            'camera-hint': 'Use camera to automatically read prices and products',
            'confirm-purchases': 'Confirm Purchases',
            'budget-management': 'Budget Management',
            'set-monthly-budgets': 'Set monthly budgets by category',
            'confirm-budget': 'Confirm Budget',
            'your-profile': 'Your Profile',
            'configure-data': 'Configure your data for a personalized experience',
            'all-transactions': 'All Transactions',
            // NEW KEYS FOR ENGLISH
            'empty-list': 'The list is empty',
            'all-purchased': 'All items have been purchased',
            'searching-prices': 'Searching for prices...',
            'unrecognized': 'Unrecognized',
            'correct-price': 'Correct',
            'empty-list-warning': 'The shopping list is empty',
            'min-total-desc': 'Each product purchased at the lowest available price',
            'fewer-stores-desc': 'Visit as few stores as possible',
            'price-stores-balanced-desc': 'Balanced price and number of stores',
            'covers': 'Covers',
            'of': 'of',
            'units': 'units',
            'not-covered': 'are not covered by this solution',
            'covered': 'covered',
            'fill-fields': 'Please fill all fields correctly',
            'income-registered': 'Income registered successfully!',
            'expense-registered': 'Expense registered!',
            'price-saved': 'Price of',
            'saved-for': 'saved for',
            'added': 'added',
            'item-removed': 'Item removed',
            'purchases-registered': 'purchases registered!',
            'profile-saved': 'Profile saved!',
            'language': 'Language',
            'currency': 'Currency',
            'confirm-reset': '‚ö†Ô∏è Are you sure? All data will be deleted!',
            'enter-item-name': 'Enter an item name',
            'product-not-recognized-short': 'Product not recognized. Use a valid name.',
            'searching-best-price': 'Searching for the best price...',
            'unit': 'Unit',
            'piece': 'piece(s)',
            'kg': 'kg',
            'g': 'g',
            'l': 'l',
            'ml': 'ml',
            'bottle': 'bottle(s)',
            'pack': 'pack(s)',
            'reset-history': 'Delete history records',
            'bills-restaurant': 'Bills, restaurant, fuel...',
            'manage-budget': 'Manage Budget',
            'back-to-shopping-list': 'Back to List',
            'correct-price-for': 'Correct price for',
            'price': 'Price',
            'store': 'Store',
            'select-store': '-- Select a store --',
            'add-new-store': '‚ûï Add new store',
            'save': 'Save',
            'no-prices': 'No prices available for this item',
            'prices-for': 'Prices for',
            'unrecognized-estimated': 'Unrecognized product - Estimated prices',
            'estimated': 'estimated',
            'best-price': 'Best price',
            'estimated-warning-short': 'Some prices are estimated based on similar products',
            'manage-budget': 'Manage Budget',
            'back-to-shopping-list': 'Back to List',
            // NEW KEYS FOR ENGLISH
            'store-not-found': 'Error: store selector not found',
            'select-store-warning': 'Select a store',
            'no-checked-items': 'No checked items to register',
            'quantity-label': 'Quantity:',
            'price-placeholder': 'Price',
            'store-placeholder': 'Store',
            'expense-description': 'Expense:',
            'store-generic': 'Store',
            'camera-not-supported': 'Camera not supported on this device',
            'scan-title': 'Receipt Scan',
            'scan-choose': 'Choose how to capture the receipt:',
            'use-camera': 'Use camera',
            'scan-realtime': 'Scan in real time',
            'upload-image': 'Upload image',
            'select-existing': 'Select an already photographed receipt',
            'start-camera': 'Starting camera...',
            'frame-receipt': 'Frame the receipt',
            'capture': 'Capture',
            'camera-error': 'Unable to access camera',
            'analyzing': 'Analyzing receipt...',
            'no-items-to-register': 'No items to register',
            'receipt-processed': 'Receipt processed! Check prices',
            'no-transactions-registered': 'No transactions registered',
            'shopping-tips': 'SHOPPING TIPS',
            'few-products': 'You have few products: buy everything in the same store',
            'choose-nearest': 'Choose the nearest store to save time',
            'consider-fewest': 'Consider the \'Fewest stores\' optimization',
            'save-time': 'You will save time by visiting fewer stores',
            'use-balanced': 'Use \'Balanced\' optimization for the best compromise',
            'use-lowest': 'Or \'Lowest price\' to save more',
            'statistics': 'STATISTICS',
            'products-to-buy': 'Products to buy',
            'estimated-total': 'Estimated total price',
            'best-single-store': 'Best single store',
            'products-count': 'products',
            'added-duplicate': 'added (duplicate)',
            'budget-exceeds-income': 'Budget exceeds income',
            'review-budget': 'Review your budget or add income',
            'description': 'Description',
            'category': 'Category',
            'date': 'Date',
            'amount': 'Amount',
            'income-minus-expenses': 'Income - Expenses',
            'suggestion': 'Suggestion',
            'recent-transactions': 'Recent Transactions',
            'view-all': 'View all',
            'add-new-transaction': 'Add New Transaction',
            'no-transactions': 'No transactions',
            'other': 'Other',
        },
        'es': {
            'shopping-list': 'Lista de Compras',
            'shopping-placeholder': '¬øQu√© necesitas comprar?',
            'optimize-purchases': 'Optimizar Compras',
            'lowest-price': 'Precio m√°s bajo',
            'fewest-stores': 'Menos tiendas',
            'optimized': 'Optimizado',
            'nearby-stores': 'Tiendas Cercanas',
            'find-nearby-stores': 'Buscar Tiendas Cercanas',
            'budget-management': 'Gesti√≥n de Presupuesto',
            'set-monthly-budgets': 'Establece presupuestos mensuales por categor√≠a',
            'confirm-budget': 'Confirmar Presupuesto',
            'your-profile': 'Tu Perfil',
            'configure-data': 'Configura tus datos para una experiencia personalizada',
            'all-transactions': 'Todas las Transacciones',
            'new-income': 'Nuevo Ingreso',
            'register-income': 'Registra un nuevo ingreso',
            'new-expense': 'Nuevo Gasto',
            'register-expense': 'Registra un nuevo gasto',
            'save-income': 'Guardar Ingreso',
            'save-expense': 'Guardar Gasto',
            'description-placeholder-income': 'Salario, Bono, Venta...',
            'description-placeholder-expense': 'Cena, Gasolina, Factura...',
            'cancel': 'Cancelar',
            'back-to-dashboard': 'Volver al Panel',
            'min-total': 'Gasto m√≠nimo total',
            'fewer-stores': 'Visita menos tiendas',
            'price-stores-balanced': 'Precio y tiendas equilibrados',
            'choose-expense-type': '¬øQu√© quieres a√±adir?',
            'generic-expense': 'Gasto Gen√©rico',
            'add-expense': 'A√±adir Gasto',
            'back-to-choice': 'Volver a la selecci√≥n',
            'save-profile': 'Guardar Perfil',
            'email': 'Correo electr√≥nico',
            'price-button': 'Precios',
            'duplicate-product': 'Producto Duplicado',
            'check-product': 'Verificar Producto',
            'you-entered': 'Has introducido:',
            'already-in-list': '¬°Este producto ya est√° en la lista!',
            'add-anyway': 'A√±adir de todos modos (duplicado)',
            'cancel': 'Cancelar',
            'perhaps-you-meant': 'Quiz√°s quisiste decir:',
            'use-as-is': 'Usar "{product}" tal cual',
            'product-not-recognized': 'Producto no reconocido',
            'not-in-database': '"{product}" no est√° en nuestra base de datos. Se a√±adir√° con precio por defecto.',
            'add-product': 'A√±adir "{product}"',
            'edit': 'Editar',
            'close': 'Cerrar',
            'balance': 'Saldo',
            'set-address-message': 'Configura tu direcci√≥n en el perfil para encontrar tiendas',
            'name': 'Nombre',
            'surname': 'Apellido',
            'email': 'Correo electr√≥nico',
            'street': 'Calle',
            'number': 'N√∫mero',
            'city': 'Ciudad',
            'province': 'Provincia',
            'country': 'Pa√≠s',
            'company': 'Nombre de la Empresa',
            'personal-data': 'Datos Personales',
            'home-address': 'Direcci√≥n de Casa',
            'work-address': 'Direcci√≥n de Trabajo',
            'international-preferences': 'Preferencias Internacionales',
            'preferred-language': 'Idioma Preferido',
            'default-currency': 'Moneda Predeterminada',
            'formatting-preview': 'Vista previa de formato',
            'save-profile': 'Guardar Perfil',
            'salary': 'Salario',
            'bonus': 'Bono',
            'investments': 'Inversiones',
            'rental-income': 'Ingresos por alquiler',
            'food': 'Alimentos',
            'utilities': 'Servicios',
            'transport': 'Transporte',
            'entertainment': 'Ocio',
            'health': 'Salud',
            'shopping': 'Compras',
            'rent': 'Alquiler',
            'mortgage': 'Hipoteca',  // NUOVA!
            'select-category': 'Seleccionar categor√≠a', // per ES
            'select-category': 'Seleccionar categor√≠a',
            'first-name': 'Nombre',
            'last-name': 'Apellido',
            'used-for-stores': 'Usado para encontrar tiendas',
            'optional': 'Opcional',
            'amount-with-currency': 'Importe (‚Ç¨)',
            'income-placeholder': 'Salario, Bono, Venta...',
            'expense-placeholder': 'Cena, Gasolina, Factura...',
            'current-spending': 'Gasto actual',         // per ES
            'products': 'productos',             // ES
            'total-price': 'Precio Total',       // ES
            'not-available': 'Estos productos no est√°n disponibles en las tiendas seleccionadas', // ES
            'not-covered': 'no est√°n cubiertos por esta soluci√≥n',  // ES
            'missing-products': 'productos faltantes',   // ES
            'attention': 'Atenci√≥n',             // ES
            'store-total': 'Total tienda',       // ES
            'covered': 'cubiertos',              // ES
            'apply-solution': 'Aplicar esta soluci√≥n',
            'reports': 'Informes y Gr√°ficos',
            'view-stats': 'Ver estad√≠sticas',
            'expenses-by-category': 'Gastos por Categor√≠a',
            'expenses-by-store': 'Gastos por Tienda',
            'monthly-trend': 'Tendencia Mensual',
            'no-store-data': 'No hay datos de tiendas',
            'estimated-prices': 'Precios estimados',
            'estimated-warning': 'Algunos precios son estimados. Para una optimizaci√≥n precisa, corrige los precios manualmente.',
            'quantity': 'Cantidad',
            'store': 'Tienda',
            'select-store': '-- Selecciona una tienda --',
            'add-new-store': '‚ûï A√±adir nueva tienda',
            'price-optional': 'Precio (opcional)',
            'price-auto-hint': 'Si no introduces un precio, se usar√° el mejor precio disponible',
            'confirm': 'Confirmar',
            'add-product-title': 'A√±adir {product}',
            'search-location': 'Buscar tiendas cerca de:',
            'home': 'Casa',
            'work': 'Trabajo',
            'current-location': 'Ubicaci√≥n actual',
            'searching-near': 'Buscando tiendas cerca de:',
            'set-address-message': 'Configura tu direcci√≥n en el perfil para encontrar tiendas',
            'find-nearby-stores': 'Buscar Tiendas Cercanas',
            'searching': 'Buscando...',
            'searching-nearby': 'Buscando tiendas cercanas...',
            'no-stores-found': 'No se encontraron tiendas en un radio de',
            'address-not-available': 'Direcci√≥n no disponible',
            'osm-credit': 'Datos ¬© colaboradores de OpenStreetMap',
            'search-error': 'Error al buscar tiendas',
            'go-to-profile': 'Ir al Perfil',
            'getting-location': 'Obteniendo ubicaci√≥n...',
            'location-obtained': 'Ubicaci√≥n obtenida',
            'location-not-supported': 'Geolocalizaci√≥n no soportada',
            'location-permission-denied': 'Permiso denegado',
            'location-timeout': 'Tiempo de espera agotado',
            'location-error': 'Error al obtener la ubicaci√≥n',
            'geocoding': 'Buscando coordenadas...',
            'address-not-found': 'Direcci√≥n no encontrada',
            'work-address-not-set': 'Configura primero tu direcci√≥n de trabajo en el perfil',
            'searching-near': 'Buscando tiendas cerca de:',
            'set-address-message': 'Configura tu direcci√≥n en el perfil para encontrar tiendas',
            'address-not-available': 'Direcci√≥n no disponible',
            'store': 'Tienda',
            'supermarket': 'Supermercado',
            'searching': 'Buscando...',
            'km': 'km',
            'm': 'm',
            'supermarket': 'Supermercado',
            'convenience': 'Tienda de conveniencia',
            'grocery': 'Tienda de comestibles',
            'greengrocer': 'Fruter√≠a',
            'butcher': 'Carnicer√≠a',
            'bakery': 'Panader√≠a',
            'chemist': 'Droguer√≠a',
            'pharmacy': 'Farmacia',
            'department_store': 'Grandes almacenes',
            'reset-all-data': 'Borrar todos los datos',
            'confirm-reset': '‚ö†Ô∏è ¬øEst√°s seguro? ¬°Todos los datos ser√°n borrados!',
            // NUEVAS CLAVES PARA ESPA√ëOL
            'app-subtitle': 'Gestiona tus finanzas de manera inteligente',
            'incomes': 'Ingresos',
            'expenses': 'Gastos',
            'add-income': 'A√±adir Ingreso',
            'add-expense': 'A√±adir Gasto',
            'view-all': 'Ver todas',
            'shopping': 'Lista de Compras',
            'items': 'art√≠culos',
            'back-to-dashboard': 'Volver al Panel',
            'cancel': 'Cancelar',
            'what-to-add': '¬øQu√© quieres a√±adir?',
            'add-shopping-items': 'A√±adir art√≠culos para comprar',
            'generic-expense': 'Gasto Gen√©rico',
            'bills-restaurant': 'Facturas, restaurante, combustible...',
            'back-to-choice': 'Volver a la selecci√≥n',
            'new-expense': 'Nuevo Gasto',
            'register-expense': 'Registrar un nuevo gasto',
            'shopping-list': 'Lista de Compras',
            'register-checked': 'Registrar compras marcadas',
            'optimization-result': 'Resultado de Optimizaci√≥n',
            'total-price': 'Precio Total',
            'stores': 'Tiendas',
            'register-purchases': 'Registrar Compras',
            'modify-prices': 'Modificar precios y confirmar compras',
            'scan-receipt': 'Escanear ticket con c√°mara',
            'camera-hint': 'Usa la c√°mara para leer autom√°ticamente precios y productos',
            'confirm-purchases': 'Confirmar Compras',
            'budget-management': 'Gesti√≥n de Presupuesto',
            'set-monthly-budgets': 'Establecer presupuestos mensuales por categor√≠a',
            'confirm-budget': 'Confirmar Presupuesto',
            'your-profile': 'Tu Perfil',
            'configure-data': 'Configura tus datos para una experiencia personalizada',
            'all-transactions': 'Todas las Transacciones',
            // NUEVAS CLAVES PARA ESPA√ëOL
            'empty-list': 'La lista est√° vac√≠a',
            'all-purchased': 'Todos los art√≠culos han sido comprados',
            'searching-prices': 'Buscando precios...',
            'unrecognized': 'No reconocido',
            'correct-price': 'Corregir',
            'empty-list-warning': 'La lista de la compra est√° vac√≠a',
            'min-total-desc': 'Cada producto comprado al precio m√°s bajo disponible',
            'fewer-stores-desc': 'Visita la menor cantidad de tiendas posible',
            'price-stores-balanced-desc': 'Precio y tiendas equilibrados',
            'covers': 'Cubre',
            'of': 'de',
            'units': 'unidades',
            'not-covered': 'no est√°n cubiertos por esta soluci√≥n',
            'covered': 'cubiertos',
            'fill-fields': 'Complete todos los campos correctamente',
            'income-registered': '¬°Ingreso registrado con √©xito!',
            'expense-registered': '¬°Gasto registrado!',
            'price-saved': 'Precio de',
            'saved-for': 'guardado para',
            'added': 'a√±adido',
            'item-removed': 'Art√≠culo eliminado',
            'purchases-registered': '¬°compras registradas!',
            'profile-saved': '¬°Perfil guardado!',
            'language': 'Idioma',
            'currency': 'Moneda',
            'confirm-reset': '‚ö†Ô∏è ¬øEst√°s seguro? ¬°Todos los datos ser√°n borrados!',
            'enter-item-name': 'Introduce un nombre para el art√≠culo',
            'product-not-recognized-short': 'Producto no reconocido. Usa un nombre v√°lido.',
            'searching-best-price': 'Buscando el mejor precio...',
            'unit': 'Unidad',
            'piece': 'pieza(s)',
            'kg': 'kg',
            'g': 'g',
            'l': 'l',
            'ml': 'ml',
            'bottle': 'botella(s)',
            'pack': 'paquete(s)',
            'reset-history': 'Borrar historial de registros',
            'bills-restaurant': 'Facturas, restaurante, combustible...',
            'manage-budget': 'Gestionar Presupuesto',
            'back-to-shopping-list': 'Volver a la Lista',
            'correct-price-for': 'Corregir precio para',
            'price': 'Precio',
            'store': 'Tienda',
            'select-store': '-- Selecciona una tienda --',
            'add-new-store': '‚ûï A√±adir nueva tienda',
            'save': 'Guardar',
            'no-prices': 'No hay precios disponibles para este art√≠culo',
            'prices-for': 'Precios para',
            'unrecognized-estimated': 'Producto no reconocido - Precios estimados',
            'estimated': 'estimado',
            'best-price': 'Mejor precio',
            'estimated-warning-short': 'Algunos precios son estimados basados en productos similares',
            'manage-budget': 'Gestionar Presupuesto',
            'back-to-shopping-list': 'Volver a la Lista',
            // NUEVAS CLAVES PARA ESPA√ëOL
            'store-not-found': 'Error: selector de tienda no encontrado',
            'select-store-warning': 'Selecciona una tienda',
            'no-checked-items': 'No hay art√≠culos marcados para registrar',
            'quantity-label': 'Cantidad:',
            'price-placeholder': 'Precio',
            'store-placeholder': 'Tienda',
            'expense-description': 'Gasto:',
            'store-generic': 'Tienda',
            'camera-not-supported': 'C√°mara no compatible en este dispositivo',
            'scan-title': 'Escaneo de ticket',
            'scan-choose': 'Elige c√≥mo capturar el ticket:',
            'use-camera': 'Usar c√°mara',
            'scan-realtime': 'Escanea en tiempo real',
            'upload-image': 'Subir imagen',
            'select-existing': 'Selecciona un ticket ya fotografiado',
            'start-camera': 'Iniciando c√°mara...',
            'frame-receipt': 'Enfoca el ticket',
            'capture': 'Capturar',
            'camera-error': 'No se puede acceder a la c√°mara',
            'analyzing': 'Analizando ticket...',
            'no-items-to-register': 'No hay art√≠culos para registrar',
            'receipt-processed': '¬°Ticket procesado! Verifica los precios',
            'no-transactions-registered': 'No hay transacciones registradas',
            'shopping-tips': 'CONSEJOS DE COMPRA',
            'few-products': 'Tienes pocos productos: compra todo en la misma tienda',
            'choose-nearest': 'Elige la tienda m√°s cercana para ahorrar tiempo',
            'consider-fewest': 'Considera la optimizaci√≥n \'Menos tiendas\'',
            'save-time': 'Ahorrar√°s tiempo visitando menos tiendas',
            'use-balanced': 'Usa la optimizaci√≥n \'Equilibrada\' para el mejor compromiso',
            'use-lowest': 'O \'Precio m√°s bajo\' para ahorrar m√°s',
            'statistics': 'ESTAD√çSTICAS',
            'products-to-buy': 'Productos a comprar',
            'estimated-total': 'Precio total estimado',
            'best-single-store': 'Mejor tienda √∫nica',
            'products-count': 'productos',
            'added-duplicate': 'a√±adido (duplicado)',
            'budget-exceeds-income': 'Presupuesto superior a los ingresos',
            'review-budget': 'Revisa tu presupuesto o a√±ade ingresos',
            'description': 'Descripci√≥n',
            'category': 'Categor√≠a',
            'date': 'Fecha',
            'amount': 'Importe',
            'income-minus-expenses': 'Ingresos - Gastos',
            'suggestion': 'Sugerencia',
            'recent-transactions': '√öltimas transacciones',
            'view-all': 'Ver todas',
            'add-new-transaction': 'A√±adir nueva transacci√≥n',
            'no-transactions': 'Sin transacciones',
            'other': 'Otro',
        },
        'fr': {
            'shopping-list': 'Liste de Courses',
            'shopping-placeholder': 'Que devez-vous acheter?',
            'optimize-purchases': 'Optimiser les Achats',
            'lowest-price': 'Prix le plus bas',
            'fewest-stores': 'Moins de magasins',
            'optimized': 'Optimis√©',
            'nearby-stores': 'Magasins Proches',
            'find-nearby-stores': 'Trouver des Magasins Proches',
            'budget-management': 'Gestion du Budget',
            'set-monthly-budgets': 'D√©finir les budgets mensuels par cat√©gorie',
            'confirm-budget': 'Confirmer le Budget',
            'your-profile': 'Votre Profil',
            'configure-data': 'Configurez vos donn√©es pour une exp√©rience personnalis√©e',
            'all-transactions': 'Toutes les Transactions',
            'new-income': 'Nouveau Revenu',
            'register-income': 'Enregistrer un nouveau revenu',
            'new-expense': 'Nouvelle D√©pense',
            'register-expense': 'Enregistrer une nouvelle d√©pense',
            'save-income': 'Enregistrer le Revenu',
            'save-expense': 'Enregistrer la D√©pense',
            'description-placeholder-income': 'Salaire, Bonus, Vente...',
            'description-placeholder-expense': 'D√Æner, Essence, Facture...',
            'cancel': 'Annuler',
            'back-to-dashboard': 'Retour au Tableau de bord',
            'min-total': 'D√©pense totale minimale',
            'fewer-stores': 'Visitez moins de magasins',
            'price-stores-balanced': 'Prix et magasins √©quilibr√©s',
            'choose-expense-type': 'Que voulez-vous ajouter?',
            'generic-expense': 'D√©pense G√©n√©rique',
            'add-expense': 'Ajouter une D√©pense',
            'back-to-choice': 'Retour au choix',
            'save-profile': 'Enregistrer le Profil',
            'email': 'Adresse e-mail',
            'price-button': 'Prix',
            'duplicate-product': 'Produit En Double',
            'check-product': 'V√©rifier le Produit',
            'you-entered': 'Vous avez saisi:',
            'already-in-list': 'Ce produit est d√©j√† dans la liste!',
            'add-anyway': 'Ajouter quand m√™me (doublon)',
            'cancel': 'Annuler',
            'perhaps-you-meant': 'Peut-√™tre vouliez-vous dire:',
            'use-as-is': 'Utiliser "{product}" tel quel',
            'product-not-recognized': 'Produit non reconnu',
            'not-in-database': '"{product}" n\'est pas dans notre base de donn√©es. Il sera ajout√© avec un prix par d√©faut.',
            'add-product': 'Ajouter "{product}"',
            'edit': 'Modifier',
            'close': 'Fermer',
            'balance': 'Solde',
            'set-address-message': 'Configurez votre adresse dans le profil pour trouver des magasins',
            'name': 'Pr√©nom',
            'surname': 'Nom',
            'email': 'Adresse e-mail',
            'street': 'Rue',
            'number': 'Num√©ro',
            'city': 'Ville',
            'province': 'Province',
            'country': 'Pays',
            'company': "Nom de l'Entreprise",
            'personal-data': 'Donn√©es Personnelles',
            'home-address': 'Adresse du Domicile',
            'work-address': 'Adresse Professionnelle',
            'international-preferences': 'Pr√©f√©rences Internationales',
            'preferred-language': 'Langue Pr√©f√©r√©e',
            'default-currency': 'Devise par D√©faut',
            'formatting-preview': 'Aper√ßu du formatage',
            'save-profile': 'Enregistrer le Profil',
            'salary': 'Salaire',
            'bonus': 'Prime',
            'investments': 'Investissements',
            'rental-income': 'Revenus locatifs',
            'food': 'Alimentation',
            'utilities': 'Factures',
            'transport': 'Transport',
            'entertainment': 'Loisirs',
            'health': 'Sant√©',
            'shopping': 'Achats',
            'rent': 'Loyer',
            'mortgage': 'Pr√™t immobilier',  // NUOVA!
            'select-category': 'S√©lectionner cat√©gorie', // per FR
            'select-category': 'S√©lectionner cat√©gorie',
            'first-name': 'Pr√©nom',
            'last-name': 'Nom',
            'used-for-stores': 'Utilis√© pour trouver des magasins',
            'optional': 'Facultatif',
            'amount-with-currency': 'Montant (‚Ç¨)',
            'income-placeholder': 'Salaire, Bonus, Vente...',
            'expense-placeholder': 'D√Æner, Essence, Facture...',
            'current-spending': 'D√©penses actuelles',   // per FR
            'products': 'produits',              // FR
            'covered': 'couverts',               // FR
            'store-total': 'Total magasin',      // FR
            'attention': 'Attention',            // FR
            'missing-products': 'produits manquants',    // FR
            'not-covered': 'ne sont pas couverts par cette solution', // FR
            'not-available': 'Ces produits ne sont pas disponibles dans les magasins s√©lectionn√©s', // FR
            'total-price': 'Prix Total',         // FR
            'apply-solution': 'Appliquer cette solution',
            'reports': 'Rapports et Graphiques',
            'view-stats': 'Voir les statistiques',
            'expenses-by-category': 'D√©penses par Cat√©gorie',
            'expenses-by-store': 'D√©penses par Magasin',
            'monthly-trend': 'Tendance Mensuelle',
            'no-store-data': 'Aucune donn√©e de magasin',
            'estimated-prices': 'Prix estim√©s',
            'estimated-warning': 'Certains prix sont estim√©s. Pour une optimisation pr√©cise, corrigez les prix manuellement.',
            'quantity': 'Quantit√©',
            'store': 'Magasin',
            'select-store': '-- S√©lectionnez un magasin --',
            'add-new-store': '‚ûï Ajouter un nouveau magasin',
            'price-optional': 'Prix (optionnel)',
            'price-auto-hint': 'Si vous ne saisissez pas de prix, le meilleur prix disponible sera utilis√©',
            'confirm': 'Confirmer',
            'add-product-title': 'Ajouter {product}',
            'search-location': 'Chercher des magasins pr√®s de:',
            'home': 'Domicile',
            'work': 'Travail',
            'current-location': 'Position actuelle',
            'searching-near': 'Recherche de magasins pr√®s de:',
            'set-address-message': 'Configurez votre adresse dans le profil pour trouver des magasins',
            'find-nearby-stores': 'Trouver des Magasins Proches',
            'searching': 'Recherche en cours...',
            'searching-nearby': 'Recherche de magasins √† proximit√©...',
            'no-stores-found': 'Aucun magasin trouv√© dans un rayon de',
            'address-not-available': 'Adresse non disponible',
            'osm-credit': 'Donn√©es ¬© contributeurs OpenStreetMap',
            'search-error': 'Erreur lors de la recherche de magasins',
            'go-to-profile': 'Aller au Profil',
            'getting-location': 'Obtention de la position...',
            'location-obtained': 'Position obtenue',
            'location-not-supported': 'G√©olocalisation non support√©e',
            'location-permission-denied': 'Permission refus√©e',
            'location-timeout': 'D√©lai d\'attente d√©pass√©',
            'location-error': 'Erreur lors de l\'obtention de la position',
            'geocoding': 'Recherche de coordonn√©es...',
            'address-not-found': 'Adresse non trouv√©e',
            'work-address-not-set': 'Configurez d\'abord votre adresse professionnelle dans le profil',
            'searching-near': 'Recherche de magasins pr√®s de:',
            'set-address-message': 'Configurez votre adresse dans le profil pour trouver des magasins',
            'address-not-available': 'Adresse non disponible',
            'store': 'Magasin',
            'supermarket': 'Supermarch√©',
            'searching': 'Recherche en cours...',
            'km': 'km',
            'm': 'm',
            'supermarket': 'Supermarch√©',
            'convenience': '√âpicerie',
            'grocery': '√âpicerie fine',
            'greengrocer': 'Primeur',
            'butcher': 'Boucherie',
            'bakery': 'Boulangerie',
            'chemist': 'Droguerie',
            'pharmacy': 'Pharmacie',
            'department_store': 'Grand magasin',
            'reset-all-data': 'Supprimer toutes les donn√©es',
            'confirm-reset': '‚ö†Ô∏è √ätes-vous s√ªr ? Toutes les donn√©es seront supprim√©es !',
            // NOUVELLES CL√âS POUR FRAN√áAIS
            'app-subtitle': 'G√©rez vos finances intelligemment',
            'incomes': 'Revenus',
            'expenses': 'D√©penses',
            'add-income': 'Ajouter un Revenu',
            'add-expense': 'Ajouter une D√©pense',
            'view-all': 'Voir tout',
            'shopping': 'Liste de Courses',
            'items': 'articles',
            'back-to-dashboard': 'Retour au Tableau de bord',
            'cancel': 'Annuler',
            'what-to-add': 'Que voulez-vous ajouter ?',
            'add-shopping-items': 'Ajouter des articles √† acheter',
            'generic-expense': 'D√©pense G√©n√©rique',
            'bills-restaurant': 'Factures, restaurant, carburant...',
            'back-to-choice': 'Retour au choix',
            'new-expense': 'Nouvelle D√©pense',
            'register-expense': 'Enregistrer une nouvelle d√©pense',
            'shopping-list': 'Liste de Courses',
            'register-checked': 'Enregistrer les achats coch√©s',
            'optimization-result': 'R√©sultat d\'Optimisation',
            'total-price': 'Prix Total',
            'stores': 'Magasins',
            'register-purchases': 'Enregistrer les Achats',
            'modify-prices': 'Modifier les prix et confirmer les achats',
            'scan-receipt': 'Scanner le ticket avec l\'appareil photo',
            'camera-hint': 'Utilisez l\'appareil photo pour lire automatiquement les prix et les produits',
            'confirm-purchases': 'Confirmer les Achats',
            'budget-management': 'Gestion du Budget',
            'set-monthly-budgets': 'D√©finir les budgets mensuels par cat√©gorie',
            'confirm-budget': 'Confirmer le Budget',
            'your-profile': 'Votre Profil',
            'configure-data': 'Configurez vos donn√©es pour une exp√©rience personnalis√©e',
            'all-transactions': 'Toutes les Transactions',
            // NOUVELLES CL√âS POUR FRAN√áAIS
            'empty-list': 'La liste est vide',
            'all-purchased': 'Tous les articles ont √©t√© achet√©s',
            'searching-prices': 'Recherche des prix...',
            'unrecognized': 'Non reconnu',
            'correct-price': 'Corriger',
            'empty-list-warning': 'La liste de courses est vide',
            'min-total-desc': 'Chaque produit achet√© au prix le plus bas disponible',
            'fewer-stores-desc': 'Visitez le moins de magasins possible',
            'price-stores-balanced-desc': 'Prix et magasins √©quilibr√©s',
            'covers': 'Couvre',
            'of': 'de',
            'units': 'unit√©s',
            'not-covered': 'ne sont pas couverts par cette solution',
            'covered': 'couverts',
            'fill-fields': 'Veuillez remplir tous les champs correctement',
            'income-registered': 'Revenu enregistr√© avec succ√®s !',
            'expense-registered': 'D√©pense enregistr√©e !',
            'price-saved': 'Prix de',
            'saved-for': 'enregistr√© pour',
            'added': 'ajout√©',
            'item-removed': 'Article supprim√©',
            'purchases-registered': 'achats enregistr√©s !',
            'profile-saved': 'Profil enregistr√© !',
            'language': 'Langue',
            'currency': 'Devise',
            'confirm-reset': '‚ö†Ô∏è √ätes-vous s√ªr ? Toutes les donn√©es seront supprim√©es !',
            'enter-item-name': 'Entrez un nom pour l\'article',
            'product-not-recognized-short': 'Produit non reconnu. Utilisez un nom valide.',
            'searching-best-price': 'Recherche du meilleur prix...',
            'unit': 'Unit√©',
            'piece': 'pi√®ce(s)',
            'kg': 'kg',
            'g': 'g',
            'l': 'l',
            'ml': 'ml',
            'bottle': 'bouteille(s)',
            'pack': 'paquet(s)',
            'reset-history': 'Supprimer l\'historique des enregistrements',
            'bills-restaurant': 'Factures, restaurant, carburant...',
            'manage-budget': 'G√©rer le Budget',
            'back-to-shopping-list': 'Retour √† la Liste',
            'correct-price-for': 'Corriger le prix pour',
            'price': 'Prix',
            'store': 'Magasin',
            'select-store': '-- S√©lectionnez un magasin --',
            'add-new-store': '‚ûï Ajouter un nouveau magasin',
            'save': 'Enregistrer',
            'no-prices': 'Aucun prix disponible pour cet article',
            'prices-for': 'Prix pour',
            'unrecognized-estimated': 'Produit non reconnu - Prix estim√©s',
            'estimated': 'estim√©',
            'best-price': 'Meilleur prix',
            'estimated-warning-short': 'Certains prix sont estim√©s sur la base de produits similaires',
            'manage-budget': 'G√©rer le Budget',
            'back-to-shopping-list': 'Retour √† la Liste',
            // NOUVELLES CL√âS POUR FRAN√áAIS
            'store-not-found': 'Erreur : s√©lecteur de magasin non trouv√©',
            'select-store-warning': 'S√©lectionnez un magasin',
            'no-checked-items': 'Aucun article coch√© √† enregistrer',
            'quantity-label': 'Quantit√© :',
            'price-placeholder': 'Prix',
            'store-placeholder': 'Magasin',
            'expense-description': 'D√©pense :',
            'store-generic': 'Magasin',
            'camera-not-supported': 'Appareil photo non pris en charge sur cet appareil',
            'scan-title': 'Scan de ticket',
            'scan-choose': 'Choisissez comment capturer le ticket :',
            'use-camera': 'Utiliser l\'appareil photo',
            'scan-realtime': 'Scannez en temps r√©el',
            'upload-image': 'T√©l√©charger une image',
            'select-existing': 'S√©lectionnez un ticket d√©j√† photographi√©',
            'start-camera': 'D√©marrage de l\'appareil photo...',
            'frame-receipt': 'Cadrez le ticket',
            'capture': 'Capturer',
            'camera-error': 'Impossible d\'acc√©der √† l\'appareil photo',
            'analyzing': 'Analyse du ticket en cours...',
            'no-items-to-register': 'Aucun article √† enregistrer',
            'receipt-processed': 'Ticket trait√© ! V√©rifiez les prix',
            'no-transactions-registered': 'Aucune transaction enregistr√©e',
            'shopping-tips': 'CONSEILS D\'ACHAT',
            'few-products': 'Vous avez peu de produits : achetez tout dans le m√™me magasin',
            'choose-nearest': 'Choisissez le magasin le plus proche pour gagner du temps',
            'consider-fewest': 'Envisagez l\'optimisation \'Moins de magasins\'',
            'save-time': 'Vous gagnerez du temps en visitant moins de magasins',
            'use-balanced': 'Utilisez l\'optimisation \'√âquilibr√©e\' pour le meilleur compromis',
            'use-lowest': 'Ou \'Prix le plus bas\' pour √©conomiser plus',
            'statistics': 'STATISTIQUES',
            'products-to-buy': 'Produits √† acheter',
            'estimated-total': 'Prix total estim√©',
            'best-single-store': 'Meilleur magasin unique',
            'products-count': 'produits',
            'added-duplicate': 'ajout√© (doublon)',
            'budget-exceeds-income': 'Budget sup√©rieur aux revenus',
            'review-budget': 'R√©visez votre budget ou ajoutez des revenus',
            'description': 'Description',
            'category': 'Cat√©gorie',
            'date': 'Date',
            'amount': 'Montant',
            'income-minus-expenses': 'Revenus - D√©penses',
            'suggestion': 'Suggestion',
            'recent-transactions': 'Derni√®res transactions',
            'view-all': 'Voir tout',
            'add-new-transaction': 'Ajouter une nouvelle transaction',
            'no-transactions': 'Aucune transaction',
            'other': 'Autre',
        },
        'de': {
            'shopping-list': 'Einkaufsliste',
            'shopping-placeholder': 'Was m√ºssen Sie kaufen?',
            'optimize-purchases': 'Eink√§ufe Optimieren',
            'lowest-price': 'Niedrigster Preis',
            'fewest-stores': 'Weniger Gesch√§fte',
            'optimized': 'Optimiert',
            'nearby-stores': 'Nahe Gesch√§fte',
            'find-nearby-stores': 'Gesch√§fte in der N√§he finden',
            'budget-management': 'Budgetverwaltung',
            'set-monthly-budgets': 'Monatliche Budgets nach Kategorie festlegen',
            'confirm-budget': 'Budget Best√§tigen',
            'your-profile': 'Ihr Profil',
            'configure-data': 'Konfigurieren Sie Ihre Daten f√ºr ein personalisiertes Erlebnis',
            'all-transactions': 'Alle Transaktionen',
            'new-income': 'Neue Einnahme',
            'register-income': 'Eine neue Einnahme erfassen',
            'new-expense': 'Neue Ausgabe',
            'register-expense': 'Eine neue Ausgabe erfassen',
            'save-income': 'Einnahme Speichern',
            'save-expense': 'Ausgabe Speichern',
            'description-placeholder-income': 'Gehalt, Bonus, Verkauf...',
            'description-placeholder-expense': 'Abendessen, Benzin, Rechnung...',
            'cancel': 'Abbrechen',
            'back-to-dashboard': 'Zur√ºck zum Dashboard',
            'min-total': 'Minimale Gesamtausgaben',
            'fewer-stores': 'Besuchen Sie weniger Gesch√§fte',
            'price-stores-balanced': 'Preis und Gesch√§fte ausgeglichen',
            'choose-expense-type': 'Was m√∂chten Sie hinzuf√ºgen?',
            'generic-expense': 'Allgemeine Ausgabe',
            'add-expense': 'Ausgabe Hinzuf√ºgen',
            'back-to-choice': 'Zur√ºck zur Auswahl',
            'save-profile': 'Profil Speichern',
            'email': 'E-Mail-Adresse',
            'price-button': 'Preise',
            'duplicate-product': 'Doppeltes Produkt',
            'check-product': 'Produkt Pr√ºfen',
            'you-entered': 'Sie haben eingegeben:',
            'already-in-list': 'Dieses Produkt ist bereits in der Liste!',
            'add-anyway': 'Trotzdem hinzuf√ºgen (Duplikat)',
            'cancel': 'Abbrechen',
            'perhaps-you-meant': 'Vielleicht meinten Sie:',
            'use-as-is': '"{product}" wie es ist verwenden',
            'product-not-recognized': 'Produkt nicht erkannt',
            'not-in-database': '"{product}" ist nicht in unserer Datenbank. Es wird mit Standardpreis hinzugef√ºgt.',
            'add-product': '"{product}" hinzuf√ºgen',
            'edit': 'Bearbeiten',
            'close': 'Schlie√üen',
            'balance': 'Kontostand',
            'set-address-message': 'Legen Sie Ihre Adresse im Profil fest, um Gesch√§fte zu finden',
            'name': 'Vorname',
            'surname': 'Nachname',
            'email': 'E-Mail-Adresse',
            'street': 'Stra√üe',
            'number': 'Hausnummer',
            'city': 'Stadt',
            'province': 'Provinz',
            'country': 'Land',
            'company': 'Firmenname',
            'personal-data': 'Pers√∂nliche Daten',
            'home-address': 'Heimatadresse',
            'work-address': 'Gesch√§ftsadresse',
            'international-preferences': 'Internationale Pr√§ferenzen',
            'preferred-language': 'Bevorzugte Sprache',
            'default-currency': 'Standardw√§hrung',
            'formatting-preview': 'Formatierungsvorschau',
            'save-profile': 'Profil Speichern',
            'salary': 'Gehalt',
            'bonus': 'Bonus',
            'investments': 'Investitionen',
            'rental-income': 'Mieteinnahmen',
            'food': 'Lebensmittel',
            'utilities': 'Nebenkosten',
            'transport': 'Verkehr',
            'entertainment': 'Unterhaltung',
            'health': 'Gesundheit',
            'shopping': 'Einkaufen',
            'rent': 'Miete',
            'mortgage': 'Hypothek',  // NUOVA!
            'select-category': 'Kategorie ausw√§hlen',  // per DE
            'select-category': 'Kategorie ausw√§hlen',
            'first-name': 'Vorname',
            'last-name': 'Nachname',
            'used-for-stores': 'Verwendet, um Gesch√§fte zu finden',
            'optional': 'Optional',
            'amount-with-currency': 'Betrag (‚Ç¨)',
            'income-placeholder': 'Gehalt, Bonus, Verkauf...',
            'expense-placeholder': 'Abendessen, Benzin, Rechnung...',
            'current-spending': 'Aktuelle Ausgaben',    // per DE
            'products': 'Produkte',              // DE
            'total-price': 'Gesamtpreis',        // DE
            'not-available': 'Diese Produkte sind in den ausgew√§hlten Gesch√§ften nicht verf√ºgbar', // DE
            'not-covered': 'werden von dieser L√∂sung nicht abgedeckt', // DE
            'missing-products': 'fehlende Produkte',     // DE
            'attention': 'Achtung',              // DE
            'store-total': 'Gesamt pro Gesch√§ft', // DE
            'covered': 'abgedeckt',              // DE
            'apply-solution': 'Diese L√∂sung anwenden',
            'reports': 'Berichte und Grafiken',
            'view-stats': 'Statistiken anzeigen',
            'expenses-by-category': 'Ausgaben nach Kategorie',
            'expenses-by-store': 'Ausgaben nach Gesch√§ft',
            'monthly-trend': 'Monatlicher Trend',
            'no-store-data': 'Keine Gesch√§ftsdaten',
            'estimated-prices': 'Gesch√§tzte Preise',
            'estimated-warning': 'Einige Preise sind gesch√§tzt. F√ºr eine genaue Optimierung korrigieren Sie die Preise manuell.',
            'quantity': 'Menge',
            'store': 'Gesch√§ft',
            'select-store': '-- W√§hlen Sie ein Gesch√§ft --',
            'add-new-store': '‚ûï Neues Gesch√§ft hinzuf√ºgen',
            'price-optional': 'Preis (optional)',
            'price-auto-hint': 'Wenn Sie kein Preis eingeben, wird der beste verf√ºgbare Preis verwendet',
            'confirm': 'Best√§tigen',
            'add-product-title': '{product} hinzuf√ºgen',
            'search-location': 'Gesch√§fte suchen in der N√§he von:',
            'home': 'Zuhause',
            'work': 'Arbeit',
            'current-location': 'Aktueller Standort',
            'searching-near': 'Suche Gesch√§fte in der N√§he von:',
            'set-address-message': 'Legen Sie Ihre Adresse im Profil fest, um Gesch√§fte zu finden',
            'find-nearby-stores': 'Gesch√§fte in der N√§he finden',
            'searching': 'Suche l√§uft...',
            'searching-nearby': 'Suche nach Gesch√§ften in der N√§he...',
            'no-stores-found': 'Keine Gesch√§fte gefunden im Umkreis von',
            'address-not-available': 'Adresse nicht verf√ºgbar',
            'osm-credit': 'Daten ¬© OpenStreetMap-Mitwirkende',
            'search-error': 'Fehler bei der Suche nach Gesch√§ften',
            'go-to-profile': 'Zum Profil',
            'getting-location': 'Standort wird ermittelt...',
            'location-obtained': 'Standort ermittelt',
            'location-not-supported': 'Geolokalisierung nicht unterst√ºtzt',
            'location-permission-denied': 'Zugriff verweigert',
            'location-timeout': 'Zeit√ºberschreitung',
            'location-error': 'Fehler beim Ermitteln des Standorts',
            'geocoding': 'Suche Koordinaten...',
            'address-not-found': 'Adresse nicht gefunden',
            'work-address-not-set': 'Legen Sie zuerst Ihre Arbeitsadresse im Profil fest',
            'searching-near': 'Suche Gesch√§fte in der N√§he von:',
            'set-address-message': 'Legen Sie Ihre Adresse im Profil fest, um Gesch√§fte zu finden',
            'address-not-available': 'Adresse nicht verf√ºgbar',
            'store': 'Gesch√§ft',
            'supermarket': 'Supermarkt',
            'searching': 'Suche l√§uft...',
            'km': 'km',
            'm': 'm',
            'supermarket': 'Supermarkt',
            'convenience': 'Tante-Emma-Laden',
            'grocery': 'Lebensmittelgesch√§ft',
            'greengrocer': 'Obst- und Gem√ºseh√§ndler',
            'butcher': 'Metzgerei',
            'bakery': 'B√§ckerei',
            'chemist': 'Drogerie',
            'pharmacy': 'Apotheke',
            'department_store': 'Kaufhaus',
            'reset-all-data': 'Alle Daten l√∂schen',
            'confirm-reset': '‚ö†Ô∏è Sind Sie sicher? Alle Daten werden gel√∂scht!',
            // NEUE SCHL√úSSEL F√úR DEUTSCH
            'app-subtitle': 'Verwalten Sie Ihre Finanzen intelligent',
            'incomes': 'Einnahmen',
            'expenses': 'Ausgaben',
            'add-income': 'Einnahme Hinzuf√ºgen',
            'add-expense': 'Ausgabe Hinzuf√ºgen',
            'view-all': 'Alle anzeigen',
            'shopping': 'Einkaufsliste',
            'items': 'Artikel',
            'back-to-dashboard': 'Zur√ºck zum Dashboard',
            'cancel': 'Abbrechen',
            'what-to-add': 'Was m√∂chten Sie hinzuf√ºgen?',
            'add-shopping-items': 'Artikel zum Kauf hinzuf√ºgen',
            'generic-expense': 'Allgemeine Ausgabe',
            'bills-restaurant': 'Rechnungen, Restaurant, Treibstoff...',
            'back-to-choice': 'Zur√ºck zur Auswahl',
            'new-expense': 'Neue Ausgabe',
            'register-expense': 'Eine neue Ausgabe erfassen',
            'shopping-list': 'Einkaufsliste',
            'register-checked': 'Markierte Eink√§ufe registrieren',
            'optimization-result': 'Optimierungsergebnis',
            'total-price': 'Gesamtpreis',
            'stores': 'Gesch√§fte',
            'register-purchases': 'Eink√§ufe Registrieren',
            'modify-prices': 'Preise √§ndern und Eink√§ufe best√§tigen',
            'scan-receipt': 'Kassenbon mit Kamera scannen',
            'camera-hint': 'Verwenden Sie die Kamera, um Preise und Produkte automatisch zu lesen',
            'confirm-purchases': 'Eink√§ufe Best√§tigen',
            'budget-management': 'Budgetverwaltung',
            'set-monthly-budgets': 'Monatliche Budgets nach Kategorie festlegen',
            'confirm-budget': 'Budget Best√§tigen',
            'your-profile': 'Ihr Profil',
            'configure-data': 'Konfigurieren Sie Ihre Daten f√ºr ein personalisiertes Erlebnis',
            'all-transactions': 'Alle Transaktionen',
            // NEUE SCHL√úSSEL F√úR DEUTSCH
            'empty-list': 'Die Liste ist leer',
            'all-purchased': 'Alle Artikel wurden gekauft',
            'searching-prices': 'Suche Preise...',
            'unrecognized': 'Nicht erkannt',
            'correct-price': 'Korrigieren',
            'empty-list-warning': 'Die Einkaufsliste ist leer',
            'min-total-desc': 'Jedes Produkt zum niedrigsten verf√ºgbaren Preis gekauft',
            'fewer-stores-desc': 'Besuchen Sie so wenige Gesch√§fte wie m√∂glich',
            'price-stores-balanced-desc': 'Ausgewogenes Preis-Gesch√§fte-Verh√§ltnis',
            'covers': 'Abdeckt',
            'of': 'von',
            'units': 'Einheiten',
            'not-covered': 'werden von dieser L√∂sung nicht abgedeckt',
            'covered': 'abgedeckt',
            'fill-fields': 'Bitte f√ºllen Sie alle Felder korrekt aus',
            'income-registered': 'Einnahme erfolgreich registriert!',
            'expense-registered': 'Ausgabe registriert!',
            'price-saved': 'Preis von',
            'saved-for': 'gespeichert f√ºr',
            'added': 'hinzugef√ºgt',
            'item-removed': 'Artikel entfernt',
            'purchases-registered': 'Eink√§ufe registriert!',
            'profile-saved': 'Profil gespeichert!',
            'language': 'Sprache',
            'currency': 'W√§hrung',
            'confirm-reset': '‚ö†Ô∏è Sind Sie sicher? Alle Daten werden gel√∂scht!',
            'enter-item-name': 'Geben Sie einen Artikelnamen ein',
            'product-not-recognized-short': 'Produkt nicht erkannt. Verwenden Sie einen g√ºltigen Namen.',
            'searching-best-price': 'Suche nach dem besten Preis...',
            'unit': 'Einheit',
            'piece': 'St√ºck',
            'kg': 'kg',
            'g': 'g',
            'l': 'l',
            'ml': 'ml',
            'bottle': 'Flasche(n)',
            'pack': 'Packung(en)',
            'reset-history': 'Verlauf l√∂schen',
            'bills-restaurant': 'Rechnungen, Restaurant, Treibstoff...',
            'manage-budget': 'Budget verwalten',
            'back-to-shopping-list': 'Zur√ºck zur Liste',
            'correct-price-for': 'Preis korrigieren f√ºr',
            'price': 'Preis',
            'store': 'Gesch√§ft',
            'select-store': '-- W√§hlen Sie ein Gesch√§ft --',
            'add-new-store': '‚ûï Neues Gesch√§ft hinzuf√ºgen',
            'save': 'Speichern',
            'no-prices': 'Keine Preise f√ºr diesen Artikel verf√ºgbar',
            'prices-for': 'Preise f√ºr',
            'unrecognized-estimated': 'Produkt nicht erkannt - Gesch√§tzte Preise',
            'estimated': 'gesch√§tzt',
            'best-price': 'Bester Preis',
            'estimated-warning-short': 'Einige Preise werden auf der Grundlage √§hnlicher Produkte gesch√§tzt',
            'manage-budget': 'Budget verwalten',
            'back-to-shopping-list': 'Zur√ºck zur Liste',
            // NEUE SCHL√úSSEL F√úR DEUTSCH
            'store-not-found': 'Fehler: Gesch√§ftsauswahl nicht gefunden',
            'select-store-warning': 'W√§hlen Sie ein Gesch√§ft',
            'no-checked-items': 'Keine markierten Artikel zum Registrieren',
            'quantity-label': 'Menge:',
            'price-placeholder': 'Preis',
            'store-placeholder': 'Gesch√§ft',
            'expense-description': 'Ausgabe:',
            'store-generic': 'Gesch√§ft',
            'camera-not-supported': 'Kamera auf diesem Ger√§t nicht unterst√ºtzt',
            'scan-title': 'Kassenbonscan',
            'scan-choose': 'W√§hlen Sie, wie der Kassenbon erfasst werden soll:',
            'use-camera': 'Kamera verwenden',
            'scan-realtime': 'In Echtzeit scannen',
            'upload-image': 'Bild hochladen',
            'select-existing': 'W√§hlen Sie einen bereits fotografierten Kassenbon',
            'start-camera': 'Kamera wird gestartet...',
            'frame-receipt': 'Kassenbon einrahmen',
            'capture': 'Aufnehmen',
            'camera-error': 'Kamera kann nicht ge√∂ffnet werden',
            'analyzing': 'Kassenbon wird analysiert...',
            'no-items-to-register': 'Keine Artikel zum Registrieren',
            'receipt-processed': 'Kassenbon verarbeitet! Preise √ºberpr√ºfen',
            'no-transactions-registered': 'Keine Transaktionen registriert',
            'shopping-tips': 'EINKAUFSTIPPS',
            'few-products': 'Sie haben wenige Produkte: Kaufen Sie alles im selben Gesch√§ft',
            'choose-nearest': 'W√§hlen Sie das n√§chstgelegene Gesch√§ft, um Zeit zu sparen',
            'consider-fewest': 'Ziehen Sie die Optimierung \'Weniger Gesch√§fte\' in Betracht',
            'save-time': 'Sie sparen Zeit, indem Sie weniger Gesch√§fte besuchen',
            'use-balanced': 'Verwenden Sie die Optimierung \'Ausgewogen\' f√ºr den besten Kompromiss',
            'use-lowest': 'Oder \'Niedrigster Preis\' um mehr zu sparen',
            'statistics': 'STATISTIKEN',
            'products-to-buy': 'Zu kaufende Produkte',
            'estimated-total': 'Gesch√§tzter Gesamtpreis',
            'best-single-store': 'Bestes Einzelgesch√§ft',
            'products-count': 'Produkte',
            'added-duplicate': 'hinzugef√ºgt (Duplikat)',
            'budget-exceeds-income': 'Budget √ºbersteigt Einnahmen',
            'review-budget': '√úberpr√ºfen Sie Ihr Budget oder f√ºgen Sie Einnahmen hinzu',
            'description': 'Beschreibung',
            'category': 'Kategorie',
            'date': 'Datum',
            'amount': 'Betrag',
            'income-minus-expenses': 'Einnahmen - Ausgaben',
            'suggestion': 'Vorschlag',
            'recent-transactions': 'Letzte Transaktionen',
            'view-all': 'Alle anzeigen',
            'add-new-transaction': 'Neue Transaktion hinzuf√ºgen',
            'no-transactions': 'Keine Transaktionen',
            'other': 'Sonstiges',
        },
        'ro': {
            'shopping-list': 'Lista de CumpƒÉrƒÉturi',
            'shopping-placeholder': 'Ce trebuie sƒÉ cumperi?',
            'optimize-purchases': 'OptimizeazƒÉ Achizi»õii',
            'lowest-price': 'Cel mai mic pre»õ',
            'fewest-stores': 'Mai pu»õine magazine',
            'optimized': 'Optimizat',
            'nearby-stores': 'Magazine Apropiate',
            'find-nearby-stores': 'GƒÉse»ôte Magazine Apropiate',
            'budget-management': 'Gestionare Buget',
            'set-monthly-budgets': 'SeteazƒÉ bugete lunare pe categorii',
            'confirm-budget': 'ConfirmƒÉ Buget',
            'your-profile': 'Profilul TƒÉu',
            'configure-data': 'ConfigureazƒÉ-»õi datele pentru o experien»õƒÉ personalizatƒÉ',
            'all-transactions': 'Toate Tranzac»õiile',
            'new-income': 'Venit Nou',
            'register-income': '√énregistreazƒÉ un venit nou',
            'new-expense': 'CheltuialƒÉ NouƒÉ',
            'register-expense': '√énregistreazƒÉ o cheltuialƒÉ nouƒÉ',
            'save-income': 'SalveazƒÉ Venit',
            'save-expense': 'SalveazƒÉ CheltuialƒÉ',
            'description-placeholder-income': 'Salariu, Bonus, V√¢nzare...',
            'description-placeholder-expense': 'CinƒÉ, BenzinƒÉ, FacturƒÉ...',
            'cancel': 'AnuleazƒÉ',
            'back-to-dashboard': '√énapoi la Tablou de bord',
            'min-total': 'CheltuialƒÉ totalƒÉ minimƒÉ',
            'fewer-stores': 'ViziteazƒÉ mai pu»õine magazine',
            'price-stores-balanced': 'Pre»õ »ôi magazine echilibrate',
            'choose-expense-type': 'Ce dore»ôti sƒÉ adaugi?',
            'generic-expense': 'CheltuialƒÉ GenericƒÉ',
            'add-expense': 'AdaugƒÉ CheltuialƒÉ',
            'back-to-choice': '√énapoi la alegere',
            'save-profile': 'SalveazƒÉ Profil',
            'email': 'Email',
            'price-button': 'Pre»õuri',
            'duplicate-product': 'Produs Duplicat',
            'check-product': 'VerificƒÉ Produsul',
            'you-entered': 'Ai introdus:',
            'already-in-list': 'Acest produs este deja √Æn listƒÉ!',
            'add-anyway': 'AdaugƒÉ oricum (duplicat)',
            'cancel': 'AnuleazƒÉ',
            'perhaps-you-meant': 'Poate ai vrut sƒÉ spui:',
            'use-as-is': 'Folose»ôte "{product}" a»ôa cum este',
            'product-not-recognized': 'Produs nerecunoscut',
            'not-in-database': '"{product}" nu este √Æn baza noastrƒÉ de date. Va fi adƒÉugat cu pre»õ implicit.',
            'add-product': 'AdaugƒÉ "{product}"',
            'edit': 'EditeazƒÉ',
            'close': '√énchide',
            'balance': 'Sold',
            'set-address-message': 'SeteazƒÉ adresa √Æn profil pentru a gƒÉsi magazine',
            'name': 'Prenume',
            'surname': 'Nume',
            'email': 'Email',
            'street': 'StradƒÉ',
            'number': 'NumƒÉr',
            'city': 'Ora»ô',
            'province': 'Provincie',
            'country': '»öarƒÉ',
            'company': 'Nume Companie',
            'personal-data': 'Date Personale',
            'home-address': 'Adresa de Domiciliu',
            'work-address': 'Adresa de MuncƒÉ',
            'international-preferences': 'Preferin»õe Interna»õionale',
            'preferred-language': 'Limba PreferatƒÉ',
            'default-currency': 'Moneda ImplicitƒÉ',
            'formatting-preview': 'Previzualizare formatare',
            'save-profile': 'SalveazƒÉ Profil',
            'salary': 'Salariu',
            'bonus': 'Bonus',
            'investments': 'Investi»õii',
            'rental-income': 'Venituri din chirii',
            'food': 'Alimente',
            'utilities': 'UtilitƒÉ»õi',
            'transport': 'Transport',
            'entertainment': 'Divertisment',
            'health': 'SƒÉnƒÉtate',
            'shopping': 'CumpƒÉrƒÉturi',
            'rent': 'Chirie',
            'mortgage': 'Credit ipotecar',  // NUOVA!
            'select-category': 'SelecteazƒÉ categoria', // per RO
            'select-category': 'SelecteazƒÉ categoria',
            'first-name': 'Prenume',
            'last-name': 'Nume',
            'used-for-stores': 'Folosit pentru a gƒÉsi magazine',
            'optional': 'Op»õional',
            'amount-with-currency': 'SumƒÉ (‚Ç¨)',
            'income-placeholder': 'Salariu, Bonus, V√¢nzare...',
            'expense-placeholder': 'CinƒÉ, BenzinƒÉ, FacturƒÉ...',
            'current-spending': 'Cheltuieli curente',   // per RO
            'products': 'produse',               // RO
            'covered': 'acoperi»õi',              // RO
            'store-total': 'Total magazin',      // RO
            'attention': 'Aten»õie',              // RO
            'missing-products': 'produse lipsƒÉ',         // RO
            'not-covered': 'nu sunt acoperite de aceastƒÉ solu»õie',   // RO
            'not-available': 'Aceste produse nu sunt disponibile √Æn magazinele selectate',    // RO
            'total-price': 'Pre»õ Total',         // RO
            'apply-solution': 'AplicƒÉ aceastƒÉ solu»õie',
            'reports': 'Rapoarte »ôi Grafice',
            'view-stats': 'Vezi statistici',
            'expenses-by-category': 'Cheltuieli pe Categorii',
            'expenses-by-store': 'Cheltuieli pe Magazine',
            'monthly-trend': 'Trend Lunar',
            'no-store-data': 'Nu existƒÉ date despre magazine',
            'estimated-prices': 'Pre»õuri estimate',
            'estimated-warning': 'Unele pre»õuri sunt estimate. Pentru o optimizare precisƒÉ, corecteazƒÉ pre»õurile manual.',
            'quantity': 'Cantitate',
            'store': 'Magazin',
            'select-store': '-- SelecteazƒÉ un magazin --',
            'add-new-store': '‚ûï AdaugƒÉ magazin nou',
            'price-optional': 'Pre»õ (op»õional)',
            'price-auto-hint': 'DacƒÉ nu introduci un pre»õ, va fi folosit cel mai bun pre»õ disponibil',
            'confirm': 'ConfirmƒÉ',
            'add-product-title': 'AdaugƒÉ {product}',
            'search-location': 'CautƒÉ magazine l√¢ngƒÉ:',
            'home': 'AcasƒÉ',
            'work': 'Serviciu',
            'current-location': 'Loca»õia curentƒÉ',
            'searching-near': 'Caut magazine l√¢ngƒÉ:',
            'set-address-message': 'SeteazƒÉ adresa √Æn profil pentru a gƒÉsi magazine',
            'find-nearby-stores': 'GƒÉse»ôte magazine apropiate',
            'searching': 'CƒÉutare √Æn curs...',
            'searching-nearby': 'Caut magazine √Æn apropiere...',
            'no-stores-found': 'Niciun magazin gƒÉsit pe o razƒÉ de',
            'address-not-available': 'AdresƒÉ indisponibilƒÉ',
            'osm-credit': 'Date ¬© contribuitori OpenStreetMap',
            'search-error': 'Eroare la cƒÉutarea magazinelor',
            'go-to-profile': 'Mergi la Profil',
            'getting-location': 'Ob»õin loca»õia...',
            'location-obtained': 'Loca»õie ob»õinutƒÉ',
            'location-not-supported': 'Geoloca»õia nu este suportatƒÉ',
            'location-permission-denied': 'Permisiune refuzatƒÉ',
            'location-timeout': 'Timeout',
            'location-error': 'Eroare la ob»õinerea loca»õiei',
            'geocoding': 'Caut coordonate...',
            'address-not-found': 'AdresƒÉ negƒÉsitƒÉ',
            'work-address-not-set': 'SeteazƒÉ mai √Ænt√¢i adresa de serviciu √Æn profil',
            'searching-near': 'Caut magazine l√¢ngƒÉ:',
            'set-address-message': 'SeteazƒÉ adresa √Æn profil pentru a gƒÉsi magazine',
            'address-not-available': 'AdresƒÉ indisponibilƒÉ',
            'store': 'Magazin',
            'supermarket': 'Supermarket',
            'searching': 'CƒÉutare √Æn curs...',
            'km': 'km',
            'm': 'm',
            'supermarket': 'Supermarket',
            'convenience': 'Alimentari',
            'grocery': 'Drogherie',
            'greengrocer': 'Fruct & Legume',
            'butcher': 'MƒÉcelƒÉrie',
            'bakery': 'BrutƒÉrie',
            'chemist': 'Drogherie',
            'pharmacy': 'Farmacie',
            'department_store': 'Magazin universal',
            'reset-all-data': '»òterge toate datele',
            'confirm-reset': '‚ö†Ô∏è E»ôti sigur? Toate datele vor fi »ôterse!',
            // CHEI NOI PENTRU ROM√ÇNƒÇ
            'app-subtitle': 'GestioneazƒÉ-»õi finan»õele inteligent',
            'incomes': 'Venituri',
            'expenses': 'Cheltuieli',
            'add-income': 'AdaugƒÉ Venit',
            'add-expense': 'AdaugƒÉ CheltuialƒÉ',
            'view-all': 'Vezi toate',
            'shopping': 'Lista de CumpƒÉrƒÉturi',
            'items': 'articole',
            'back-to-dashboard': '√énapoi la Tablou de bord',
            'cancel': 'AnuleazƒÉ',
            'what-to-add': 'Ce dore»ôti sƒÉ adaugi?',
            'add-shopping-items': 'AdaugƒÉ articole de cumpƒÉrat',
            'generic-expense': 'CheltuialƒÉ GenericƒÉ',
            'bills-restaurant': 'Facturi, restaurant, combustibil...',
            'back-to-choice': '√énapoi la alegere',
            'new-expense': 'CheltuialƒÉ NouƒÉ',
            'register-expense': '√énregistreazƒÉ o cheltuialƒÉ nouƒÉ',
            'shopping-list': 'Lista de CumpƒÉrƒÉturi',
            'register-checked': '√énregistreazƒÉ achizi»õiile bifate',
            'optimization-result': 'Rezultat Optimizare',
            'total-price': 'Pre»õ Total',
            'stores': 'Magazine',
            'register-purchases': '√énregistreazƒÉ Achizi»õii',
            'modify-prices': 'ModificƒÉ pre»õurile »ôi confirmƒÉ achizi»õiile',
            'scan-receipt': 'ScaneazƒÉ bonul cu camera',
            'camera-hint': 'Folose»ôte camera pentru a citi automat pre»õurile »ôi produsele',
            'confirm-purchases': 'ConfirmƒÉ Achizi»õiile',
            'budget-management': 'Gestionare Buget',
            'set-monthly-budgets': 'SeteazƒÉ bugete lunare pe categorii',
            'confirm-budget': 'ConfirmƒÉ Buget',
            'your-profile': 'Profilul TƒÉu',
            'configure-data': 'ConfigureazƒÉ-»õi datele pentru o experien»õƒÉ personalizatƒÉ',
            'all-transactions': 'Toate Tranzac»õiile',
            // CHEI NOI PENTRU ROM√ÇNƒÇ
            'empty-list': 'Lista este goalƒÉ',
            'all-purchased': 'Toate articolele au fost cumpƒÉrate',
            'searching-prices': 'Caut pre»õuri...',
            'unrecognized': 'Nerecunoscut',
            'correct-price': 'CorecteazƒÉ',
            'empty-list-warning': 'Lista de cumpƒÉrƒÉturi este goalƒÉ',
            'min-total-desc': 'Fiecare produs cumpƒÉrat la cel mai mic pre»õ disponibil',
            'fewer-stores-desc': 'ViziteazƒÉ c√¢t mai pu»õine magazine posibil',
            'price-stores-balanced-desc': 'Pre»õ »ôi magazine echilibrate',
            'covers': 'AcoperƒÉ',
            'of': 'din',
            'units': 'unitƒÉ»õi',
            'not-covered': 'nu sunt acoperite de aceastƒÉ solu»õie',
            'covered': 'acoperite',
            'fill-fields': 'Completa»õi toate c√¢mpurile corect',
            'income-registered': 'Venit √Ænregistrat cu succes!',
            'expense-registered': 'CheltuialƒÉ √ÆnregistratƒÉ!',
            'price-saved': 'Pre»õul pentru',
            'saved-for': 'salvat pentru',
            'added': 'adƒÉugat',
            'item-removed': 'Articol »ôters',
            'purchases-registered': 'achizi»õii √Ænregistrate!',
            'profile-saved': 'Profil salvat!',
            'language': 'Limba',
            'currency': 'Moneda',
            'confirm-reset': '‚ö†Ô∏è E»ôti sigur? Toate datele vor fi »ôterse!',
            'enter-item-name': 'Introduce»õi un nume pentru articol',
            'product-not-recognized-short': 'Produs nerecunoscut. Folosi»õi un nume valid.',
            'searching-best-price': 'Caut cel mai bun pre»õ...',
            'unit': 'Unitate de mƒÉsurƒÉ',
            'piece': 'bucatƒÉ(i)',
            'kg': 'kg',
            'g': 'g',
            'l': 'l',
            'ml': 'ml',
            'bottle': 'sticlƒÉ(e)',
            'pack': 'pachet(e)',
            'reset-history': '»òterge istoricul √ÆnregistrƒÉrilor',
            'bills-restaurant': 'Facturi, restaurant, combustibil...',
            'manage-budget': 'GestioneazƒÉ Bugetul',
            'back-to-shopping-list': '√énapoi la ListƒÉ',
            'correct-price-for': 'CorecteazƒÉ pre»õul pentru',
            'price': 'Pre»õ',
            'store': 'Magazin',
            'select-store': '-- SelecteazƒÉ un magazin --',
            'add-new-store': '‚ûï AdaugƒÉ magazin nou',
            'save': 'SalveazƒÉ',
            'no-prices': 'Niciun pre»õ disponibil pentru acest articol',
            'prices-for': 'Pre»õuri pentru',
            'unrecognized-estimated': 'Produs nerecunoscut - Pre»õuri estimate',
            'estimated': 'estimat',
            'best-price': 'Cel mai bun pre»õ',
            'estimated-warning-short': 'Unele pre»õuri sunt estimate pe baza produselor similare',
            'manage-budget': 'GestioneazƒÉ Bugetul',
            'back-to-shopping-list': '√énapoi la ListƒÉ',
            // CHEI NOI PENTRU ROM√ÇNƒÇ
            'store-not-found': 'Eroare: selectorul de magazin nu a fost gƒÉsit',
            'select-store-warning': 'SelecteazƒÉ un magazin',
            'no-checked-items': 'Niciun articol bifat de √Ænregistrat',
            'quantity-label': 'Cantitate:',
            'price-placeholder': 'Pre»õ',
            'store-placeholder': 'Magazin',
            'expense-description': 'CheltuialƒÉ:',
            'store-generic': 'Magazin',
            'camera-not-supported': 'Camera nu este acceptatƒÉ pe acest dispozitiv',
            'scan-title': 'Scanare bon',
            'scan-choose': 'Alege cum sƒÉ capturezi bonul:',
            'use-camera': 'Folose»ôte camera',
            'scan-realtime': 'ScaneazƒÉ √Æn timp real',
            'upload-image': '√éncarcƒÉ imagine',
            'select-existing': 'SelecteazƒÉ un bon deja fotografiat',
            'start-camera': 'Pornire camerƒÉ...',
            'frame-receipt': '√éncadreazƒÉ bonul',
            'capture': 'CaptureazƒÉ',
            'camera-error': 'Nu se poate accesa camera',
            'analyzing': 'Se analizeazƒÉ bonul...',
            'no-items-to-register': 'Niciun articol de √Ænregistrat',
            'receipt-processed': 'Bon procesat! VerificƒÉ pre»õurile',
            'no-transactions-registered': 'Nicio tranzac»õie √ÆnregistratƒÉ',
            'shopping-tips': 'SFATURI PENTRU CUMPƒÇRƒÇTURI',
            'few-products': 'Ai pu»õine produse: cumpƒÉrƒÉ totul din acela»ôi magazin',
            'choose-nearest': 'Alege cel mai apropiat magazin pentru a economisi timp',
            'consider-fewest': 'Ia √Æn considerare optimizarea \'Mai pu»õine magazine\'',
            'save-time': 'Vei economisi timp vizit√¢nd mai pu»õine magazine',
            'use-balanced': 'Folose»ôte optimizarea \'EchilibratƒÉ\' pentru cel mai bun compromis',
            'use-lowest': 'Sau \'Cel mai mic pre»õ\' pentru a economisi mai mult',
            'statistics': 'STATISTICI',
            'products-to-buy': 'Produse de cumpƒÉrat',
            'estimated-total': 'Pre»õ total estimat',
            'best-single-store': 'Cel mai bun magazin unic',
            'products-count': 'produse',
            'added-duplicate': 'adƒÉugat (duplicat)',
            'budget-exceeds-income': 'Bugetul depƒÉ»ôe»ôte veniturile',
            'review-budget': 'Revizuie»ôte bugetul sau adaugƒÉ venituri',
            'description': 'Descriere',
            'category': 'Categorie',
            'date': 'DatƒÉ',
            'amount': 'SumƒÉ',
            'income-minus-expenses': 'Venituri - Cheltuieli',
            'suggestion': 'Sugestie',
            'recent-transactions': 'Ultimele tranzac»õii',
            'view-all': 'Vezi toate',
            'add-new-transaction': 'AdaugƒÉ tranzac»õie nouƒÉ',
            'no-transactions': 'Nu existƒÉ tranzac»õii',
            'other': 'Altele',
        }
    };
    
    return translations[lang] || translations['it'];
}

// Aggiungi questa funzione helper per aggiornare i testi delle transazioni
function updateRecentTransactionsText() {
    const recentTransactionsContainer = document.getElementById('recent-transactions');
    if (recentTransactionsContainer) {
        const noTransactionsText = recentTransactionsContainer.querySelector('p.text-gray-500');
        if (noTransactionsText && noTransactionsText.textContent.includes('Nessuna transazione')) {
            const lang = userProfile?.language || 'it';
            const translations = {
                'it': 'Nessuna transazione',
                'en': 'No transactions',
                'es': 'Sin transacciones',
                'fr': 'Aucune transaction',
                'de': 'Keine Transaktionen',
                'ro': 'FƒÉrƒÉ tranzac»õii'
            };
            noTransactionsText.textContent = translations[lang] || translations['it'];
        }
    }
}

// üî¥ AGGIUNGI QUI LA FUNZIONE üî¥
function fixBalanceTranslation() {
    const balanceElement = document.querySelector('[data-translate="balance"]');
    if (balanceElement) {
        const lang = userProfile?.language || 'it';
        if (lang === 'it' || lang === 'ro') {
            balanceElement.textContent = 'Sold';
        } else if (lang === 'en') {
            balanceElement.textContent = 'Balance';
        } else if (lang === 'es') {
            balanceElement.textContent = 'Saldo';
        } else if (lang === 'fr') {
            balanceElement.textContent = 'Solde';
        } else if (lang === 'de') {
            balanceElement.textContent = 'Kontostand';
        }
        console.log('‚úÖ Balance tradotto in:', lang, balanceElement.textContent);
    }
}
// ==================== FORZA TRADUZIONE LABEL IMPORTO ====================
function fixAmountLabel() {
    // Trova tutte le label con data-translate="amount-with-currency"
    const amountLabels = document.querySelectorAll('[data-translate="amount-with-currency"]');
    
    if (amountLabels.length === 0) {
        console.log('‚ö†Ô∏è Label importo non trovate, riprovo tra 300ms');
        setTimeout(fixAmountLabel, 300);
        return;
    }
    
    const lang = userProfile?.language || 'it';
    const currency = userProfile?.currency || 'EUR';
    
    // Traduzioni base per lingua
    const translations = {
        'it': 'Importo',
        'en': 'Amount',
        'es': 'Importe',
        'fr': 'Montant',
        'de': 'Betrag',
        'ro': 'SumƒÉ'
    };
    
    const baseText = translations[lang] || translations['it'];
    const fullText = `${baseText} (${currency}) *`;
    
    amountLabels.forEach(label => {
        label.textContent = fullText;
        console.log(`‚úÖ Label importo aggiornata: ${fullText}`);
    });
}
// ==================== TEST TRADUZIONE ====================
function testTranslate() {
    console.log('üß™ TEST MANUALE TRADUZIONE');
    console.log('Lingua corrente:', userProfile?.language);
    console.log('userProfile esiste?', userProfile ? 'SI' : 'NO');
    
    // Forza traduzione
    translateAllScreens();
    
    showToast('üîÑ Traduzione forzata');
}


// ==================== OPENFOODFACTS INTEGRATION ====================
const OFF_CONFIG = {
    BASE_URL: 'https://world.openfoodfacts.org',
    PRICES_URL: 'https://prices.openfoodfacts.org',
    USER_AGENT: 'SmartBillingApp/1.0 (tuo-email@example.com)',
    CACHE_DURATION: 7 * 24 * 60 * 60 * 1000 // 7 giorni
};

// Cache locale
let productCache = JSON.parse(localStorage.getItem('productCache') || '{}');
let userPriceDB = JSON.parse(localStorage.getItem('userPriceDB') || '{}');
let priceStats = JSON.parse(localStorage.getItem('priceStats') || '{}');

// Funzioni di cache
function saveCache() {
    localStorage.setItem('productCache', JSON.stringify(productCache));
    localStorage.setItem('userPriceDB', JSON.stringify(userPriceDB));
    localStorage.setItem('priceStats', JSON.stringify(priceStats));
}

// ==================== FUNZIONI PREZZI ====================

/**
 * Cerca prodotto su OpenFoodFacts
 */
async function searchProduct(query) {
    const cacheKey = `search_${query.toLowerCase()}`;
    if (productCache[cacheKey] && (Date.now() - productCache[cacheKey].timestamp) < OFF_CONFIG.CACHE_DURATION) {
        return productCache[cacheKey].data;
    }
    
    try {
        const url = `${OFF_CONFIG.BASE_URL}/cgi/search.pl?search_terms=${encodeURIComponent(query)}&search_simple=1&action=process&json=1`;
        const response = await fetch(url, {
            headers: { 'User-Agent': OFF_CONFIG.USER_AGENT }
        });
        
        const data = await response.json();
        const products = data.products?.slice(0, 5).map(p => ({
            barcode: p.code,
            name: p.product_name || query,
            brand: p.brands,
            categories: p.categories,
            image: p.image_url
        })) || [];
        
        productCache[cacheKey] = {
            timestamp: Date.now(),
            data: products
        };
        saveCache();
        
        return products;
    } catch (error) {
        console.error('Errore ricerca prodotto:', error);
        return [];
    }
}

/**
 * Salva prezzo inserito dall'utente
 */
function saveUserPrice(productName, storeName, price, options = {}) {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    const key = `${productName.toLowerCase()}_${storeName}`;
    
    if (!userPriceDB[key]) {
        userPriceDB[key] = [];
    }
    
    userPriceDB[key].push({
        price: price,
        date: new Date().toISOString(),
        userId: userProfile?.email || 'anonimo',
        source: options.source || 'manual',
        confidence: options.confidence || 0.9
    });
    
    // Aggiorna statistiche
    if (!priceStats[productName]) {
        priceStats[productName] = { count: 0, sum: 0, min: price, max: price };
    }
    const stats = priceStats[productName];
    stats.count++;
    stats.sum += price;
    stats.min = Math.min(stats.min, price);
    stats.max = Math.max(stats.max, price);
    stats.average = stats.sum / stats.count;
    
    saveCache();
    showToast(`üí∞ ${t['price-saved-toast'] || 'Prezzo salvato!'}`);
    
    return true;
}

/**
 * Ottieni miglior prezzo per un prodotto
 */
 async function getBestPrice(productName, storeName = null) {
    const productLower = productName.toLowerCase();
    let prices = [];
    
    // Cerca nel database utente
    for (const [key, entries] of Object.entries(userPriceDB)) {
        if (key.includes(productLower)) {
            const lastEntry = entries[entries.length - 1];
            if (!storeName || key.includes(storeName.toLowerCase())) {
                prices.push({
                    price: lastEntry.price,
                    store: key.split('_')[1],
                    source: 'user',
                    confidence: 0.9 + (entries.length * 0.02),
                    date: lastEntry.date,
                    isEstimated: false  // ‚úÖ Prezzo reale
                });
            }
        }
    }
    
    // Se non trovato, prezzo stimato
    if (prices.length === 0) {
        prices.push({
            price: estimatePrice(productName),
            store: 'Prezzo stimato',
            source: 'estimate',
            confidence: 0.5,
            isEstimated: true  // ‚ö†Ô∏è Prezzo stimato
        });
    }
    
    // Ordina per prezzo e confidence
    prices.sort((a, b) => {
        if (a.price !== b.price) return a.price - b.price;
        return b.confidence - a.confidence;
    });
    
    return prices[0];
}

/**
 * Stima prezzo basato su categoria
 */
function estimatePrice(productName) {
    const productLower = productName.toLowerCase();
    
    const categories = {
        'pane': 2.0, 'latte': 1.5, 'uova': 3.0, 'pasta': 1.2,
        'riso': 1.8, 'formaggio': 4.5, 'yogurt': 2.0, 'caff√®': 3.5,
        'biscotti': 2.2, 'acqua': 0.8, 'vino': 6.0, 'birra': 1.8,
        'carne': 8.0, 'pollo': 6.0, 'pesce': 10.0, 'frutta': 2.5,
        'verdura': 2.0, 'patate': 1.5, 'pomodori': 2.2
    };
    
    for (const [key, price] of Object.entries(categories)) {
        if (productLower.includes(key)) return price;
    }
    
    return 5.0; // Prezzo default
}

// ==================== RENDI GLOBALI LE FUNZIONI PREZZI ====================
// Attacca le funzioni all'oggetto window per renderle accessibili dagli onclick
window.searchProduct = searchProduct;
window.getBestPrice = getBestPrice;
window.saveUserPrice = saveUserPrice;
window.showPriceCorrectionModal = showPriceCorrectionModal;
window.submitPriceCorrection = submitPriceCorrection;

console.log('‚úÖ Funzioni prezzi attaccate a window');
// ==================== PERSISTENZA DATI ====================

// Carica tutti i dati dal localStorage
function loadAllData() {
    console.log('üìÇ Caricamento dati salvati...');
    
    try {
        // Carica profilo
        const savedProfile = localStorage.getItem('smart_billing_profile');
        if (savedProfile) {
            userProfile = JSON.parse(savedProfile);
            console.log('‚úÖ Profilo caricato');
        }
        
        // Carica transazioni
        const savedTransactions = localStorage.getItem('smart_billing_transactions');
        if (savedTransactions) {
            transactions = JSON.parse(savedTransactions);
            console.log(`‚úÖ ${transactions.length} transazioni caricate`);
        }
        
        // Carica lista spesa - SOLO SE NON CI SONO GI√Ä DATI IN MEMORIA
        const savedShoppingList = localStorage.getItem('smart_billing_shopping');
        if (savedShoppingList && shoppingList.length === 0) {
            shoppingList = JSON.parse(savedShoppingList);
            console.log(`‚úÖ ${shoppingList.length} articoli in lista caricati`);
        } else if (shoppingList.length > 0) {
            console.log(`‚ÑπÔ∏è Lista spesa gi√† presente in memoria (${shoppingList.length} articoli), non sovrascrivo`);
        }
        
        // Carica budget
        const savedBudget = localStorage.getItem('smart_billing_budget');
        if (savedBudget) {
            budget = JSON.parse(savedBudget);
            console.log('‚úÖ Budget caricato');
        }
        
        // Carica prezzi utente
        const savedPrices = localStorage.getItem('userPriceDB');
        if (savedPrices) {
            userPriceDB = JSON.parse(savedPrices);
            console.log('‚úÖ Database prezzi caricato');
        }
        
        // Carica negozi utente
        const savedStores = localStorage.getItem('userStores');
        if (savedStores) {
            window.userStores = JSON.parse(savedStores);
            console.log(`‚úÖ ${window.userStores.length} negozi utente caricati`);
        }
        
        console.log('‚úÖ TUTTI I DATI CARICATI CON SUCCESSO');
    } catch (e) {
        console.log('‚ö†Ô∏è Errore nel caricamento dati:', e);
    }
}

// Salva tutti i dati nel localStorage
function saveAllData() {
    try {
        localStorage.setItem('smart_billing_profile', JSON.stringify(userProfile));
        localStorage.setItem('smart_billing_transactions', JSON.stringify(transactions));
        localStorage.setItem('smart_billing_shopping', JSON.stringify(shoppingList));
        localStorage.setItem('smart_billing_budget', JSON.stringify(budget));
        localStorage.setItem('userPriceDB', JSON.stringify(userPriceDB));
        localStorage.setItem('userStores', JSON.stringify(window.userStores));
        
        console.log('‚úÖ Tutti i dati salvati');
        return true;
    } catch (e) {
        console.log('‚ö†Ô∏è Errore nel salvataggio dati:', e);
        return false;
    }
}
// ==================== RESET DATI ====================
function resetAllData() {
    const lang = userProfile?.language || 'it';
    const t = getTranslations(lang);
    
    if (confirm(t['confirm-reset'] || '‚ö†Ô∏è Sei sicuro? Tutti i dati verranno cancellati!')) {
        transactions = [];
        shoppingList = [];
        budget = {
            Alimentari: 0,
            Affitto: 0,
            Mutuo: 0,
            Bollette: 0,
            Trasporti: 0,
            Svago: 0,
            Salute: 0
        };
        userPriceDB = {};
        window.userStores = [];
        
        saveAllData();
        
        showToast(`üóëÔ∏è ${t['reset-all-data'] || 'Tutti i dati cancellati'}`);
        showScreen('dashboard');
    }
}

    // ==================== INITIALIZE ====================
    function initApp() {
    console.log('üöÄ === INIZIALIZZAZIONE APP ===');
    // üî• CARICA TUTTI I DATI SALVATI
    loadAllData();
    
    // üî• FUNZIONE PER RILEVARE LINGUA DISPOSITIVO
    function detectDeviceLanguage() {
        let deviceLang = navigator.language || navigator.userLanguage || 'en';
        deviceLang = deviceLang.split('-')[0];
        const supportedLangs = ['it', 'en', 'es', 'fr', 'de', 'ro'];
        return supportedLangs.includes(deviceLang) ? deviceLang : 'en';
    }
    
    let loadedProfile = null;
    let source = 'nessuno';
    
    // 1. CERCA NELL'ORDINE:
    
    // A) Variabile globale PRIMARIA (pi√π affidabile)
    if (window.SMART_BILLING_USER_PROFILE) {
        loadedProfile = window.SMART_BILLING_USER_PROFILE;
        source = 'window.SMART_BILLING_USER_PROFILE';
        console.log('üéØ Profilo trovato in variabile globale primaria');
    }
    
    // B) Variabile globale userProfile (se esiste gi√†)
    else if (userProfile && userProfile.firstName) {
        loadedProfile = userProfile;
        source = 'variabile userProfile esistente';
        console.log('üìÅ Profilo trovato in variabile esistente');
    }
    
    // C) localStorage
    else {
        try {
            const localData = localStorage.getItem('smart_billing_profile_v2');
            if (localData) {
                loadedProfile = JSON.parse(localData);
                source = 'localStorage';
                console.log('üíæ Profilo trovato in localStorage');
            }
        } catch (e) {
            console.log('‚ö†Ô∏è localStorage non accessibile');
        }
    }
    
    // 2. SE TROVATO, CARICALO
    if (loadedProfile) {
        userProfile = loadedProfile;
        console.log('‚úÖ PROFILO CARICATO da:', source);
        console.log('üåç Lingua:', userProfile.language);
        console.log('üí∞ Valuta:', userProfile.currency);
        console.log('üè† Paese:', userProfile.homeCountry);
        applyLanguageSettings();

        // Assicurati che currencySymbol sia definito
        if (!userProfile.currencySymbol && userProfile.currency) {
            const currencyInfo = currencies[userProfile.currency];
            userProfile.currencySymbol = currencyInfo?.symbol || '‚Ç¨';
            console.log('üîß Symbol corretto:', userProfile.currencySymbol);
        }
    } else {
        console.log('‚ö†Ô∏è Nessun profilo trovato, uso impostazioni default');
        // üî• RILEVA LINGUA DISPOSITIVO
        const deviceLang = detectDeviceLanguage();
        userProfile.language = deviceLang;
        userProfile.currency = 'EUR';
        userProfile.currencySymbol = '‚Ç¨';
        userProfile.homeCountry = deviceLang === 'it' ? 'IT' : 
                                 deviceLang === 'ro' ? 'RO' : 
                                 deviceLang === 'es' ? 'ES' : 
                                 deviceLang === 'fr' ? 'FR' : 
                                 deviceLang === 'de' ? 'DE' : 'IT';
        console.log(`üì± Lingua dispositivo rilevata: ${deviceLang}`);
        console.log('üá¨üáß Default: Inglese/Euro (se non supportato)');
    }
    
    // 3. Carica learnedCategories (semplificato)
    try {
        const catData = localStorage.getItem('learnedCategories') || sessionStorage.getItem('learnedCategories');
        if (catData) {
            learnedCategories = JSON.parse(catData);
            console.log('üìö Categorie imparate caricate');
        }
    } catch (e) {
        console.log('‚ö†Ô∏è Error caricamento categorie:', e);
        learnedCategories = {};
    }
    
    // 4. Event listeners per anteprima valuta
    setTimeout(() => {
        const currencySelect = document.getElementById('profile-currency');
        const languageSelect = document.getElementById('profile-language');
        
        if (currencySelect) {
            currencySelect.addEventListener('change', updateCurrencyPreview);
            console.log('üéØ Event listener currency aggiunto');
        }
        if (languageSelect) {
            languageSelect.addEventListener('change', updateCurrencyPreview);
            console.log('üéØ Event listener language aggiunto');
        }
        
        if (document.getElementById('screen-profile')?.classList.contains('active')) {
            updateCurrencyPreview();
        }
    }, 300);
    
    // 5. Inizializza app
    console.log('üîÑ Inizializzazione componenti...');
    updateDashboard();
    updateItemPrices();
    
    // üî• FORZA UN SECONDO CARICAMENTO DOPO 500ms (per iOS)
    setTimeout(() => {
        console.log('üîÑ Ricarico dati per sicurezza (iOS fix)...');
        loadAllData();
        updateDashboard();
        renderShoppingList();
        renderRecentTransactions();
    }, 500);
    
    console.log('‚úÖ APP INIZIALIZZATA');
    console.log('üåç LINGUA FINALE:', userProfile.language);
}

// üî• FIX PER iOS HOME SCREEN - AGGIUNGI DOPO initApp()
window.addEventListener('pageshow', function(event) {
    // Se la pagina viene caricata dalla cache (tipico di iOS)
    if (event.persisted) {
        console.log('üì± Pagina caricata dalla cache (iOS home screen) - ricarico dati');
        loadAllData();
        updateDashboard();
        renderShoppingList();
        renderRecentTransactions();
    }
});

// üî• FIX PER QUANDO L'APP VIENE RIPORTATA IN PRIMO PIANO
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        console.log('üì± App tornata in primo piano - ricarico dati');
        loadAllData();
        updateDashboard();
        renderShoppingList();
        renderRecentTransactions();
    }
});

// üî• SALVA I DATI PRIMA CHE L'APP VENGA CHIUSA (opzionale)
window.addEventListener('beforeunload', function() {
    console.log('üì± App in chiusura - salvataggio finale');
    saveAllData();
});

function debugProfile() {
    console.log('=== DEBUG PROFILO ===');
    console.log('1. userProfile globale:', userProfile);
    console.log('2. window.SMART_BILLING_USER_PROFILE:', window.SMART_BILLING_USER_PROFILE);
    console.log('3. localStorage:', localStorage.getItem('smart_billing_profile_v2'));
    console.log('4. Form values:');
    console.log('   - Nome:', document.getElementById('profile-firstname')?.value);
    console.log('   - Lingua:', document.getElementById('profile-language')?.value);
    console.log('   - Valuta:', document.getElementById('profile-currency')?.value);
    console.log('   - Paese:', document.getElementById('home-country')?.value);
}

document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>